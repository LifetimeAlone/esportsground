!function(e){function t(r){if(n[r])return n[r].exports;var a=n[r]={exports:{},id:r,loaded:!1};return e[r].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){e.exports=n(23)},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){return t.queues[e].currEv=!1,Promise.resolve(t)}function i(e,t){var n=t.queues[e].currEv;return n?(t.queues[e].errored.push(n),a(e,t)):Promise.resolve(t)}function s(e){for(var t={},n=Object.keys(e.queues),r=n.length,a=0;r>a;a++){var i=n[a],s=e.queues[i];(s.currEv||s.evs.length||s.errored.length)&&(t[i]=s)}return{queues:t,opts:e.opts}}function o(e,t,n){return n.queues[e]?(t?n.queues[e].errored=[]:n.queues[e].errored=n.queues[e].errored.concat(n.queues[e].evs),n.queues[e].evs=[],a(e,n)):Promise.resolve(n)}function l(e,t){var n=g(e,t.get()).errored;return n.length>0?n[n.length-1]:!1}function u(e,t,n,r){var s=r.get().queues[e];if(s&&!s.currEv&&s.evs.length>0&&!s.pause){var o=u.bind(null,e,t,n,r),c=s.evs.shift();s.currEv=c,t(e,c).then(function(){r.get().opts.waitCommit||r.set(a.bind(null,e))}).then(o)["catch"](function(t){return r.set(i.bind(null,e)).then(function(){n(e,l(e,r),t)}).then(o)})}}function c(e,t,n){var r=n.queues[e];return r.errored.filter(function(e){return e.mess.messageId===t}).forEach(function(e){e.failed=!1,r.evs.push(e)}),r.errored=r.errored.filter(function(e){return e.mess.messageId!==t}),Promise.resolve(n)}function d(){return{evs:[],pause:!1,errored:[],currEv:!1}}function g(e,t){return t.queues[e]||(t.queues[e]=d()),t.queues[e]}function m(e,t,n){var r=g(e,n);return r.pause=t,Promise.resolve(n)}function f(e,t,n){t.ts=Date.now();var r=g(e,n);return r.evs.push(t),Promise.resolve(n)}function _(e){var t=Object.keys(e.get().queues);t.forEach(function(t){e.set(i.bind(null,t)),e.set(o.bind(null,t,!1))})}function p(e,t,n){var r=(0,v["default"])({queues:{},debug:n&&n.debug,opts:extend({},n)},n);return n&&n.store?(r.setState(s(r.get())),_(r)):_(r),{pushMessage:function(n,a){return r.set(f.bind(null,n,a)).then(function(r){u(n,e,t,r)})},resend:function(n,a){return r.set(c.bind(null,n,a)).then(function(i){var s=r.get().queues[n].evs.filter(function(e){return e.mess.messageId===a})[0];return u(n,e,t,r),s})},reset:function(n){return r.set(o.bind(null,n,!0)).then(function(r){u(n,e,t,r)})},setErrored:function(e,t){return r.set(function(n){var r=g(e,n);return r.errored=t,Promise.resolve(n)})},pause:function(e){r.set(m.bind(null,e,!0))},isPaused:function(e){return!!g(e,r.get()).pause},complete:function(n,i){var s=r.get();s.queues[n].currEv&&s.queues[n].currEv.rid===i&&r.set(a.bind(null,n)).then(function(){u(n,e,t,r)})},resume:function(n){r.set(m.bind(null,n,!1)).then((0,b.pause)(.1)).then(function(){u(n,e,t,r)})},inspectQueue:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1;if(!r.get().queues[e])return[];var n=r.get().queues[e],a=t&&n.currEv?[n.currEv]:[];return a.concat(n.evs.slice()).concat(n.errored.slice().map(function(e){return extend({},e,{failed:!0})})).sort(function(e,t){return e.ts-t.ts})}}}Object.defineProperty(t,"__esModule",{value:!0}),t.initQueue=p;var h=n(89),v=r(h),b=n(17)},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t,n,r,a,i){(0,k.toggleConversation)(!1),removeClass(t,"im-create_shown"),removeClass(t,"im-create_photo-attached"),setTimeout(s.bind(null,t,!1),100);var o=g(i);o.map(function(e){return geByClass1("_im_dialog"+e)}).forEach(function(e){removeClass(e,"olist_item_wrap_on")}),n().createCanceled(e,r),a.resetSelection(),"add_member"===e.get().creationType&&e.set(k.setCreationType.bind(null,"chat",[])),e.set(k.presetAvatar.bind(null,!1));var u=geByClass1(V,t);l(e,i,t),uiSearch.reset(geByClass1(H,t)),uiSearch.reset(geByClass1(j,t)),u&&u.parentNode.removeChild(u),l(e,i,t),cancelStackFilter("im_search");var c=0===e.get().peer?"search":"default";e.get().longpoll.push([(0,x.transitionEvent)(c)]),attr(t,"aria-hidden","true")}function i(e,t,n){return t&&(n.current_create_peer_ids={},n.current_create_peers=[]),n.current_create_peer_ids||(n.current_create_peer_ids={}),n.current_create_peers||(n.current_create_peers=[]),e.forEach(function(e){e.then(function(e){e=e.filter(function(e){return!n.current_create_peer_ids[e.peerId]}),n.current_create_peer_ids=e.reduce(function(e,t){return e[t.peerId]=!0,e},n.current_create_peer_ids),n.current_create_peers=n.current_create_peers.concat(e)})}),Promise.resolve(n)}function s(e,t){toggleClass(e,"im-create_material",t)}function o(e,t,n,r,i,s){a(e,t,n,!1,i,s),e.get().longpoll.push([(0,x.changePeer)(r)])}function l(e,t,n){var r=geByClass1(q,n),a=t.get().selection.length,i="add_member"===e.get().creationType,s=a>0,o=a>1;i?val(r,1===a?getLang("mail_append_chat"):getLang("mail_im_create_chat_with")):(val(r,o?getLang("mail_im_create_chat"):getLang("mail_im_go_to_dialog")),toggleClass(n,"im-create_chat-details",o)),toggleClass(n,"im-create_tools",s),toggleClass(r,"button_disabled",!s)}function u(e,t,n,r,a,i,s){if(s){var o=intval(domData(s,"list-id")),u=g(i),c=trim(s.textContent),d=geByClass1(j,t),m=getSize(d)[1],f=void 0;inArray(o,u)?(f=r.removeSelection(o,c),removeClass(s,"olist_item_wrap_on")):(f=r.addSelection(o,c),addClass(s,"olist_item_wrap_on")),f.then(function(){var e=m-getSize(d)[1],t=a.scrollTop();a.scrollTop(t-e)}),l(e,i,t);var _=geByClass1(j,t);uiSearch.reset(_)}}function c(e,t){var n=g(e),r=["_im_dialog","_im_dialog"+t.peerId,"im-creation--item"],a=[];return t.online&&a.push("online"),mobPlatforms[t.online]&&a.push("mobile"),inArray(t.peerId,n)&&r.push("olist_item_wrap_on"),getTemplate("im_owner_item",{owner_id:t.peerId,cls:" "+r.join(" "),photo:t.photo,name:t.name,link:t.href,img_cls:a.join(" ")})}function d(e){return(0,I.getSearchText)(e)||!1}function g(e){return e.get().selection.map(function(e){return e.id})}function m(e,t,n,r){toggleClass(e,"im-create_chat","chat"===r.get().creationType),toggleClass(e,"im-create_invite","add_member"===r.get().creationType);var a="chat"===r.get().creationType?getLang("mail_im_group_dialog"):getLang("mail_im_friends_tab"),i=geByClass1("_im_create_title",e);val(i,a),val(geByClass1(q,e),"add_member"===r.get().creationType?getLang("mail_im_create_chat_with"):getLang("mail_im_create_chat"));var s=n.get().selection.map(function(e){return e.id});_(e,r,t,!1,s),(0,M.fixTableCellChildHeight)("_im_create_wrap_safe",e)}function f(e,t,n){return e.then(function(e){return e.filter(function(e){return e.is_friend&&!inArray(e.peerId,n.get().creationFilter)})})}function _(e,t,n,r,a){var s=geByClass1(j,e),o=void 0,l=void 0,u=(0,k.searchLocalHints)(r,t.get()),c=n.hoverFirstElement.bind(n,W,w(t));t.get().creation_shown_all=!1,n.reset(),n.pipe(f(u,r,t),r),n.toTop(),r?(l=(0,k.searchFriends)(r,t.get()),o=(0,k.searchHintsIndex)(r,[],"friends",t.get()),n.pipe(f(o,r,t),r).then(c),n.pipe(f(l,r,t),r).then(c)):(o=Promise.resolve([]),l=Promise.resolve([])),t.set(i.bind(null,[u,l,o],!0)),uiSearch.showProgress(s),Promise.all([u,o,l]).then(function(){return uiSearch.hideProgress(s)})}function p(e,t,n,r,a,i,s,o){uiTabs.switchTab(o.firstElementChild);var l=domData(o,"type");switch(l){case"chat":i.restore()}e.set(k.setCreationType.bind(null,l,[])).then(m.bind(null,t,r,a))}function h(e,t,n,r){var a=r.get(),i=d(a),s=a.selection.map(function(e){return e.id});n.unhoverElements(W),e.get().creationQuery=i,_(t,e,n,i,s)}function v(e,t,n,r){var a=2e9+Math.round(rand(1e6,2e6));cur.recieveCropResult=function(n){cur.recieveCropResult=!1,curBox()&&curBox().hide(),e.set(k.presetAvatar.bind(null,n)),(0,k.getOwnerPhoto)(n,a).then(function(e){geByClass1(U,t).appendChild(ce("img",{className:"im-chat-placeholder--img "+V,src:e}))}),addClass(t,"im-create_photo-attached")},Page.ownerPhoto(a)}function b(e,t){geByClass1(U,t).innerHTML="",e.set(k.presetAvatar.bind(null,!1)),removeClass(t,"im-create_photo-attached")}function y(e,t,n,r,i,s){g(t).map(function(e){return geByClass1("_im_dialog"+e)}).forEach(function(e){return removeClass(e,"olist_item_wrap_on")}),t.reset(),_(n,e,r,!1,g(t)),i.resetSelection(),a(e,n,s,!1,i,t)}function C(e,t,n,r,i,s,l){function u(a){y(e,t,n,r,i,s),o(e,n,s,a,i,t),unlockButton(m),(0,I.isSearching)(e)?s().cancelSearch(e):s().restoreDialogs(e)}var c=g(t),d=e.get(),m=geByClass1(q,n),f=uiSearch.getFieldEl(geByClass1(H,n)).value;return c.length<0?void 0:"add_member"===e.get().creationType?(e.set(k.addNewMember.bind(null,d.peer,c))["catch"](function(e){return showFastBox(getLang("global_error"),e.message)}),a(e,n,s,"",i,t)):(lockButton(m),1===c.length?u(c[0]):void e.set(k.createChat.bind(null,d.next_chat_avatar,c,f)).then(function(){return u(d.next_peer)})["catch"](function(e){unlockButton(m),topMsg(getLang("global_unknown_error"),2,"#FFB4A3")}))}function E(e,t){return showTooltip(e,{text:getLang("mail_cancel"),black:1,zIndex:1e3,shift:[3,-2],appendCls:"js-im-page"})}function w(e,t){var n=70,r=t&&t.get().selection.length;return{top:-1,bottom:(0,M.isClassicInterface)(e)?r>0?n-1:0:-1}}function S(e,t,n,r,i,o,l,c){return{show:function(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.setState({shown:!0}),s(e,!0),cancelStackPush("im_create",l),addClass(e,"im-create_shown"),a&&a.forEach(function(e){return i.addSelection(e[0],e[1])}),m(e,n,r,t),setTimeout(function(){t.get().longpoll.push([(0,x.transitionEvent)("create")]),attr(e,"aria-hidden","false"),i.focus()},1)},focusSearch:function(e){i.focus()},confirmCreate:function(e){c()},hide:function(n){n.get().shown=!1,a(n,e,t,!1,i,r)},scroll:function(e){n.scrollPage(e,!0)},updateScroll:function(){(0,M.fixTableCellChildHeight)("_im_create_wrap_safe",e),n.updateScroll()},selectElement:function(a){u(a,e,t,i,n,r,n.getHoveredElement())},hoverPrevElement:function(e){n.hoverPrevElement(W,null,w(e,r))},hoverNextElement:function(e){n.hoverNextElement(W,null,w(e,r))},unmount:function(){(0,A.destroyModule)(o),n.unmount(),i.unmount(),cancelStackFilter("im_create"),cur.recieveCropResult=void 0}}}function T(e,t,n){var r=(0,O["default"])({selection:[]}),s=geByClass1(B,e),o=(0,P.mount)(s,(0,O["default"])({offset:0,limit:K,elements:[],elCls:F}),function(){return{idFn:function(e){return intval(e.peerId)},hoverableFn:function(e){return hasClass(e,"_im_dialog")},renderFn:c.bind(null,r),more:function(e,n){var a=void 0;return t.get().shown?(t.get().creation_shown_all||d(r)!==!1?a=Promise.resolve([]):(t.get().creation_shown_all=!0,a=(0,k.searchFriends)(d(r),t.get())),t.set(i.bind(null,[a],!1)),f(a,d(r),t)):Promise.resolve(!1)},onClick:function(a,i){checkEvent(a)||(u(t,e,n,m,o,r,i),cancelEvent(a))}}});t.get().creationQuery=!1,t.get().creationType="chat";var g=geByClass1(j,e),m=(0,L.mount)(g,r,function(){return{selectionDeleted:function(n,r){l(t,n,e),removeClass(geByClass1("_im_dialog"+r),"olist_item_wrap_on")},onChange:h.bind(null,t,e,o)}}),_=a.bind(null,t,e,n,"cross",m,r),w=p.bind(null,t,e,n,o,r,m),T=v.bind(null,t,e),I=b.bind(null,t,e),M=y.bind(null,t,r,e,o,m,n),D=C.bind(null,t,r,e,o,m,n),x=geByClass1(R,e),H=(0,A.createModule)({handlers:function(t,n){t(x,"click",_),t(x,"mouseover",E.bind(null,x)),t(geByClass1(U,e),"click",T),t(geByClass1(G,e),"click",I),t(geByClass1(z,e),"click",M),t(geByClass1(q,e),"click",D),t(e,"mouseover",throttle(o.unhoverElements.bind(o,W),100)),n(e,"click",N,w)}});return S(e,n,o,r,m,H,_,D)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=T;var k=n(107),I=n(86),P=n(101),M=n(41),L=n(39),A=n(100),D=n(89),O=r(D),x=n(74),R="_im_create_cancel",B="_im_create_list",F="_im_dialog",N="_im_create_tab",H="_im_dialogs_creation_name",j="_im_create_select",U="_im_create_avatar",G="_im_create_remove_avatar",q="_im_confirm_creation",z="_im_cancel_creation",V="_im_avatar_img",W=["im-creation--item_hovered"],K=100},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){return bodyNode[e]||document.documentElement[e]}function i(e,t,n){"scrollTop"===e&&window.scrollTo(0,t)}function s(e,t){return t.noScroll?new c(e):t.nativeScroll?new l(e,t):new u(e,t)}Object.defineProperty(t,"__esModule",{value:!0}),t.getNativeOption=a,t.setNativeOption=i,t.createScroll=s;var o=n(100),l=function(){function e(t,n){var a=this;r(this,e),this.el=t,this.opts=n,this.module=(0,o.createModule)({handlers:function(e,t){e(window,"scroll",a.onScroll.bind(a)),e(window,"resize",a.resize.bind(a))}}),this.innerHeight=window.innerHeight,this.prevScroll=this.scrollTop()}return e.prototype.update=function(){},e.prototype.resize=function(){this.innerHeight=window.innerHeight},e.prototype.scrollTop=function(e){return"undefined"==typeof e?a("scrollTop",this.el):void i("scrollTop",e,this.el)},e.prototype.contHeight=function(){return a("scrollHeight")},e.prototype.smoothScroll=function(e){scrollToY(e+this.scrollTop(),300)},e.prototype.getContainer=function(){return this.el},e.prototype.scrollBottom=function(e){if("undefined"==typeof e)return this.contHeight()-this.scrollTop()-this.getScrollHeight();var t=this.contHeight()-e-this.getScrollHeight();this.scrollTop(t)},e.prototype.onScroll=function(e){var t=this.scrollTop(),n=t-this.prevScroll,r=this.contHeight();this.opts.onScroll&&this.opts.onScroll(-n,this),this.opts.scrollChange&&this.opts.scrollChange(t),this.opts.more&&r-t<2*this.innerHeight&&this.opts.more(this),this.prevScroll=t},e.prototype.getScrollHeight=function(){return this.innerHeight},e.prototype.destroy=function(){(0,o.destroyModule)(this.module)},e}(),u=function(){function e(t,n){var a=this;r(this,e),this.prevTop=0,this.scroll=new uiScroll(t,{hidden:!0,shadows:n.shadows,stopScrollPropagation:!1,theme:n.scrollTheme,onmore:function(){return n.more&&n.more(a)},onscroll:function(e){var t=a.scrollTop(),r=a.prevTop-t;a.prevTop=t,n.scrollChange&&n.scrollChange(t),n.onScroll&&n.onScroll(r,a)}})}return e.prototype.update=function(){this.scroll.update("sync")},e.prototype.scrollTop=function(e){return"undefined"!=typeof e?this.scroll.scrollTop(e):this.scroll.data.scrollTop},e.prototype.getContainer=function(){return this.scroll.content},e.prototype.contHeight=function(){return this.scroll.data.scrollHeight},e.prototype.smoothScroll=function(e){this.scroll.scrollTop(this.scrollTop()+e,300)},e.prototype.scrollBottom=function(e){return"undefined"!=typeof e?this.scroll.scrollBottom(e):this.scroll.data.scrollBottom},e.prototype.getScrollHeight=function(){return this.scroll.data.viewportHeight},e.prototype.destroy=function(){this.scroll.destroy()},e}(),c=function(){function e(t,n){r(this,e),this.el=t}return e.prototype.update=function(){},e.prototype.getContainer=function(){return this.el},e.prototype.scrollTop=function(e){return 0},e.prototype.contHeight=function(){return 0},e.prototype.smoothScroll=function(e){},e.prototype.scrollBottom=function(e){return 0},e.prototype.getScrollHeight=function(){return 0},e.prototype.destroy=function(){},e}()},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){domData(e,"ts")!==t.date&&(e.innerHTML=t.text,domData(e,"ts",t.date),setStyle(e,{visibility:"visible"}))}function s(e,t,n,r){var a=e instanceof Array?e:geByClass("_im_bar_date",e),i=t.contHeight();y["default"].onNewMessagesChunk();var s=a.reduce(function(e,t){return e[domData(t,"date")]=[t.offsetTop+L,i,t],e},{}),o=!n&&r.barMap?r.barMap:{};return r.barMap=extend(o,s),r.barMapKeys=Object.keys(r.barMap).sort(),Promise.resolve(r)}function o(e,t){return t.barMapKeys.forEach(function(n){t.barMap[n][0]-=e}),Promise.resolve(t)}function l(e,t,n,r,a){var i=e.get().barMap[t],s=(0,h.isClassicInterface)(a)?M:P;return n-(i[0]+n-i[1])+r-s}function u(e,t){var n=e.get().barMap[t][2];return{text:n.textContent,date:domData(n,"date")}}function c(e,t,n,r){return r.barTransition=r.barMap[t][2],n>0?(addClass(r.barMap[t][2],"im-page--date-bar-transition-inverse"),addClass(e,"im-page--date-bar-transition-inverse")):0>n&&(removeClass(r.barMap[t][2],"im-page--date-bar-transition-inverse"),removeClass(e,"im-page--date-bar-transition-inverse")),addClass(r.barMap[t][2],"im-page--date-bar-transition"),addClass(e,"im-page--date-bar-transition"),Promise.resolve(r)}function d(e,t){return t.barTransition&&(removeClass(t.barTransition,"im-page--date-bar-transition"),t.barTransition=null),removeClass(e,"im-page--date-bar-transition"),Promise.resolve(t)}function g(e,t,n,r,a){var i=e.get(),s=void 0,o=void 0,c=n-t;i.barMapKeys.forEach(function(t){var i=l(e,t,n,r,a);if(i>=c){var u=s?l(e,s,n,r,a):n;s=u>i?t:s}else if(c>i){var d=o?l(e,o,n,r,a):0;o=i>d?t:o}});var d={};return[[o,"prev"],[s,"cur"]].forEach(function(t){var i=p(t,2),s=i[0],o=i[1];s&&(d[o+"Bar"]=u(e,s),d[o+"Left"]=l(e,s,n,r,a)-c)}),d}function m(e){var t=geByClass1("_im_mess",e),n=domData(t,"ts");return t&&n?{text:getShortDate(intval(n),!1,!0,getLang("months_of","raw")),date:n}:null}function f(e,t,n,r,s){var o=e.get(),l=(0,v.isEverythingLoaded)(o),u=t.get(),f=s.scrollTop(),_=u.lastTop?u.lastTop-f:0;u.lastTop=f;var p=(0,w.isPinnedMessageVisibleInTab)(o,o.peer)?T:0,b=((0,h.isClassicInterface)(e)?S+p:0)-k/2,y=s.contHeight(),C=g(t,f,y,b,e),E=C.prevBar,I=C.curBar,P=C.prevLeft,M=(C.curLeft,"translateY(0px)"),L=!1,A=!1,D=!1;I||l||(I=m(r)),I?L=I:A=!0,E&&I&&P>-k&&0>P&&(D=!0,A=!1,L=I,M="translateY("+(-k-P)+"px)"),L&&i(n,L),D?t.set(c.bind(null,n,E.date,_)):t.set(d.bind(null,n)),M&&setStyle(n,a({},cssTransformProp,M)),toggleClass(n,"im-page--top-date-bar_no-b",A)}function _(e,t){var n=geByClass1("_im_top_date_bar"),r=(0,E["default"])({lastTop:!1,barMap:{},barMapKeys:[]}),a=null,i=null,l=null,u=debounce(function(e){r.set(s.bind(null,t,e,!1))},500);return{reset:function(a){r.set(s.bind(null,t,a,!0)).then(function(){f(e,r,n,t,a)})},disable:function(){r.reset()},heightIncreased:function(e,t){return u(t),r.set(o.bind(null,e))},parseMore:function(a,i){r.set(s.bind(null,a,i,!1)).then(function(){f(e,r,n,t,i)})},toggle:function(e){e?setStyle(n,{display:""}):hide(n)},show:function(){i=Date.now(),l||(addClass(geByClass1("_im_page_history"),"im-page--top-date-bar_visible"),l=setInterval(function(){Date.now()-i>A&&(removeClass(geByClass1("_im_page_history"),"im-page--top-date-bar_visible"),clearInterval(l),l=null)},D))},update:function(i){a&&(clearTimeout(a),a=null),a=setTimeout(function(){f(e,r,n,t,i)},I),f(e,r,n,t,i)}}}Object.defineProperty(t,"__esModule",{value:!0});var p=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.setCurrentDateBar=i,t.mount=_;var h=n(41),v=n(107),b=n(8),y=r(b),C=n(89),E=r(C),w=n(119),S=68,T=52,k=32,I=300,P=20,M=68,L=10,A=2e3,D=100},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,n){e.exports=!n(124)&&!n(112)(function(){return 7!=Object.defineProperty(n(115)("div"),"a",{get:function(){return 7}}).a})},function(e,t){"use strict";function n(){try{if(window.crypto){var e=new Int32Array(1);return crypto.getRandomValues(e),Math.abs(e.reduce(function(e,t){return e+t}))}}catch(t){}return intval(rand(0,r).toFixed(0))}Object.defineProperty(t,"__esModule",{value:!0}),t.random=n;var r=(t.MAX_SAFE_INTEGER=9007199254740991,t.MAX_INTERGER=2147483647)},function(e,t){"use strict";function n(e){var t=geByClass("post");LongView.clearElemsCache&&LongView.clearElemsCache(),t.forEach(function(e){return LongView.register(e,"im")})}function r(e){LongView.onScroll(e,window.innerHeight)}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]={onNewMessagesChunk:n,onHistoryScroll:r}},function(e,t,n){var r=n(69),a=n(127);e.exports=n(124)?function(e,t,n){return r.f(e,t,a(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var r=n(32);e.exports=function(e,t,n){if(r(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,a){return e.call(t,n,r,a)}}return function(){return e.apply(t,arguments)}}},function(e,t){"use strict";function n(e,t){var n,r,a=function(a){n="undefined"!=typeof a.clientX?a.clientX:a.touches[0].clientX,r="undefined"!=typeof a.clientY?a.clientY:a.touches[0].clientY,t.onDrag&&t.onDrag.call(e,n,r)},i=function o(i){t.onDrop&&t.onDrop.call(e,n,r),removeEvent(document,"mouseup touchend mouseleave",o),removeEvent(document,"mousemove touchmove",a)},s=function(s){(1===s.which||s.touches&&s.touches[0])&&(addEvent(document,"mouseup touchend mouseleave",i),addEvent(document,"mousemove touchmove",a),n="undefined"!=typeof s.clientX?s.clientX:s.touches[0].clientX,r="undefined"!=typeof s.clientY?s.clientY:s.touches[0].clientY,t.onStartDrag&&t.onStartDrag.call(e,n,r),t.onDrag&&t.onDrag.call(e,n,r),cancelEvent(s))};e.beginDragHandler=s,addEvent(e,"mousedown touchstart",s)}function r(e){removeEvent(e,"mousedown touchstart",e.beginDragHandler)}Object.defineProperty(t,"__esModule",{value:!0}),t.initDraggable=n,t.removeDraggable=r},function(e,t,n){var r=n(102),a=n(95);e.exports=Object.keys||function(e){return r(e,a)}},function(e,t,n){var r=n(5),a=n(127),i=n(97),s=n(126),o=n(129),l=n(6),u=Object.getOwnPropertyDescriptor;t.f=n(124)?u:function(e,t){if(e=i(e),t=s(t,!0),l)try{return u(e,t)}catch(n){}return o(e,t)?a(!r.f.call(e,t),e[t]):void 0}},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t,n){return!e.map(function(e){var r=(0,A.getMessage)(t,n,e);return(0,D.isImportant)(r)}).reduce(function(e,t){return e&&t},!1)}function i(e,t){var n=t.get(),r=n.peer,a=n.tabs[r].pinned;return 1===e.length&&a&&e[0]===a[0]}function s(e,t){var n=e.get().peer,r=geByClass1("_im_page_peer_online",t);r&&(0,M.isUserPeer)(n)&&(0,M.applyInnerHtml)(r,(0,M.getLastSeenTextInHeader)(e,n))}function o(e,t,n){geByClass("_im_header_icon",e).forEach(function(e){if(n.length>0)hide(e);else if("star"===domData(e,"type")&&(0,M.isFoldersAvailable)(t)&&(toggleClass(e,"im-page--header-icon_star-active",(0,M.isImportant)(t)),setStyle(e,{display:"inline-block"})),"answer"===domData(e,"type")&&(0,M.isFoldersAvailable)(t)&&(toggleClass(e,"im-page--header-icon_answer-shown",(0,M.isUnrespond)(t)),(0,M.isUnrespond)(t)?setStyle(e,{display:"inline-block"}):hide(e)),"search"===domData(e,"type")&&!(0,M.isCommunityInterface)(t)){var r=(0,M.isFullyLoadedTab)(t,t.get().peer)&&t.get().tabs[t.get().peer].offset;setStyle(e,{display:"inline-block"}),toggleClass(e,"im-page-header-icon_search-shown",r)}})}function l(e,t,n){var r=getLang("mail_selected_shorted",t.length);g({actions:!0},"im-page--chat-header"),val(geByClass1("im-page--selected-messages"),getTemplate("im_selected_messages",{label:r.replace("{count}",t.length),tip:getLang("mail_deselect_all")}));var s=geByClass1(H,e),o=a(t,n,n.get().peer),l=i(t,n);toggleClass(s,"im-page--mess-actions_important",!o),toggleClass(s,"im-page--mess-actions_pinned",l),toggleClass(s,"im-page--mess-actions_multiple-selection",t.length>1);var u=o?getLang("mail_im_toggle_important"):getLang("mail_im_toggle_important_off"),c=l?getLang("mail_unpin"):getLang("mail_pin");attr(geByClass1("im-page-action_star",e),"aria-label",u),attr(geByClass1("im-page-action_pin",e),"aria-label",c)}function u(e,t,n){var a=t.get(),i=a.peer,s=a.tabs[i],l=clean(stripHTML(unclean(s.tab))),m=geByClass1(G,e),f=geByClass1(q);m.tt=!1;var _=(0,M.renderPhotosFromTab)(t,s,!0),p=getTemplate("im_simple_link",{href:s.href,content:getTemplate("im_peer_photo",{online_class:"",owner_photo:_,modifier_class:"nim-peer_smaller"})});val(geByClass1("im-page--aside-photo",e),p);var h=(0,M.isChatPeer)(i),v=h?!s.data.closed&&!s.data.kicked:0,b={muted:inArray(i,a.mutedPeers),verified:!!s.verified,chat:h,actions:!1,derelict:h&&!v,pinned:!1};if(h){var y=(0,A.getPinnedMessage)(t),C=c(t);y&&(0,x.isPinnedMessageVisibleInTab)(t,i)&&(C?t.set(P.loadChatMember.bind(null,r({},i,[C]))).then(u.bind(null,e,t,n)):b.pinned=!0)}var E="";h?E=v?getTemplate("im_chat_members",{name:getLang("mail_im_n_chat_members",(0,M.getAliveMembersCount)(s))}):"":(0,M.isUserPeer)(i)&&(E=(0,M.getLastSeenTextInHeader)(t,i));var w=getTemplate("im_simple_name",{name:s.tab,href:s.href,name_attr:l,ads_union:s.ad_union_ids_attr,online:E,more_cls:""===E?"im-page--title--1line":""});val(geByClass1("im-page--title-wrapper",e),w);var S=(0,M.renderPinnedMessage)(t),T=val(f);val(f,S);var k=geByClass1(B,e);if(removeClass(k,M.DESELECT_ALL_CLASS),show(geByClass1(N,e)),removeClass(geByClass1(H,e),"im-page--mess-actions_visible"),removeClass(geByClass1(H,e),"im-page--mess-actions_all-sel"),o(e,t,[]),(0,M.isClassicInterface)(t)){var I=geByClass1("_im_page_back",e);attr(I,"href",(0,M.getBaseLink)(t)+"?tab="+a.active_tab)}g(b,"im-page--chat-header"),d(t,S,T,n)}function c(e){var t=(0,A.getPinnedMessage)(e);return!t||(0,O.oCacheGet)(e,t.userId)?!1:t.userId}function d(e,t,n,r){var a=t&&!n?1:!t&&n?-1:0;a&&!(0,M.isClassicInterface)(e)&&r().compensateHistoryHeightChange(a)}function g(e,t){var n=geByClass1(t);Object.keys(e).forEach(function(r){toggleClass(n,t+"_"+r,!!e[r])})}function m(e,t,n,r,s){var o=e.get().selectedMessages,l=domData(s,"action"),u=e.get().peer;switch(l){case"delete":case"spam":e.set(P.removeMessagesWithRestore.bind(null,o,u,l)).then(t().removeMessagesRestore.bind(null,o,u,l));var c=e.get().tabs[u];(0,P.removeMessageSend)(o,u,c.hash,l,e.get().gid);break;case"forward":Promise.all((0,P.processFwd)(o,e.get().peer,e)).then(function(t){return e.set(P.prepareForward.bind(null,t))}).then(function(){(0,M.isClassicInterface)(e)?(cancelStackPush("forward",function(t){e.set(P.prepareForward.bind(null,[])).then(function(){e.get().longpoll.push([(0,L.changePeer)(t)])})}.bind(null,e.get().peer)),e.get().longpoll.push([(0,L.resetPeer)(!0)])):t().startForward(e)});break;case"star":var d=(e.get().tabs[u],a(o,e,u));e.set(P.favMessage.bind(null,o,d,u)),e.get().longpoll.push(o.map(function(e){return{type:d?L.SET_FLAGS:L.RESET_FLAGS,messageId:e,peerId:u,flags:L.FLAG_IMPORTANT}}));break;case"respond":Promise.all((0,P.processFwd)(o,e.get().peer,e)).then(function(t){return e.set(P.forwardMessages.bind(null,t,u,cur.imDb))}).then(function(){t().respond(e,u)});break;case"pin":var g=(0,A.getLocalId)(e,o[0]),m=i(o,e),f=m?P.unpinMessageOptimistic.bind(null,u):P.pinMessageOptimistic.bind(null,g,u),_=m?P.unpinMessage.bind(null,u):P.pinMessage.bind(null,g,u),p=w.bind(null,t,u);e.set(P.checkChatMember.bind(null,e,g,u)).then(function(e){return e.set(f)}).then(p).then(function(e){return e.set(_)}).then(p)}v(e,t,n)}function f(e,t,n,r,a,i){if("keydown"!==i.type||13===i.which){var s=trim(val(a));return s?(s!==n&&e.set(P.updateChatTopic.bind(null,t,s)).then(r().updateChatTopic.bind(null,t)),!0):(notaBene(a),!1)}}function _(e,t,n){var r=showFastBox({title:getLang("mail_chat_invite_link"),dark:1},getLang("mail_chat_reset_link_warning"),getLang("mail_chat_reset_link_confirm"),function(a){var i=gpeByClass("_im_invite_box",n.target),s=geByClass1(K,i),o=geByClass1("_im_invite_new",i);lockButton(r.btns.ok[0]),(0,P.resetInviteLink)(t-2e9,e.get()).then(function(e){var t=k(e,1),n=t[0];unlockButton(r.btns.ok[0]),s.value=n,unlockButton(o),addClass(i,"im-invite-box_reseted"),elfocus(s,0,n.length),r.hide()})},getLang("global_cancel"),function(){r.hide()})}function p(e,t,n){if((0,M.isChatPeer)(t)){var r=e.get().tabs[t].name,a=f.bind(null,e,t,r,n),i=showFastBox({title:getLang("mail_chat_topic_change_title"),dark:1},getTemplate("im_chat_change_topic",{value:r}),getLang("global_save"),function(e,t){var n=a(s,t);n&&i.hide()},getLang("global_cancel"),function(){i.hide()}),s=geByClass1(U,i.bodyNode);elfocus(s),addEvent(s,"keydown",function(e){var t=a(s,e);t&&i.hide()})}}function h(e,t,n,r,a,i){var s=domData(i,"action"),o=geByClass1(F,r).parentNode,l=e.get().peer;switch(s){case"clear":var u=(0,M.showFlushDialog)(l,function(){(0,M.cleanHistory)(e,u,t,P.flushHistory,e.get().peer)});break;case"photos":case"media":showWiki({w:"history"+(0,M.convertPeerToUrl)(l)+"_photo"},null,{});break;case"topic":p(e,l,t);break;case"avatar":cur.recieveCropResult=void 0,Page.ownerPhoto(l);break;case"search":t().showSearch(e);break;case"block_community":e.set(P.toggleCommunityMessages.bind(null,!1,l)).then(function(){e.get().longpoll.push([(0,L.resetPeer)()]),showDoneBox(getLang("mail_community_was_blocked"))});break;case"allow_community":e.set(P.toggleCommunityMessages.bind(null,!0,l)).then(function(){n().changeActions(e)});break;case"block":var c=(0,M.showBlacklistBox)(l,e);c.once("success",function(t){t.delta&&(showDoneBox(t.msg),e.get().longpoll.push([(0,L.resetPeer)()]))});break;case"leave":var d=showFastBox({title:getLang("mail_chat_leave_title"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},getLang("mail_chat_leave_confirm"),getLang("mail_leave_chat"),function(){e.set(P.leaveChat.bind(null,l)),e.set(P.unpinMessageOptimistic.bind(null,l)),d.hide(),e.get().longpoll.push([(0,L.resetPeer)()])},getLang("global_cancel"),function(){d.hide()});break;case"invite_link":var g=_.bind(null,e,l),m=!1,f=!1,h=!1,v=function(){elfocus(m,0,m.value.length),document.execCommand("copy"),setStyle(f,{opacity:1}),h&&(h=clearTimeout(h)),h=setTimeout(function(){return setStyle(f,{opacity:0})},2e3)},b=!1,y=!1;showBox("al_im.php",{act:"a_get_invite_link",chat_id:l-2e9},{onDone:function(e){m=geByClass1(K,e.bodyNode),b=geByClass1("_im_reset_link",e.bodyNode),y=geByClass1("_im_invite_copy",e.bodyNode),f=geByClass1("_im_invite_copied",e.bodyNode),elfocus(m,0,m.value.length),addEvent(b,"click",g),addEvent(y,"click",v)},params:{hideButtons:!0,onHide:function(){removeEvent(b,"click",g),removeEvent(y,"click",v)},onShow:function(){addEvent(b,"click",g),addEvent(y,"click",v)}}},{});break;case"return":e.set(P.returnToChat.bind(null,l)).then(function(e){return e.set(P.getPinnedMessage.bind(null,l))}).then(t().updateChatTopic.bind(null,l));break;case"unmute":case"mute":var C="mute"===s?1:0;e.set(P.toggleMutePeer.bind(null,l,C)).then(t().updateState.bind(null,l));break;case"chat":case"invite":if((0,M.isChatPeer)(l))(0,M.inviteUser)(e,l,t,P.setCreationType);else if((0,M.isUserPeer)(l)){var E=e.get().tabs[l],w=[[l,E.tab]];e.set(P.setCreationType.bind(null,"chat",[])).then(function(){return t().showCreation(e,w)})}break;case"pin_hide":(0,x.pinnedMessageHide)(e,(0,A.getPeer)(e),t);break;case"pin_unhide":(0,x.pinnedMessageUnHide)(e,(0,A.getPeer)(e),t);break;case"unpin":(0,x.pinnedMessageUnpin)(e,(0,A.getPeer)(e),t)}uiActionsMenu.toggle(o,!1)}function v(e,t,n){var r=e.get().selectedMessages;e.set(P.cleanSelected).then(n().changedMessageSelection).then(t().cleanSelection.bind(null,r))}function b(e,t,n,r){var a=(0,M.isClassicInterface)(e),i=void 0,s=void 0;switch(domData(r,"type")){case"star":s=[4,6],i=function(){return(0,M.isImportant)(e)?getLang("mail_im_toggle_important_off"):getLang("mail_im_toggle_important")};break;case"answer":s=[4,6],i=getLang("mail_end_conversation");break;case"search":s=a?[5,6]:[4,-9],i=getLang("mail_search_in_peer")}showTooltip(r,{text:i||"",black:1,shift:s,forcetoup:!0,appendParentCls:a?"_im_dialog_actions":"_im_mess_actions"})}function y(e,t,n){var r=(0,M.isClassicInterface)(e),a=domData(n.target,"action");"respond"!==a&&"forward"!==a&&showTooltip(n.target,{text:C.bind(null,e,a)||"",black:1,shift:[2,r?-4:11],forcetodown:!0,appendParentCls:"_im_dialog_actions"})}function C(e,t){var n=e.get(),r=n.selectedMessages,s=n.peer;switch(t){case"pin":return i(r,e)?getLang("mail_unpin"):getLang("mail_pin");case"star":return a(r,e,s)?getLang("mail_im_toggle_important"):getLang("mail_im_toggle_important_off");case"delete":return getLang("mail_delete");case"spam":return getLang("mail_im_mark_spam")}}function E(e,t,n,r,a){var i=domData(a,"type");switch(i){case"star":e.set(P.toggleDialogImportant.bind(null,e.get().peer)).then(function(){
setTimeout(function(){return b(e,t,r,a)},40)});break;case"search":n().showSearch(e),window.tooltips&&tooltips.hide(a,{fasthide:!0});break;case"answer":var s=(0,A.getTab)(e,e.get().peer);s&&(e.set(P.markDialogAnswered.bind(null,e.get().peer,s.lastmsg)),showDoneBox(getLang("mail_marked_as_answered"),{out:1e3}),e.get().longpoll.push([(0,L.resetPeer)()]))}}function w(e,t,n){return e().updateChatTopic(t,n),n}function S(e,t,n){return{changeActions:function(t){var n=geByClass1(F,e),r=geByClass1(N,e),a=t.get().curActions,i=Object.keys(a).map(function(e,t){var n="";return 7!==P.ACTION_PRIORITIES[e]&&10!==P.ACTION_PRIORITIES[e]||0===t||(n='<div class="ui_actions_menu_sep"></div>'),n+rs(Y,{name:a[e].name,icon:a[e].icon,action:e})}).join("");0===Object.keys(a).length?addClass(r,"im-page--header-more_loading"):(val(n,i),removeClass(r,"im-page--header-more_loading"))},renderPeer:function(n){u(e,n,t)},renderActions:function(t){var n=t.get().selectedMessages||[];n.length>0&&l(e,n,t)},hideActions:function(t){if(!(0,M.isFullyLoadedTab)(t,t.get().peer)){var n=geByClass1(N,e);addClass(n,"im-page--header-more_loading")}},changedMessageSelection:function(n){if(0!==n.get().peer){var r=n.get().selectedMessages||[];r.length>0?l(e,r,n):u(e,n,t)}},updateLastSeen:function(t){s(t,e)},unmount:function(){(0,I.destroyModule)(n),cancelStackFilter("fowrward")}}}function T(e,t,n){var r=(0,I.createMutations)(S),a=r.callMutations,i=r.bindMutations,s=m.bind(null,t,n,a),o=h.bind(null,t,n,a,e),l=v.bind(null,t,n,a),u=function(e,n){return(0,M.showVerifiedTooltip)(n,t.get().peer)},c=b.bind(null,t,e),d=y.bind(null,t,e),g=E.bind(null,t,e,n),f=function(r){gpeByClass(z,r.target,e)&&!checkEvent(r)&&((0,M.showChatMembers)(t,n,P.setCreationType),cancelEvent(r))},_=(0,I.createModule)({handlers:function(r,a){a(e,"click",j,s),a(e,"click",R,o),a(e,"click",M.DESELECT_ALL_CLASS,l),a(e,"mouseover",G,u),a(e,"mouseover","_im_header_icon",c),a(e,"mouseover",j,d),a(e,"click","_im_header_icon",g),a(e,"click","_im_header_link",f),a(e,"click",V,f),a(e,"click",W,function(e){return(0,M.showChatMembers)(t,n,P.setCreationType)}),a(e,"click","_im_page_back",function(e){checkEvent(e)||(t.get().longpoll.push([(0,L.resetPeer)()]),cancelEvent(e))})}});return(0,M.isReservedPeer)(t.get().peer)||setTimeout(function(){t.set(P.setActions).then(a().changeActions)}),i(e,n,_)}Object.defineProperty(t,"__esModule",{value:!0});var k=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=T;var I=n(100),P=n(107),M=n(41),L=n(74),A=n(86),D=n(15),O=n(90),x=n(119),R="_im_action",B="_im_page_peer_name",F="_ui_menu",N="_im_dialog_action_wrapper",H="_im_mess_actions",j="_im_page_action",U="_im_chat_topic_change_input",G="_im_chat_verified",q="_im_pinned",z="im-page--chat-header_chat",V="_im_page_peer_name",W="_im_chat_members",K="_im_chat_invite_link",Y='<a tabindex="0" role="link" class="ui_actions_menu_item '+R+' im-action im-action_%icon%" data-action="%action%">%name%</a>'},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function a(e,t){return"number"!=typeof t.messageId?!0:i(t)?t.messageId>e.out_up_to:t.messageId>e.in_up_to}function i(e){return e.flags&m.FLAG_OUTBOUND}function s(e){var t=e.attaches[0];return t&&"doc"===t.type&&"graffiti"===t.kind}function o(e){var t=e.attaches[0];return t&&"gift"===t.type}function l(e){var t=e.attaches[0];return t&&("money_transfer"===t.type||"money_request"===t.type)}function u(e){var t=e.attaches[0];return t&&"money_request"===t.type}function c(e){return e.flags&m.FLAG_IMPORTANT}function d(e){return i(e)?vk.id:e.userId}Object.defineProperty(t,"__esModule",{value:!0}),t.isUnread=a,t.isOut=i,t.isGraffiti=s,t.isGift=o,t.isMoney=l,t.isMoneyRequest=u,t.isImportant=c,t.getUserId=d;var g=n(74),m=r(g)},function(e,t){"use strict";function n(){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||window.MediaDevices&&window.MediaDevices.getUserMedia,t=function(t){return new Promise(function(n,r){e?e.call(navigator,t,n,r):r(new Error("NotSupported"))})},n=function(){return new Promise(function(e,t){if(MediaStreamTrack&&MediaStreamTrack.getSources){var n={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(t){e(t.map(function(e){return{label:e.label,kind:n[e.kind],deviceId:e.id,groupId:""}}))})}t(new Error("NotSupported"))})};e&&!navigator.mediaDevices&&(navigator.mediaDevices=navigator.mediaDevices||{}),navigator.mediaDevices&&(navigator.mediaDevices.getUserMedia||(navigator.mediaDevices.getUserMedia=t),navigator.mediaDevices.enumerateDevices||(navigator.mediaDevices.enumerateDevices=n)),window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&(window.AudioContext.prototype.createScriptProcessor=window.AudioContext.prototype.createScriptProcessor||window.AudioContext.prototype.createJavaScriptNode)}Object.defineProperty(t,"__esModule",{value:!0}),t.initFailBack=n},function(e,t){"use strict";function n(e,t){return new Promise(function(n){setTimeout(n.bind(null,t),1e3*e)})}function r(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=0;return function i(){for(var s=arguments.length,o=Array(s),l=0;s>l;l++)o[l]=arguments[l];return Promise.resolve().then(function(){return e.apply(void 0,o)})["catch"](function(e){if(a++,t>=a){var s="function"==typeof r?r(a):0;return 0===s?i.apply(void 0,o):n(s).then(function(){return i.apply(void 0,o)})}throw e})}}function a(e,t,n){var r=void 0,a=void 0;return function(){for(var i=arguments.length,s=Array(i),o=0;i>o;o++)s[o]=arguments[o];return new Promise(function(e,i){var o=function(){r=null,a=null,n||e(s)},l=n&&!r;clearTimeout(r),a&&a.reject("debounce"),r=setTimeout(o,t),l?e(s):n&&i("debounce"),a={resolve:e,reject:i}}).then(function(t){return e.apply(void 0,t)})}}function i(e,t){var n=void 0,r=new Promise(function(r){n=r,setTimeout(r.bind(null,t),1e3*e)});return{pause:function(){return r},abort:function(){n(t)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.pause=n,t.retryFn=r,t.debouncedPromise=a,t.abortablePause=i},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t,n){var r=n(94),a=n(68);e.exports=function(e){return function(t,n){var i,s,o=String(a(t)),l=r(n),u=o.length;return 0>l||l>=u?e?"":void 0:(i=o.charCodeAt(l),55296>i||i>56319||l+1===u||(s=o.charCodeAt(l+1))<56320||s>57343?e?o.charAt(l):i:e?o.slice(l,l+2):(i-55296<<10)+(s-56320)+65536)}}},function(e,t){"use strict";function n(e){var t=extend({},nav.objLoc,e);Object.keys(t).filter(function(e){return""===t[e]}).forEach(function(e){delete t[e]});var n=nav.toStr(t);nav.setLoc(n)}function r(){var e={};return{scheduleNav:function(t){e=extend(e,t)},commitNav:function(){n(e),e={}},scheduleNavWithTimeOut:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;e=extend(e,t),setTimeout(function(){n(e),e={}},r)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.updateLocation=n,t.updateLazyLocation=r},function(e,t,n){e.exports=n(19).document&&document.documentElement},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}n(49);var a=n(67),i=n(89),s=r(i),o=n(40),l=n(74),u=n(107),c=n(90),d=n(41),g=n(36),m=n(70);window.IM={init:function(e){window.imwl=e.imwl,(0,g.startLoggingAllUnhandled)(),addTemplates(m),window.Promise||(window.Promise=o.Promise),window.cur.lang.dont_attach=getLang("mail_dont_add_media"),e.tabbedPeers=(e.tabbedPeers||[]).map(function(e){return{peer:e,type:"perm"}}),cur.ctrl_submit=e.ctrl_submit,cur.module="im",cur.mutedPeers=e.mutedPeers,cur.gid=e.gid,cur.peer=e.peer,e.blockedFlagUpdates={},e.msgid=intval(nav.objLoc.msgid),cur.options={blacklist_hash:e.thash};var t=60*(new Date).getTimezoneOffset(),n=-10800,r=n-t,i=e.timeshift;e.timeshift=i-r,e.oCache={};var f=(0,s["default"])(e);e.owners.forEach(function(e){return(0,c.oCacheAdd)(f,e)}),e.owners=void 0,(0,d.normalizeTabsGotFromServer)(f,f.get().tabs),window.store=f;var _=(0,a.mount)(geByClass1("js-im-page",ge("page_body")),f);(0,u.updateMentions)(f.get()),IM.chatPhotoSaved=function(e){curBox()&&curBox().hide();var t=(e||{})[1];return t?(cur.pvShown&&layers.fullhide(!0,!0),"im"!=cur.module||f.get().peer!=t?nav.go("/im?sel=c"+(t-2e9)):void 0):nav.reload()},IM.updateHistory=function(e){f.set(u.updateHistory.bind(null,e)).then(function(){_.updateHistory(e)})},IM.activateTab=function(e){f.get().longpoll.push([(0,l.changePeer)(intval(e),!1,!1,!0)])};var p=!1;cur.nav.push(function(){if(p)return!0;f.get().audio_msg&&f.get().audio_msg.isRecording&&_.cancelRecording(),AudioMessagePlayer.detachPlayer();var t=_.route.apply(null,arguments);return t!==!1&&(_.unmount(),IM.activateTab=void 0,IM.chatPhotoSaved=void 0,IM.updateHistory=void 0,f.unmount(),window.store=void 0,p=!0,e=!1,f=!1,_=!1,(0,g.stopLoggingAllUnhandled)()),t})}};try{stManager.done("imn.js")}catch(f){}},function(e,t,n){"use strict";function r(e,t){for(var n=void 0,r=0,a=e;null!==(n=u.MESSAGE_REGEXP.exec(e));){var i=n[0].length,o=n.index+i,l=e[n.index-1],c=e[o-1],d=void 0!==l&&/([\w\$А-Яа-яёЁєЄҐґЇїІіЈј\—\-\_@;.])/i.test(l),g=void 0!==c&&/([:;$])/i.test(c);if(!d&&!g){var m=s(n),f=m.domain;if(f.length<=u.MAX_DOMAIN_LENGTH&&-1!==u.TOP_DOMAINS.indexOf(f)){var _=t(m);a=a.slice(0,n.index+r)+_+a.slice(o+r),r+=_.length-i}}}return a}function a(e,t){return e.replace(u.EMAIL,t||function(e){return'<a href="/write?email='+e+'" target="_blank">'+e+"</a>"})}function i(e,t){return e.replace(u.MENTION,t||function(e,t,n,r,a){return'<a href="/'+(t+n)+'" class="mem_link" mention="'+clean(r||"")+'" mention_id="'+clean(t+n)+'" onclick="return mentionClick(this, event)" onmouseover="mentionOver(this)">'+a+"</a>"})}function s(e){return{full:e[0],protocol:e[1]||"http://",url:e[2],domain:e[4],query:e[6]||""}}function o(e){statlogsValueEvent("ttl_message_confirm_delivery",e)}function l(e,t){var n=t.protocol,r=t.url,a=t.query,i=t.domain,s=t.full;try{s=decodeURIComponent(s)}catch(o){}if(s.length>55&&(s=s.substr(0,53)+".."),s=clean(s).replace(/&amp;/g,"&"),!e&&i.match(u.OUR_DOMAINS)){r=replaceEntities(r).replace(u.ENTITIES,encodeURIComponent);var l,c=r,d=r.indexOf("#/"),g="";return d>=0?c=r.substr(d+1):(d=r.indexOf("#!"),d>=0&&(c="/"+r.substr(d+2).replace(/^\//,""))),l=c.match(u.VK_DOMAIN),l&&l[1].length<32&&(g=' mention_id="'+l[1]+'" onclick="return mentionClick(this, event)" onmouseover="mentionOver(this)"'),'<a href="'+(n+r+a).replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+'" target="_blank"'+g+">"+s+"</a>"}return'<a href="away.php?utf=1&to='+encodeURIComponent(n+replaceEntities(r+a))+'" target="_blank" onclick="return goAway(\''+clean(n+r+a)+"', {}, event);\">"+s+"</a>"}Object.defineProperty(t,"__esModule",{value:!0}),t.replaceHyperLinks=r,t.replaceEmailLinks=a,t.replaceMentions=i,t.confirmDelivery=o,t.linksReplacer=l;var u=n(27)},function(e,t,n){var r=n(82);e.exports=function(e,t,n,a){try{return a?t(r(n)[0],n[1]):t(n)}catch(i){var s=e["return"];throw void 0!==s&&r(s.call(e)),i}}},function(e,t){"use strict";function n(e){return"im_store_"+e}function r(e){return ls.get(n(e))||{}}function a(e,t,r){if(ls.checkVersion()){var a=JSON.stringify(t);rand(0,1e5)<=1&&statlogsValueEvent("im_local_store_size",a.length),r(n(e),a)}}function i(e,t,n){if(t===f)return e[t]||[];if(t===_)return e[t]&&e[t][n];if(e[t]){var r=extend(!0,{},e[t][n]);return t==g&&(r.txt=clean(r.txt)),r}return null}function s(e,t,n){switch(e[t]||(e[t]={}),t){case d:var r=c(n,2),a=r[0],i=r[1];i&&i.length?e[t][a]=i:e[t][a]&&delete e[t][a];break;case g:var s=c(n,2),o=s[0],l=s[1];l&&(l.txt||l.medias&&l.medias.length)?e[t][o]=l:e[t][o]&&delete e[t][o];break;case f:var u=n;u&&u.length>0?e[t]=u:delete e[t];break;case m:var p=c(n,2),h=p[0],v=p[1];v&&!isEmpty(v)?e[t][h]=v:e[t][h]&&delete e[t][h];break;case _:var b=c(n,2),y=b[0],C=b[1];C?e[t][y]=+C:delete e[t][y]}return e}function o(e,t){var n=["peerFwd_","im_draft","bind_to_url_store_"],i=n.length;if(ls.checkVersion()){var o=r(e);Object.keys(localStorage).reduce(function(e,t){for(var r=0;i>r;r++)if(t.substr(0,n[r].length)===n[r])return e.concat([[n[r]].concat(t.substr(n[r].length).split("_"))]);return e},[]).forEach(function(t){var n=c(t,3),r=n[0],a=n[1],i=n[2];switch(r){case"peerFwd_":if(intval(a)===e){var l="peerFwd_"+e+"_"+i,u=ls.get(l);o=s(o,d,[i,u]),ls.remove(l)}break;case"im_draft":if(intval(a)===e){var f="im_draft"+e+"_"+i,_=ls.get(f);o=s(o,g,[i,_]),ls.remove(f)}break;case"bind_to_url_store_":var p="bind_to_url_store_"+a,h=ls.get(p);o=s(o,m,[a,h]),ls.remove(p)}}),a(e,o,t)}}function l(e,t,r){r.key===n(e)&&(t.db=JSON.parse(r.newValue),t.checkTime=Date.now())}function u(e){var t=debounce(function(e,t){localStorage.setItem(e,t)},300);o(e,t);var n={db:r(e),checkTime:Date.now()},u=l.bind(null,e,n);return window.addEventListener("storage",u,!1),{select:function(t,a){return Date.now()-n.checkTime>1e3&&(n.db=r(e)),i(n.db,t,a)},update:function(r,i){var o=s(n.db,r,i);return n.db=o,n.checkTime=Date.now(),a(e,o,t)},unmount:function(){window.removeEventListener("storage",u,!1)}}}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.migrateLocalstorage=o,t.mount=u;var d=t.FWD_STORE_OP="fwd",g=t.DRAFT_STORE_OP="draft",m=t.ATTACH_STORE_OP="bind_attach",f=t.RECENT_SEARCH_OP="recent_search",_=t.PIN_HIDDEN_ID_OP="pin_hide"},function(e,t){"use strict";function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0});var r,a="\\w\\$А-Яа-яёЁєЄҐґЇїІіЈј",i="(https?:\\/\\/)?",s="((?:["+a+"\\—\\-\\_]+\\.){1,5})",o="([A-Za-z\\$а-яА-Я\\-\\d]{2,22})",l="(?:\\:(\\d{2,5}))",u="("+s+o+l+"?)",c="([\\/?#])",d="\\wА-Яа-я\\xa8\\xb8\\xc0-\\xffєЄҐґЇїІіЈј",g="ªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮͰ-ʹͶͷͺ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԯԱ-Ֆՙա-ևא-תװ-ײؠ-يٮٯٱ-ۓەۥۦۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪߴߵߺࠀ-ࠕࠚࠤࠨࡀ-ࡘࢠ-ࢴࢶ-ࢽऄ-हऽॐक़-ॡॱ-ঀঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡૹଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-హఽౘ-ౚౠౡಀಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೞೠೡೱೲഅ-ഌഎ-ഐഒ-ഺഽൎൔ-ൖൟ-ൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๆກຂຄງຈຊຍດ-ທນ-ຟມ-ຣລວສຫອ-ະາຳຽເ-ໄໆໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᎠ-Ᏽᏸ-ᏽᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛱ-ᛸᜀ-ᜌᜎ-ᜑᜠ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៗៜᠠ-ᡷᢀ-ᢄᢇ-ᢨᢪᢰ-ᣵᤀ-ᤞᥐ-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉᨀ-ᨖᨠ-ᩔᪧᬅ-ᬳᭅ-ᭋᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱽᲀ-ᲈᳩ-ᳬᳮ-ᳱᳵᳶᴀ-ᶿḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼⁱⁿₐ-ₜℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℹℼ-ℿⅅ-ⅉⅎↃↄⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞⸯ々〆〱-〵〻〼ぁ-ゖゝ-ゟァ-ヺー-ヿㄅ-ㄭㄱ-ㆎㆠ-ㆺㇰ-ㇿ㐀-䶵一-鿕ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘟꘪꘫꙀ-ꙮꙿ-ꚝꚠ-ꛥꜗ-ꜟꜢ-ꞈꞋ-ꞮꞰ-ꞷꟷ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꣽꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧏꧠ-ꧤꧦ-ꧯꧺ-ꧾꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩶꩺꩾ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛ-ꫝꫠ-ꫪꫲ-ꫴꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꬰ-ꭚꭜ-ꭥꭰ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼＡ-Ｚａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ",m="　-〿＀-￯",f="\\—\\-\\_@#%?+\\/\\$.~=;:'",_="["+d+f+g+m+"]",p="(?:\\(|\\[)["+a+"\\d&#%;,]+(?:\\)|\\])",h="("+c+"(?:\\&amp;|\\&#\\d{2,6};|,[_%]|!|,*"+_+"+|"+p+"){0,200})?",v=i+u+h,b="ac,ad,ae,af,ag,ai,al,am,an,ao,aq,ar,as,at,au,aw,ax,az,ba,bb,bd,be,bf,bg,bh,bi,bj,bm,bn,bo,br,bs,bt,bv,bw,by,bz,ca,cc,cd,cf,cg,ch,ci,ck,cl,cm,cn,co,cr,cu,cv,cx,cy,cz,de,dj,dk,dm,do,dz,ec,ee,eg,eh,er,es,et,eu,fi,fj,fk,fm,fo,fr,ga,gd,ge,gf,gg,gh,gi,gl,gm,gn,gp,gq,gr,gs,gt,gu,gw,gy,hk,hm,hn,hr,ht,hu,id,ie,il,im,in,io,iq,ir,is,it,je,jm,jo,jp,ke,kg,kh,ki,km,kn,kp,kr,kw,ky,kz,la,lb,lc,li,lk,lr,ls,lt,lu,lv,ly,ma,mc,md,me,mg,mh,mk,ml,mm,mn,mo,mp,mq,mr,ms,mt,mu,mv,mw,mx,my,mz,na,nc,ne,nf,ng,ni,nl,no,np,nr,nu,nz,om,pa,pe,pf,pg,ph,pk,pl,pm,pn,pr,ps,pt,pw,py,qa,re,ro,ru,rs,rw,sa,sb,sc,sd,se,sg,sh,si,sj,sk,sl,sm,sn,so,sr,ss,st,su,sv,sx,sy,sz,tc,td,tf,tg,th,tj,tk,tl,tm,tn,to,tp,tr,tt,tv,tw,tz,ua,ug,uk,um,us,uy,uz,va,vc,ve,vg,vi,vn,vu,wf,ws,ye,yt,yu,za,zm,zw,arpa,aero,asia,biz,cat,com,coop,info,int,jobs,media,mobi,museum,name,net,org,place,post,pro,tattoo,tel,travel,xxx,club,academy,camera,edu,gov,mil,local,international,bar,design",y="бг,бел,дети,ею,католик,ком,мкд,мон,москва,онлайн,орг,рус,рф,сайт,срб,укр",C="qxam,90ae,90ais,d1acj3b,e1a4c,80aqecdr1a,j1aef,d1alf,l1acc,80adxhks,80asehdb,c1avg,p1acf,p1ai,80aswg,90a3ac,j1amh,80ao21a,y9a3aq,9dbq2a,mgbca7dzdo,mgba3a3ejt,mgbayh7gpa,lgbbat1ad8j,mgberp4a5d4ar,mgba7c0bbn0a,mgbc0a9azcg,mgb2ddes,mgbaam7a8h,mgba3a4f16a,mgbbh1a,mgbab2bd,ngbe9e0a,mgbbh1a71e,pgbs0dh,mgbpl2fh,ogbpf8fl,ngbc5azd,mgbtx2b,mgb9awbf,ygbi2ammx,wgbl6a,mgbi4ecexp,fhbei,wgbh1c,mgbx4cd0ab,mgbb9fbpob,4gbrim,mgbt3dhd,mgbai9azgqp6j,mgbgu82a,11b4c3d,c2br7g,h2brj9c,h2breg3eve,h2brj9c8c,i1b6b1a6a2e,54b7fta0cc,45brj9c,45br5cyl,s9brj9c,gecrj9c,3hcrj9c,xkc2dl3a5ee0h,xkc2al3hye2a,clchc0ea0b2g2a9gcd,fpcrj9c3d,2scrj9c,rvc1e0am3e,fzc2c9e2c,42c2d9a,o3cw4h,node,q9jyb4c,gckr3f0f,qcka1pmc,tckwe,cck2b3b,1ck2e1b,bck1b9a5dre4c,eckvdtc9d,rhqv96g,fiq64b,fiqs8s,fiqz9s,fiq228c5hs,vhquv,1qqw23a,vuq861b,nyqy26a,45q11c,55qx5d,55qw42g,kprw13d,kpry57d,czru2d,czrs0t,czr694b,w4rs40l,w4r85el8fhu5dnra,3ds443g,3oq18vl8pn36a,pssy2u,tiq49xqyj,fjq720a,fct429k,estv75g,xhq521b,9krt00a,30rr7y,6qq986b3xl,kput3i,kpu716f,zfr164b,mxtq1m,yfro4i67o,efvy88h,9et52u,rovu88b,nqv7f,b4w605ferd,unup4y,mix891f,mix082f,3pxu8k,pbt977c,6frz82g,nqv7fs00ema,ses554g,hxt814e,5tzm5g,io0a7i,8y0a063a,jlq61u9w7b,flw351e,g2xx48c,gk3at1e,3bst00m,fzys8d69uvgm,kcrx77d1x4a,jvr189m,imr513n,5su34j936bgsg,j6w193g,t60b56a,mk1bu44c,cg4bki,3e0b707e",E=(t.OUR_DOMAINS=/^([a-zA-Z0-9\.\_\-]+\.)?(vkontakte\.ru|vk\.com|vkadre\.ru|vshtate\.ru|userapi\.com|vk\.me)$/,t.ENTITIES=/([^a-zA-Z0-9#%;_\-.\/?&=\[\]])/g,t.VK_DOMAIN=/^(?:https?:\/\/)?(?:vk\.com|vkontakte\.ru)?\/([a-zA-Z0-9\._]+)\??$/,t.MENTION=/\[(id|club)(\d+)(?:\:([a-z0-9_\-]+))?\|([^\$]+?)\]/g,t.MENTION_RAW=/(^|[\s.,:\'\";>\)\(])(\*|@)([A-Za-z0-9_\.]{2,32})\s*\((.+?)\)/g,t.ARROW_UP=38),w=t.ARROW_DOWN=40,S=t.PAGE_UP=33,T=t.PAGE_DOWN=34,k=t.END_KEY=35,I=t.HOME=36,P=t.ENTER=13,M=t.ESC=27,L=(t.UNPRINTABLE_KEYS=[E,w,S,T,P,M,k,I],t.UP_DOWN_CONTROLS=[S,T,w,E,I,k],t.PRINTABLE="printable",t.FOLDER_UNREAD="unread"),A=t.FOLDER_ALL="all",D=t.FOLDER_UNRESPOND="unrespond",O=t.FOLDER_IMPORTANT="important",x=(t.FOLDERS=[A,L,D,O],t.FOLDER_MASKS=(r={},n(r,D,2),n(r,O,1),r),t.TOP_DOMAINS=[].concat(b.split(","),y.split(","),C.split(",").map(function(e){return"xn--"+e})));t.MAX_DOMAIN_LENGTH=x.reduce(function(e,t){return Math.max(e,t.length)},0),t.EMAIL=new RegExp("([a-zA-Zа-яА-Я\\-_\\.0-9\\+]+@("+s+o+"))","ig"),t.MESSAGE_REGEXP=new RegExp(v,"ig")},function(e,t,n){var r=n(76)("keys"),a=n(71);e.exports=function(e){return r[e]||(r[e]=a(e))}},function(e,t,n){var r=n(68);e.exports=function(e){return Object(r(e))}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.screenfull=function(){var e="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,t=function(){for(var e,t,n=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],r=0,a=n.length,i={};a>r;r++)if(e=n[r],e&&e[1]in document){for(r=0,t=e.length;t>r;r++)i[n[0][r]]=e[r];return i}return!1}(),n={request:function r(n){var r=t.requestFullscreen;n=n||document.documentElement,/5\.1[\.\d]* Safari/.test(navigator.userAgent)?n[r]():n[r](e&&Element.ALLOW_KEYBOARD_INPUT)},exit:function(){document[t.exitFullscreen]()},toggle:function(e){this.isFullscreen?this.exit():this.request(e)},raw:t};return t?(Object.defineProperties(n,{isFullscreen:{get:function(){return Boolean(document[t.fullscreenElement])}},element:{enumerable:!0,get:function(){return document[t.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(document[t.fullscreenEnabled])}}}),n):!1}()},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e){return data.state=e,Promise.resolve(data)}function i(e,t,n,r,a){switch(t){case m.ARROW_UP:r.scroll(a,"up"),cancelEvent(n);break;case m.ARROW_DOWN:r.scroll(a,"down"),cancelEvent(n);break;case m.PAGE_UP:n.ctrlKey||(0,g.isClassicInterface)(a)||(r.scroll(a,"up",!0),cancelEvent(n));break;case m.PAGE_DOWN:n.ctrlKey||(0,g.isClassicInterface)(a)||(r.scroll(a,"down",!0),cancelEvent(n));break;case m.HOME:(0,g.isEditableFocused)()||(r.scroll(a,"up",!1,!0),cancelEvent(n));break;case m.END_KEY:(0,g.isEditableFocused)()||(r.scroll(a,"down",!1,!0),cancelEvent(n));break;case m.PRINTABLE:r.focustTxt(e)}}function s(e,t,n,r,a,i){switch(t){case m.ARROW_DOWN:r.hoverNextDialog(i),cancelEvent(n);break;case m.ARROW_UP:r.hoverPrevDialog(i),cancelEvent(n);break;case m.ENTER:(!(0,g.isEditableFocused)()||gpeByClass("_im_dialogs_search_input",document.activeElement))&&r.selectHoveredDialog(i);break;case m.PRINTABLE:a.focusInput(i)}}function o(e,t,n,r,a){switch(t){case m.HOME:case m.END_KEY:r.isEmpty(a)&&i(e,t,n,r,a);break;case m.PAGE_UP:case m.PAGE_DOWN:i(e,t,n,r,a)}}function l(e,t,n,r,a){switch(t){case m.PAGE_UP:!n.ctrlKey&&(0,g.isClassicInterface)(a)&&(r.scroll("up"),cancelEvent(n));break;case m.PAGE_DOWN:!n.ctrlKey&&(0,g.isClassicInterface)(a)&&(r.scroll("down"),cancelEvent(n));break;case m.ARROW_DOWN:r.hoverNextElement(a);break;case m.ARROW_UP:r.hoverPrevElement(a);break;case m.ENTER:gpeByClass("_im_dialogs_creation_name",document.activeElement)?r.confirmCreate(a):gpeByClass("im-create--search",document.activeElement)&&r.selectElement(a);break;case m.PRINTABLE:r.focusSearch(a)}}function u(e,t,n,r,u,c){var g=(0,d["default"])({state:t||"default"});return{signal:function(t,a){switch(g.get().state){case"default":return i(g,t,a,r,e);case"fwd":case"search":return s(g,t,a,n,u,e);case"create":return l(g,t,a,c,e);case"message":return o(g,t,a,r,e);default:throw new Error("Unknown state: "+g.get().state)}},transition:function(e){return g.set(a.bind(null,e))}}}Object.defineProperty(t,"__esModule",{value:!0}),t.create=u;var c=n(89),d=r(c),g=n(41),m=n(27)},function(e,t,n){var r=n(69),a=n(82),i=n(12);e.exports=n(124)?Object.defineProperties:function(e,t){a(e);for(var n,s=i(t),o=s.length,l=0;o>l;)r.f(e,n=s[l++],t[n]);return e}},function(e,t,n){"use strict";var r=n(93),a=n(42),i=n(113),s=n(9),o=n(129),l=n(63),u=n(56),c=n(120),d=n(57),g=n(66)("iterator"),m=!([].keys&&"next"in[].keys()),f="@@iterator",_="keys",p="values",h=function(){return this};e.exports=function(e,t,n,v,b,y,C){u(n,t,v);var E,w,S,T=function(e){if(!m&&e in M)return M[e];switch(e){case _:return function(){return new n(this,e)};case p:return function(){return new n(this,e)}}return function(){return new n(this,e)}},k=t+" Iterator",I=b==p,P=!1,M=e.prototype,L=M[g]||M[f]||b&&M[b],A=L||T(b),D=b?I?T("entries"):A:void 0,O="Array"==t?M.entries||L:L;if(O&&(S=d(O.call(new e)),S!==Object.prototype&&(c(S,k,!0),r||o(S,g)||s(S,g,h))),I&&L&&L.name!==p&&(P=!0,A=function(){return L.call(this)}),r&&!C||!m&&!P&&M[g]||s(M,g,A),l[t]=A,l[k]=h,b)if(E={values:I?A:T(p),keys:y?A:T(_),entries:D},C)for(w in E)w in M||i(M,w,E[w]);else a(a.P+a.F*(m||P),t,E);return E}},function(e,t,n){"use strict";function r(e,t,n,r,a){if("Script error."!==e){var i=a?a.stack||a.message:null;s("unhandled_error",i?{err:e,stack:i}:{err:e})}c&&c.apply(this,arguments)}function a(e){e.preventDefault()}function i(){return!!window.imwl}function s(e,t){i()&&(console.error(e,t),console.trace(),(0,g.retryFn)(d.post,3,function(){return 2})("al_im.php",{act:"a_weird_log",kind:e,data:JSON.stringify(extend({errIdx:m++,ua:navigator.userAgent,noSh:1},t))}))}function o(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return s(e,extend({err:t&&t.message||t},n)),Promise.reject(t)}function l(){c=window.onerror,window.onerror=r,window.addEventListener("unhandledrejection",a)}function u(){window.onerror=c,c=void 0,window.removeEventListener("unhandledrejection",a)}Object.defineProperty(t,"__esModule",{value:!0}),t.isWeirdLogging=i,t.imWeirdLog=s,t.imWeirdCatch=o,t.startLoggingAllUnhandled=l,t.stopLoggingAllUnhandled=u;var c,d=n(109),g=n(17),m=1},function(e,t){"use strict";function n(e,t,n,r,a){return window.statlogsValueEvent(e,t,n,r,a)}function r(e){return Math.random()<e}function a(e,t,a,i,s,o){r(e)&&n(a,i,s,o)}Object.defineProperty(t,"__esModule",{value:!0}),t.statlogsValueEvent=n,t.randEnabled=r,t.statlogsProbValueEvent=a},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e){var t=e.get().tabbedPeers.map(function(t){return e.get().tabs[t.peer]||e.get().mapped_index&&e.get().mapped_index[t.peer]}).filter(function(e){return e}).filter(function(e){return!e.deletedDialog}).map(function(e){var t=e.peerId;return{type:"peer",peer:t}});return t.length>0&&(t=[{type:"sep"}].concat(t)),t}function i(e,t){if("sep"===t.type)return getTemplate("im_right_menu_sep",{});var n=(0,_.getBaseLink)(e)+"?sel="+t.peer+"&tab="+e.get().active_tab,r=(0,_.getBareTab)(t.peer,e),a=r.tab;return a=getTemplate("im_right_menu_ct",{name:a,count:r.unread>0?r.unread:""}),getTemplate("im_right_menu_tpl",{href:n,label:a,peer:t.peer,attrs:'title="'+stripHTML(r.tab)+'"',cls:r.unread>0?"im-right-menu--unread":""})}function s(e,t,n,r){var a=gpeByClass("_im_peer_tab",r),i=intval(domData(a,"list-id")),s=e.get().tabbedPeers.filter(function(e){var t=e.peer;return t!==i});return e.set(p.updateTabbedPeers.bind(null,s,!0)).then(function(){if(o(t,e),i===e.get().peer)e.get().longpoll.push([(0,h.resetPeer)()]);else if(0!==e.get().peer){var n=gpeByClass("_im_right_menu",r);uiRightMenu.hideSliding(n)}}),cancelEvent(n),!1}function o(e,t){return e.pipeReplace(Promise.resolve(a(t)))}function l(e,t){geByClass("_im_peer_tab",e).forEach(function(e){var n=q2ajx(attr(e,"href").split("?")[1]);n.tab!==t.get().active_tab&&attr(e,"href",(0,_.getBaseLink)(t)+"?sel="+n.sel+"&tab="+t.get().active_tab)})}function u(e,t,n,r){return{updateMenu:function(t){l(e,t);var r=gpeByClass("_im_right_menu",e);o(n,t).then(function(){var e;e=t.get().peer?ge("ui_rmenu_peer_"+t.get().peer):ge("ui_rmenu_"+t.get().active_tab),e&&uiRightMenu.switchMenu(e,!0),uiRightMenu.hideProgress(r)})},updateName:function(e,t){var n=ge("ui_rmenu_peer_"+e);if(n){var r=geByClass1("_im_r_tx",n),a=t.get().tabs[e].tab;val(r,a)}},updateCounter:function(e,t){var n=ge("ui_rmenu_peer_"+t);if(n){var r=geByClass1("_im_r_ct",n),a=e.get().tabs[t].unread;val(r,a>0?a:""),toggleClass(n,"im-right-menu--unread",a>0)}},unmount:function(){(0,v.destroyModule)(r),n.unmount()}}}function c(e,t,n){1===n.which&&(e.get().peer&&e.get().longpoll.push([(0,h.resetPeer)()]),e.get().longpoll.push([(0,h.changeTab)(t)]),cancelEvent(n))}function d(e,t,n){var r=(0,g.mount)(e,(0,f["default"])({limit:50,offset:0,noScroll:!0,elements:a(t)}),function(){return{idFn:function(e){return e.peer||"000"},renderFn:i.bind(null,t)}}),o=s.bind(null,t,r),l=(0,v.createModule)({handlers:function(n,r){r(e,"click","_im_r_cl",o),r(e,"click","_im_peer_tab",function(e,n){if(!checkEvent(e)){var r=intval(domData(n,"list-id"));t.get().longpoll.push([(0,h.changePeer)(r,!1,!0,!0)]),cancelEvent(e)}}),b.FOLDERS.forEach(function(r){n(geByClass1("_ui_item_"+r,e.parentNode),"mousedown",c.bind(null,t,r))})}});return u(e,t,r,l)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=d;var g=n(101),m=n(89),f=r(m),_=n(41),p=n(107),h=(n(123),n(74)),v=n(100),b=n(27)},function(e,t,n){"use strict";function r(e,t){return t.selection||(t.selection=[]),t.selection.push(e),Promise.resolve(t)}function a(e){return e.selection=[],Promise.resolve(e)}function i(e,t){return t.selection=t.selection.filter(function(t){return t.id!==e}),Promise.resolve(t)}function s(e,t,n,r,a,s,o){var l=intval(domData(o,"peer"));tooltips.hide(o),t.set(i.bind(null,l)).then(function(i){c(e,r,t,a),n().selectionDeleted(t,l)})}function o(e){var t=0;return function(){var n=e.offsetWidth;setStyle(e,{width:1});var r=e.offsetLeft;if(t===r)return void setStyle(e,{width:n});t=r;var n=e.parentNode.offsetWidth;setStyle(e,{width:Math.max(30,n-r-20)})}}function l(e,t,n,r){e.set(m.setCurrentSearch.bind(null,n,!1)).then(t().onChange)}function u(e,t,n,r){e.set(a).then(c.bind(null,t,n,e,r))}function c(e,t,n,r){var a=n.get().selection,i=uiSearch.getFieldEl(e);uiSearch.focus(e),a.length>0?attr(i,"placeholder",""):attr(i,"placeholder",unclean(getLang("mail_search_creation"))),t.innerHTML=a.map(function(e){return'<div class="token">\n      <div class="token_title">'+e.name+'</div>\n      <div data-peer="'+e.id+'" class="token_del '+_+'"></div>\n    </div>'}).join(""),toggleClass(e,"ui_multiselect_has_selection",a.length>0),domFC(e).scrollTop+=50,r()}function d(e,t){return showTooltip(t,{text:getLang("mail_create_chat_remove_user"),black:1,shift:[15,8],appendParentCls:"_wrap"})}function g(e,t,n){uiSearch.init(e,{onChange:l.bind(null,t,n)});var g=uiSearch.getFieldEl(e),m=ce("div",{className:"_ui_multiselection ui_multiselect_cnt"});g&&g.parentNode.insertBefore(m,g);var p=o(g);t.set(a);var h=s.bind(null,e,t,n,m,p),v=function(){return uiSearch.focus(e)},b=(0,f.createModule)({handlers:function(t,n){n(e,"click",_,h),n(e,"mouseover",_,d),t(e,"click",v)}});return{addSelection:function(n,a){return t.set(r.bind(null,{id:n,name:a})).then(c.bind(null,e,m,t,p))},removeSelection:function(n){return t.set(i.bind(null,n)).then(c.bind(null,e,m,t,p))},resetSelection:function(){u(t,e,m,p)},focus:function(){uiSearch.focus(e)},save:function(){t.stash(),c(e,m,t,p)},restore:function(){t.pop(),c(e,m,t,p)},unmount:function(){uiSearch.destroy(e),(0,f.destroyModule)(b)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=g;var m=n(107),f=n(100),_="_ui_multiselect_cancel"},function(e,t,n){var r;(function(e,a,i){(function(){"use strict";function s(e){return"function"==typeof e||"object"==typeof e&&null!==e}function o(e){return"function"==typeof e}function l(e){K=e}function u(e){J=e}function c(){return function(){e.nextTick(_)}}function d(){return function(){W(_)}}function g(){var e=0,t=new ee(_),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}function m(){var e=new MessageChannel;return e.port1.onmessage=_,function(){e.port2.postMessage(0)}}function f(){return function(){setTimeout(_,1)}}function _(){for(var e=0;X>e;e+=2){var t=re[e],n=re[e+1];t(n),re[e]=void 0,re[e+1]=void 0}X=0}function p(){try{var e=n(78);return W=e.runOnLoop||e.runOnContext,d()}catch(t){return f()}}function h(e,t){var n=this,r=n._state;if(r===oe&&!e||r===le&&!t)return this;var a=new this.constructor(b),i=n._result;if(r){var s=arguments[r-1];J(function(){R(r,a,s,i)})}else A(n,a,e,t);return a}function v(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(b);return I(n,e),n}function b(){}function y(){
return new TypeError("You cannot resolve a promise with itself")}function C(){return new TypeError("A promises callback cannot return that same promise.")}function E(e){try{return e.then}catch(t){return ue.error=t,ue}}function w(e,t,n,r){try{e.call(t,n,r)}catch(a){return a}}function S(e,t,n){J(function(e){var r=!1,a=w(n,t,function(n){r||(r=!0,t!==n?I(e,n):M(e,n))},function(t){r||(r=!0,L(e,t))},"Settle: "+(e._label||" unknown promise"));!r&&a&&(r=!0,L(e,a))},e)}function T(e,t){t._state===oe?M(e,t._result):t._state===le?L(e,t._result):A(t,void 0,function(t){I(e,t)},function(t){L(e,t)})}function k(e,t,n){t.constructor===e.constructor&&n===ae&&constructor.resolve===ie?T(e,t):n===ue?L(e,ue.error):void 0===n?M(e,t):o(n)?S(e,t,n):M(e,t)}function I(e,t){e===t?L(e,y()):s(t)?k(e,t,E(t)):M(e,t)}function P(e){e._onerror&&e._onerror(e._result),D(e)}function M(e,t){e._state===se&&(e._result=t,e._state=oe,0!==e._subscribers.length&&J(D,e))}function L(e,t){e._state===se&&(e._state=le,e._result=t,J(P,e))}function A(e,t,n,r){var a=e._subscribers,i=a.length;e._onerror=null,a[i]=t,a[i+oe]=n,a[i+le]=r,0===i&&e._state&&J(D,e)}function D(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var r,a,i=e._result,s=0;s<t.length;s+=3)r=t[s],a=t[s+n],r?R(n,r,a,i):a(i);e._subscribers.length=0}}function O(){this.error=null}function x(e,t){try{return e(t)}catch(n){return ce.error=n,ce}}function R(e,t,n,r){var a,i,s,l,u=o(n);if(u){if(a=x(n,r),a===ce?(l=!0,i=a.error,a=null):s=!0,t===a)return void L(t,C())}else a=r,s=!0;t._state!==se||(u&&s?I(t,a):l?L(t,i):e===oe?M(t,a):e===le&&L(t,a))}function B(e,t){try{t(function(t){I(e,t)},function(t){L(e,t)})}catch(n){L(e,n)}}function F(e){return new pe(this,e).promise}function N(e){function t(e){I(a,e)}function n(e){L(a,e)}var r=this,a=new r(b);if(!Q(e))return L(a,new TypeError("You must pass an array to race.")),a;for(var i=e.length,s=0;a._state===se&&i>s;s++)A(r.resolve(e[s]),void 0,t,n);return a}function H(e){var t=this,n=new t(b);return L(n,e),n}function j(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function U(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function G(e){this._id=fe++,this._state=void 0,this._result=void 0,this._subscribers=[],b!==e&&("function"!=typeof e&&j(),this instanceof G?B(this,e):U())}function q(e,t){this._instanceConstructor=e,this.promise=new e(b),Array.isArray(t)?(this._input=t,this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?M(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&M(this.promise,this._result))):L(this.promise,this._validationError())}function z(){var e;if("undefined"!=typeof a)e=a;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var n=e.Promise;(!n||"[object Promise]"!==Object.prototype.toString.call(n.resolve())||n.cast)&&(e.Promise=_e)}var V;V=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var W,K,Y,Q=V,X=0,J=function(e,t){re[X]=e,re[X+1]=t,X+=2,2===X&&(K?K(_):Y())},$="undefined"!=typeof window?window:void 0,Z=$||{},ee=Z.MutationObserver||Z.WebKitMutationObserver,te="undefined"!=typeof e&&"[object process]"==={}.toString.call(e),ne="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,re=new Array(1e3);Y=te?c():ee?g():ne?m():void 0===$?p():f();var ae=h,ie=v,se=void 0,oe=1,le=2,ue=new O,ce=new O,de=F,ge=N,me=H,fe=0,_e=G;G.all=de,G.race=ge,G.resolve=ie,G.reject=me,G._setScheduler=l,G._setAsap=u,G._asap=J,G.prototype={constructor:G,then:ae,"catch":function(e){return this.then(null,e)}};var pe=q;q.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},q.prototype._enumerate=function(){for(var e=this.length,t=this._input,n=0;this._state===se&&e>n;n++)this._eachEntry(t[n],n)},q.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===ie){var a=E(e);if(a===ae&&e._state!==se)this._settledAt(e._state,t,e._result);else if("function"!=typeof a)this._remaining--,this._result[t]=e;else if(n===_e){var i=new n(b);k(i,e,a),this._willSettleAt(i,t)}else this._willSettleAt(new n(function(t){t(e)}),t)}else this._willSettleAt(r(e),t)},q.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===se&&(this._remaining--,e===le?L(r,n):this._result[t]=n),0===this._remaining&&M(r,this._result)},q.prototype._willSettleAt=function(e,t){var n=this;A(e,void 0,function(e){n._settledAt(oe,t,e)},function(e){n._settledAt(le,t,e)})};var he=z,ve={Promise:_e,polyfill:he};n(72).amd?(r=function(){return ve}.call(t,n,t,i),!(void 0!==r&&(i.exports=r))):"undefined"!=typeof i&&i.exports?i.exports=ve:"undefined"!=typeof this&&(this.ES6Promise=ve),he()}).call(this)}).call(t,n(47),function(){return this}(),n(43)(e))},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function a(){var e=ls.get(Ht);return e||0}function i(e){e>=window.clientHeight()-30&&(e=0),ls.set(Ht,e)}function s(e,t){var n=geByClass1(e,t),r=n.firstElementChild.offsetHeight!==n.parentNode.offsetHeight;r&&setStyle(n.firstElementChild,{height:n.parentNode.offsetHeight})}function o(e,t){e&&e.innerHTML!==t&&(e.innerHTML=t)}function l(e,t){var n=window.devicePixelRatio>=2?"256":"128";return t?'<div class="im_sticker_row">\n      <a onmouseover="return Emoji.stickerOver('+intval(e)+', this);"\n        onclick="return Emoji.clickSticker('+intval(t)+', this, event);">\n          <img height="128"\n            class="im_gift"\n            src="/images/stickers/'+intval(e)+"/"+n+'.png"/>\n      </a>\n    </div>':'<div class="im_sticker_row">\n      <img height="128"\n        class="im_gift"\n        src="/images/stickers/'+intval(e)+"/"+n+'.png"/>\n    </div>'}function u(e,t,n){if(M(e.get(),t)){var r=e.get().tabs[t].deleted||[];return inArray(n,r)}return!1}function c(e,t,n){var r=n.randomId,a=geByClass1("_im_mess_rid"+r,t);return a&&(t=$([a],t),t=v(e,n,t,!0,!1)),t}function d(e){var t=(0,lt.checkVoiceMessageAvailable)(e);return"undefined"!=typeof t?Promise.resolve(t):g().then(function(e){return e.length>0})["catch"](function(e){return!1})}function g(){return window.AudioContext&&navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(function(e){for(var t=[],n=0;n<e.length;n++)"audioinput"==e[n].kind&&t.push(e[n]);return t}):Promise.reject(new Error("NotSupported"))}function m(e){return getTemplate("im_preloader",{preloader:rs(vk.pr_tpl,{id:""}),cls:"im-preloader_attach im-preloader_visible im-preloader_"+e})}function f(e){var t=e.split(".");return(t[0]<10?"0":"")+t[0]+(t[1]<10?"0":"")+t[1]+t[2]}function _(e){var t=geByClass1("_im_invisible_bar",e);t&&(removeClass(t,"_im_invisible_bar"),removeClass(t,"im-page--history-new-bar_hide"))}function p(e,t,n){var r=h(e,t),a=geByClass1("_im_mess_"+t.messageId,n);return a&&a.parentNode.replaceChild(se(r),a),n}function h(e,t){var n=["_im_mess"],r=(0,mt.isUnread)(e.tabs[t.peerId],t);(0,mt.isOut)(t)&&r&&n.push("im-mess_unread _im_mess_unread");var a=Date.now()-1e3*t.date>1e3;t.local&&a&&n.push("im-mess_sending"),t.local&&n.push(""+Ct),t.failed&&n.push("im-mess_failed "+Et);var i=t.attaches[0]&&"gift"===t.attaches[0].type;i&&n.push("im-mess_gift");var s=t.attaches.map(function(e){return"sticker"===e.type?l(e.id,e.productId):m(e.type)}),o=x(t.text,t.kludges);t.subject&&"..."!==t.subject.trim()&&!k(t.peerId)&&(o=getTemplate("im_topic",{topic:t.subject})+o);var u=getTemplate("im_message_media",{messageId:t.messageId,attaches:s.join(""),text:'<div class="im_msg_text">'+(i?o:"")+"</div>"});return i||(u=o+u),getTemplate("im_msg_row",{msg_id:t.messageId,from_id:t.peerId,text:u,aria_hidden:t.local&&!t.failed?"true":"false",ts:t.date,marker_params:t.failed?'aria-label="'+getLang("mail_send_message_error")+'" role="link"':"",unread_params:r?'aria-label="'+getLang("mail_unread_message")+'" role="link" tabindex="0"':"",cls:n.join(" ")})}function v(e,t,n){var r=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:!0,arguments.length>4&&void 0!==arguments[4]?arguments[4]:!0),a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:!0,i=Date.now()-1e3*t.date>1e3,s=e.tabs[t.peerId];if(geByClass1("_im_mess",n)||geByClass1("_im_bar_date",n)||(n.innerHTML=""),s.skipped>0)return n;var o=[];t.local||(o=e.imQueue(t.peerId,r)),o.length>0&&$(o.map(function(e){return geByClass1("_im_mess_rid"+e.rid,n)},n).filter(function(e){return e}));var l=h(e,t),u=domLC(n);hasClass(u,"_im_mess_stack")||(u=domClosestSibling(u,"._im_mess_stack",-1));var c=(0,lt.getLastMessage)(e,t.peerId,t.messageId),d=geByClass1("_im_unread_bar_row",n),g=(0,mt.getUserId)(t),m=c?A(c.date,e):0;if(!c||D(s,c,t,e,a)){var f="",_=!1;if(d&&(0,mt.isOut)(t)&&je(e,n,t.peerId),1===s.unread&&!(0,mt.isOut)(t)&&a&&(f+=getTemplate("im_mess_bar",{}),_=!0,je(e,n,t.peerId)),!isToday(new Date(m))){var p=new Date,v=_?"im-page--history-new-bar_hide _im_invisible_bar":"";f+=getTemplate("im_day_bar",{day:getShortDate(t.date,e.timeshift,!0,getLang("months_of","raw"),!0),date:t.date,day_class:p.getDate()+p.getMonth()+p.getFullYear()+" "+v})}if(oe(t))f+=getTemplate("im_service_row",{text:ue(e,t,s),type:"",date:t.date,from_id:"",message_id:t.messageId});else{var y=e.gid&&(0,mt.isOut)(t)?intval(t.kludges.from_admin)||0:0,C=(0,vt.oCacheGet)(e,y?-e.gid:g)||s,E=k(t.peerId)?C.name:C.first_name,w=C.link||s.href,S=getTemplate("im_mess_stack_name",{name:E,link:w,"class":(0,mt.isMoney)(t)?" im-mess-stack--lnk-money-transfer":""});if((0,mt.isGift)(t)){var T=getLang("mail_gift_message_sent","raw");S+=' <span class="im-mess-stack--gift">'+langSex(C.sex||0,T)+"</span>"}if((0,mt.isMoney)(t)){var I=(0,mt.isMoneyRequest)(t)?getLang("mail_money_request_message_sent","raw"):getLang("mail_money_tranfer_message_sent","raw");S+=' <span class="im-mess-stack--money-transfer">'+langSex(C.sex||0,I)+"</span>"}t.attaches[0]&&"chronicle_invite"===t.attaches[0].type&&(S+=" "+getLang("mail_chronicle_invite_inf"));var P=e.gid?"/gim"+e.gid:"/im",M=void 0;if(M=t.local?O(t.date,e.timeshift):getTemplate("im_stack_date",{date:O(t.date,e.timeshift),link:P+"?sel="+t.peerId+"&msgid="+t.messageId}),y&&e.admins[y]){var L=e.admins[y],x=y===vk.id?getLang("mail_by_you"):L[0];M=M+" "+getTemplate("im_admin_link",{name:x,href:L[1]})}f+=getTemplate("im_mess_stack",{photo:C.photo,href:w,cls:"",date_attr:"",link:"/im?sel="+t.peerId+"&msgid="+t.messageId,name:stripHTML(S),stack_name:S,peerId:g,date:M,messages:l,admin:t.kludges.from_admin||0})}(0,ht.toArray)(sech(f)).forEach(function(e){return n.appendChild(e)})}else d&&e.peer===t.peerId&&!s.inplaceSearch&&(0,mt.isOut)(t)&&je(e,n,t.peerId),geByClass1("_im_stack_messages",u).appendChild(se(l));return(0,mt.isOut)(t)&&!i&&setTimeout(function(){var e=geByClass1("_im_mess_"+t.messageId,n);hasClass(e,Ct)&&addClass(e,"im-mess_sending")},500),o=o.filter(function(e){return e.rid!==t.randomId}),b(o,e,n)}function b(e,t,n){var r;return r="object"===("undefined"==typeof e?"undefined":ot(e))?e:t.imQueue(e,!1),r.length>0&&r.map(function(e){return e.mess.failed=!!e.failed,e.mess}).filter(function(e){return(0,lt.getMessage)(t,e.peerId,e.messageId)}).forEach(function(e){return v(t,e,n,!1)}),n}function y(e){var t=geByClass1("_im_mess_blind_unread_marker",e);t&&(t.removeAttribute("aria-label"),t.removeAttribute("role"),t.removeAttribute("tabindex"))}function C(e,t,n){var r=e.tabs[t];return(0,ht.toArray)(geByClass("_im_mess_unread",n)).forEach(function(e){var t=intval(domData(e,"msgid"));t>0&&r.out_up_to>=t&&(removeClass(e,"_im_mess_unread"),removeClass(e,"im-mess_unread"),y(e))}),n}function E(e,t,n){var r=geByClass1("_im_msg_media"+t.messageId,e);return r&&(r.innerHTML=n.tabs[t.peerId].mediacontent[t.messageId][0]),e}function w(e,t){if(!(0,lt.isFullyLoadedTab)(t,e.peerId))return 0;var n=t.tabs[e.peerId];return n.msgs[e.messageId]?1:n.msgs["rid"+e.randomId]?2:0}function S(e){return 0==e?!0:!1}function T(e){return e>0&&2e9>e}function k(e){return e>2e9}function I(e){return-2e9>e}function P(e,t){return e===t.peer}function M(e,t){return e.tabs[t]?!0:!1}function L(e,t){return M(e,t)?null!==e.tabs[t].lastmsg:!1}function A(e,t){return 1e3*e+1e3*t.timeshift}function D(e,t,n,r,a){if((0,mt.getUserId)(t)!==(0,mt.getUserId)(n))return!0;var i=A(t.date,r),s=A(n.date,r);return isSameDate(i,s)?(0,lt.isCommunityInterface)(r)&&intval(t.kludges.from_admin)!==intval(n.kludges.from_admin)?!0:n.date-t.date>300?!0:oe(t)||oe(n)?!0:(0,mt.isGift)(t)||(0,mt.isGift)(n)?!0:(0,mt.isGraffiti)(t)||(0,mt.isGraffiti)(n)?!0:(0,mt.isUnread)(e,t)!==(0,mt.isUnread)(e,n)&&a&&!(0,mt.isOut)(n)?!0:!1:!0}function O(e,t){new Date(1e3*e);return langDate(1e3*e,"{hour}:{minute} {am_pm}",1e3*t,[],!0)}function x(e,t,n){return e=(0,ft.replaceHyperLinks)(e||"",ft.linksReplacer.bind(null,n)),e=(0,ft.replaceMentions)(e),e=(0,ft.replaceEmailLinks)(e),t.emoji&&(e=Emoji.emojiToHTML(e,!0)),e}function R(e){return k(e)?"c"+(e-2e9):I(e)?"e"+Math.abs(e+2e9):e}function B(e){var t=e.substr(0,1);switch(t){case"e":return-2e9-intval(e.substr(1));case"c":return 2e9+intval(e.substr(1));default:return intval(e)}}function F(e){return e>9999999?Math.floor(e/1e6)+"M":e>9999?Math.floor(e/1e3)+"K":e>0?e.toString():""}function N(e){return{search:{name:getLang("mail_im_peer_search"),icon:"search"},block_community:{icon:"block",name:getLang("mail_block_comm_messages")},allow_community:{icon:"unblock",name:getLang("mail_allow_comm_messages")},clear:{name:e.peer<-2e9?getLang("mail_im_delete_email_contact"):getLang("mail_im_delete_all_history"),icon:"clear"},chat:{name:getLang("mail_im_create_chat_with"),icon:"invite"},mute:{name:getLang("mail_im_mute"),icon:"mute"},unmute:{name:getLang("mail_im_unmute"),icon:"unmute"},photos:{name:e.gid?getLang("mail_im_show_media_history_group"):getLang("mail_im_show_media_history"),icon:"media"},avatar:{icon:"avatar",name:getLang("mail_update_photo_red")},block:{icon:"block",name:getLang("mail_block_user")},invite:{icon:"invite",name:getLang("mail_im_create_chat_with")},invite_link:{icon:"invite-link",name:getLang("mail_chat_invite_link")},leave:{icon:"leave",name:getLang("mail_leave_chat")},topic:{icon:"topic",name:getLang("mail_change_topic")},"return":{icon:"return",name:getLang("mail_return_to_chat")},pin_hide:{icon:"pin_hide",name:getLang("mail_menu_pin_hide")},pin_unhide:{icon:"pin_unhide",name:getLang("mail_menu_pin_show")},unpin:{icon:"unpin",name:getLang("mail_menu_unpin")}}}function H(e,t){var n='<img src="'+e+'" alt="" class="dialogs_inline_chatter dialogs_inline_chatter_half"/>';return t&&(n=getTemplate("im_dialogs_link",{href:t,photo:n})),'<div class="im_grid">\n    <div class="dialogs_inline_chatter dialogs_inline_chatter_half">\n      '+n+"\n    </div>\n  </div>"}function j(e,t){var n='<img src="'+e+'" alt="" class="dialogs_inline_chatter"/>';return t&&(n=getTemplate("im_dialogs_link",{href:t,photo:n})),'<div class="im_grid">\n    <div class="dialogs_inline_chatter">\n      '+n+"\n    </div>\n  </div>"}function U(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if("string"==typeof e)return'<div class="im_grid"><img src="'+e+'" alt=""/></div>';switch(e.length){case 1:return'<div class="im_grid"><img src="'+e[0]+'" alt=""/></div>';case 2:return e.map(function(e,n){return H(e,t[n])}).join("");case 3:return H(e[0],t[0])+e.slice(1).map(function(e,n){return j(e,t[n+1])}).join("");case 4:return e.map(function(e,n){return j(e,t[n])}).join("")}}function G(e,t,n){if("string"==typeof t.photo&&t.photo)return'<div class="im_grid">\n      <img src="'+t.photo+'" alt="" />\n    </div>';if(t.memberIds&&t.memberIds.length<2)return'<div class="im_grid">\n      <img src="'+e.get().default_chat_photo+'" alt="" />\n    </div>';if(Array.isArray(t.photo))return U(t.photo);var r=(t.data.active||t.memberIds.filter(function(e){return e!=vk.id}).slice(0,4)).map(vt.oCacheGet.bind(null,e)),a=r.map(function(e){return e.photo}),i=n?[]:r.map(function(e){return e.link});return U(a,i)}function q(e){var t=e.get().gid?getLang("mail_search_only_messages_comm"):getLang("mail_search_only_messages");return'<li class="im-page--mess-search-w">\n    <div class="im-page--mess-search '+Rt+'">\n      <button type="button" class="im-i--messages-search"></button>'+t+"\n    </div>\n  </li>"}function z(){return'<li class="im-search-results-head">'+getLang("mail_search_messages")+"</li>"}function V(){return'<li class="im-search-results-head">'+getLang("mail_search_conversations_sep")+"</li>"}function W(){return'<li class="im-search-results-head">'+getLang("mail_search_dialogs_sep")+"</li>"}function K(){return'<li class="im-search-results-head _im_recent_bar">\n    '+getLang("mail_recent_searches")+'\n    <button type="button" class="'+xt+' im-page--clear-recent">'+getLang("mail_clear_recent")+"</button>\n  </li>"}function Y(e){var t=e.get().popular_sugg,n=(0,lt.isClassicInterface)(e)?8:5;return t.length>n&&(t=t.slice(0,n)),'<li class="im-popular clear_fix">'+t.map(function(t){var n=t.peerId,r=(0,vt.oCacheGet)(e,n)||t,a=e.get().tabs[n]||t,i=(e.get().mutedPeers||[]).indexOf(n)>=0;return'<div class="im-popular--item fl_l _im_dialog _dont_add_recent _im_sugg_'+n+" "+(a.unread>0?"sugg-is_unread":"")+" "+(i?"sugg-is_muted":"")+'" data-peer="'+n+'">\n    <a class="im-popular--avatar-w '+onlinePlatformClass(a.online)+'" href="'+r.link+'"><img class="im-popular--avatar" src="'+r.photo+'"/></a>\n    <div class="im-popular--name-w"><a class="im-popular--name" href="'+r.link+'">'+(r.first_name||r.name)+'</a></div>\n    <span class="im-popular--unread _sugg_unread_ct">'+F(a.unread)+"</span>\n</div>"}).join("")+"</li>"}function Q(e,t,n){var r=geByClass1("_im_mess_"+t.messageId,n);if(r){attr(r,"aria-hidden","false"),addClass(r,"im-mess_failed "+Et);var a=geByClass1("_im_mess_marker",r);attr(a,"aria-label",getLang("mail_send_message_error")),attr(a,"role","link")}return n}function X(e,t,n){var r=geByClass1("_im_mess_"+t,n);if(r){removeClass(r,"im-mess_failed"),attr(r,"aria-hidden","true"),removeClass(r,Et);var a=geByClass1("_im_mess_marker",r);attr(a,"aria-label",""),attr(a,"role","")}return n}function J(e,t){var n=e.map(function(e){return geByClass1("_im_mess_"+e,t)}).filter(function(e){return e});return $(n,t)}function $(e,t){var n=e.filter(function(e){return!hasClass(e,"im-mess_srv")}).map(function(e){return e.parentNode});return e.forEach(function(e){return e.parentNode.removeChild(e)}),n.filter(function(e){return 0===domChildren(e).length}).map(function(e){return gpeByClass("_im_mess_stack",e)}).forEach(function(e){var t=domPS(e);hasClass(t,"_im_bar_date")&&re(t),re(e)}),t}function Z(e,t,n,r){return e.map(function(e){return geByClass1("_im_mess_"+e,r)}).filter(function(e){return e}).forEach(function(e){val(e,ae(t,e,n)),addClass(e,"im-mess_light")}),r}function ee(e,t,n){var r=geByClass1("_im_mess_"+e,n);if(r){var a=geByClass1(wt,r);val(r,a.innerHTML),removeClass(r,"im-mess_light")}return n}function te(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:2,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:!1;if(i)return ne(e,t,n,r,!0,a);var s=((0,lt.isClassicInterface)(r),60),o=ne(e,t,n,r,!1,a);return o.length>s?ne(e,t,n,r,!0,a):o}function ne(e,t,n,r,a){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2;r.tabs[t];if(!e)return"";var s=Object.keys(e).sort(function(t,n){return e[n]-e[t]});if(0===s.length)return"";if(s.length>10&&(0,bt.imWeirdLog)("too_much_typers",{nTypers:s.length,typers:e,peer:t,tabName:r.tabs[t].tab,typersJson:JSON.stringify(e)}),T(t)||(0,lt.isCommunityPeer)(t)){var o=n?"":(0,vt.oCacheGet)(r,t).first_name;return o+" "+getLang("mail_typing")}var l=getLang("mail_typing_several",s.length),u=s.slice(0,s.length>i?i:i-1).filter(function(e){return(0,vt.oCacheExists)(r,e)}),c=a?"short_name":"name",d=u.map(function(e){return(0,vt.oCacheGet)(r,e)[c]}).join(", ");if(s.length>i){var g=s.length-i;d+=" "+getLang("mail_and_peer").replace("{count}",g).replace("{typing}",l)}else{var m=!!d,f=void 0;m&&s[i-1]&&(d+=" "+getLang("mail_and_peer_one")+" "),f=m&&s.length!==i||!s[i-1]?"":(0,vt.oCacheGet)(r,s[i-1])[c],d+=f+" "+l}return d}function ae(e,t,n){var r=t.innerHTML,a="delete"===n?"mail_deleted_stop":"mail_marked_as_spam";return'<div class="im-mess--text">\n    '+getLang(a)+' <button type="button" data-peer="'+e+'" class="'+St+' im-mess--btn">'+getLang("mail_restore")+'</button>\n    <div class="'+wt+' im-mess--original">'+r+"</div>\n  </div>"}function ie(){return'<div class="im-page--chat-search-empty">\n    '+getLang("mail_im_search_empty")+"\n  </div>"}function oe(e){return e.kludges&&"undefined"!=typeof e.kludges.source_act}function le(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return n?'<a class="im_srv_lnk '+r+'" target="_blank" href="'+e+'">'+t+"</a>":'<span class="'+r+'">'+t+"</span>"}function ue(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!0,a=t.kludges,i=a.source_act,s=intval(a.source_mid),o=t.userId,l=(0,vt.oCacheGet)(e,o),u="",c=o===s;switch(i){case Tt:u="mail_im_chat_created";break;case kt:u="mail_im_title_updated_dot";break;case It:u=c?"mail_im_returned_to_chat":"mail_im_invited";break;case Pt:u=c?"mail_im_left":"mail_im_kicked_from_chat";break;case Mt:u="mail_im_photo_set";break;case Lt:u="mail_im_photo_removed";break;case At:u=a.source_message?"mail_im_pin_message":"mail_im_pin_message_empty2";break;case Dt:u=a.source_message?"mail_im_unpin_message":"mail_im_unpin_message_empty2";break;case Ot:u="mail_im_invite_by_link";break;default:return"mail_no_support"}if(u=langSex(l.sex,getLang(u,"raw")),u=u.replace("{from}",le(l.link,l.name,r)),s&&s!==o){var d=a.source_email;if(d)u=u.replace("{user}",le("/im?email="+encodeURIComponent(d),"email",r));else{var g=(0,vt.oCacheGet)(e,s),m=i===Pt?g.inv_name:g.kick_name;u=u.replace("{user}",le(g.link,m,r))}}if(a.source_text){var f=a.source_old_text?'«<b class="im_srv_lnk">'+a.source_old_text+"</b>» &rarr; ":"";u=u.replace("{title}",f+('«<b class="im_srv_lnk">'+a.source_text+"</b>»"))}if(a.source_act===At||a.source_act===Dt)if(a.source_message){var _=de(Emoji.emojiToHTML(stripHTML(a.source_message.replace(/<br\s?\/?>/gi," ")),!0)),p=le("",_,!1,"im_srv_mess_link");u=u.replace("{msg}",p)}else u=u.replace(/{link}(.+){\/link}/i,function(e,t){return le("",t,!1,"im_srv_mess_link")});return u}function ce(e,t,n,r){if(t===Mt){var a=geByClass1("_im_mess_"+e.messageId,r);if(a){var i=n.tabs[e.peerId];a.parentNode.innerHTML=getTemplate("im_msg_row",{msg_id:e.messageId,from_id:e.peerId,text:ue(n,e,i)+n.chat_photo_msg,ts:e.date,cls:"im-mess_srv"})}}return r}function de(e){return e.replace(/&lt;&lt;/g,"&laquo;").replace(/&gt;&gt;/g,"&raquo;").replace(/ \-\-/g," &mdash;").replace(/\-\- /g,"&mdash; ").replace(gt.MENTION_RAW,"$1$4")}function ge(e,t){return t?!1:e===vk.id}function me(e,t){return showTooltip(e,{url:(0,lt.isCommunityPeer)(t)?"al_groups.php":"al_profile.php",params:{act:"verified_tt",mid:t,gid:t},slide:15,ajxdt:200,showdt:200,hidedt:200,dir:"auto",shift:[94,7,7],className:"verified_tt"})}function fe(e){return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bottom",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a=se(getTemplate("im_preloader",{preloader:rs(vk.pr_tpl,{id:""}),cls:["bottom"===n?"im-preloader_bottom":"im-preloader_top",r].join(" ")})),i=!1;setTimeout(function(){i||("bottom"===n?e.appendChild(a):e.insertBefore(a,domFC(e)),addClass(a,"im-preloader_visible"))},0),t.then(function(){i=!0,removeClass(a,"im-preloader_visible"),a.parentNode&&a.parentNode.removeChild(a)})}}function _e(e,t){return{0:{msgs:e.reduce(function(e,t){return e[t]=[t,ct.FLAG_IMPORTANT,0,0,"","",{},0],e},{}),hash:t,history:1}}}function pe(e,t){var n=e;if(!t&&!n)return!1;var r=n.target||n.srcElement,a=Nt,i=!1,s=/_im_mess|im_log_act|im_log_ract|_im_log_body|im_log_rspacer|_im_graffiti_w|_wall_post_cont/;do if(!r||r.onclick||r.onmousedown||"A"==r.tagName||hasClass(r,"_im_no_select")||hasClass(r,"im_msg_media_link")||"IMG"==r.tagName&&!hasClass(r,"_im_graffiti")&&!hasClass(r,"emoji")&&!hasClass(r,"emoji_css")&&!hasClass(r,"im_gift")||"TEXTAREA"==r.tagName||hasClass(r,"play_new")||hasClass(r,"videoplayer")||(i=s.test(r.className)))break;while(a--&&(r=r.parentNode));if(!i)return!0;var o=trim((window.getSelection&&window.getSelection()||document.getSelection&&document.getSelection()||document.selection&&document.selection.createRange().text||"").toString());return o?!0:!1}function he(e,t){return'<div class="im-mess--text">\n      <span>'+getLang("mail_restored")+'</span>\n      <a class="_im_go_to" href="/im?sel='+R(e)+"&msgid="+t+'">'+getLang("mail_im_goto_conversation")+"</a>\n    </div>"}function ve(e,t){var n=k(e)?getLang("mail_chat_sure_to_delete_all"):(0,lt.isCommunityPeer)(e)?getLang("mail_group_sure_to_delete_all"):getLang("mail_sure_to_delete_all");return showFastBox({title:getLang("mail_deleteall1"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},n,getLang("mail_delete"),t,getLang("global_cancel"))}function be(e){return showFastBox({title:getLang("mail_unpin_title"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},getLang("mail_unpin_text"),getLang("mail_unpin"),e,getLang("global_cancel"))}function ye(e,t,n,r,a){t.showProgress(),e.set(r.bind(null,a)).then(function(){t.hideProgress(),t.hide(),n().removePeer(e,a),n().updateDialogFilters(e)})}function Ce(e,t,n,r,a){var i=e.get().peer;cancelEvent(r),showBox("al_im.php",{act:"a_show_members_box",chat:i-2e9},{stat:["boxes.css"],params:{dark:1},onDone:function(r,a){var i=(0,pt.createModule)({handlers:function(a,s){s(r.bodyNode.parentNode,"click","_im_invite_box",function(){r.hide(),Ee(e,e.get().peer,t,n),(0,pt.destroyModule)(i)}),s(r.bodyNode.parentNode,"mouseover","im_status_mob_onl",function(e,t){var n=geByClass1("_im_chat_members_w",r.bodyNode.parentNode),a=160,i=gpeByClass("_im_member_item",t),s=i.offsetTop-n.scrollTop+a,o=s>370;mobileOnlineTip(t,{was:intval(domData(t,"was")),mid:intval(domData(t,"peer")),vk_mobile:intval(domData(t,"vk_mobile")),forcetoup:o})})}})}},r)}function Ee(e,t,n,r){var a=e.get().tabs[t],i=a.memberIds.filter(function(e){return-1===a.inactiveIds.indexOf(e)});e.set(r.bind(null,"add_member",i)).then(n().showCreation)}function we(e,t,n){if(e.get().active_tab===gt.FOLDER_ALL&&0===e.get().unread_cnt)return!1;var r=e.get().active_tab===gt.FOLDER_ALL?gt.FOLDER_UNREAD:gt.FOLDER_ALL;return e.set(n.bind(null,r)).then(function(e){t().restoreDialogs(e,!0)})}function Se(e,t,n,r){if(t.get().active_tab===e)return Promise.resolve(t);var a=(0,lt.isReversedDialogs)(t);return t.set(r.bind(null,e)).then(function(e){return n().restoreDialogs(e,!0,a!==(0,lt.isReversedDialogs)(e)),e})}function Te(e,t){"undefined"==typeof t&&(t=e.get().peer);var n=e.get().tabs[t];return gt.FOLDER_MASKS[gt.FOLDER_IMPORTANT]&n.folders}function ke(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;if("undefined"==typeof t&&(t=e.get().peer),!(0,lt.isFoldersAvailable)(e))return!1;var r=n||e.get().tabs[t];return gt.FOLDER_MASKS[gt.FOLDER_UNRESPOND]&r.folders}function Ie(e,t){return(t.get().block_states[e]||{}).free===!1}function Pe(e){return e.get().pendingForward&&e.get().pendingForward.length>0}function Me(e,t){return(t.get().block_states[e]||{}).who===vk.id}function Le(e,t){var n=e.get().block_states;Object.keys(n).forEach(function(r){n[r].time?n[r].free===!1&&Date.now()-n[r].time>=5e4&&t.push([ct.mutexEvent([,1,"gim"+e.get().gid,r,0,""])]):n[r].time=Date.now()})}function Ae(e,t,n){var r;return!showTabbedBox("al_im.php",{act:"a_spam",offset:"0",gid:e.get().gid},{onDone:function(n,a){a&&(r=t(n,e,a))},params:{width:638,onHide:function(){AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0),r.unmount()}}},n)}function De(e,t){var n=(0,lt.getTab)(e,t).last_seen;if(n[0])return 2===n[2]?'<span class="is_vk_mobile is_online">'+getLang("mail_header_online_status")+Oe(t,!1,!0)+"</span>":"online"+(mobPlatforms[n[0]]?Oe(t):"");if(!n[1])return"";var r=getDateText(n[1],e.get().timeshift),a=langSex((0,vt.oCacheGet)(e,t).sex,getLang("mail_last_activity_tip","raw")).replace("{user}","").replace("{time}",r);return 2===n[2]?a+=Oe(t,!1,!0):n[2]&&(a+=Oe(t,!1)),a}function Oe(e,t,n){var r=n?"":'onclick="mobilePromo();"',a=n?", vk_mobile: 1":"",i=n?" vk_mobile":"";return getTemplate("im_wrap_mobile",{"class":"im_status_mob_onl"+i,params:"mid: "+e+", was: 1,"+(t?"forcetoup: true":"forcetodown: true")+a,attrs:r})}function xe(e,t){var n=t.get().tabs[e];return showBox("al_settings.php",{act:"blacklist_box",q:n.href},{stat:["settings.js","settings.css"],dark:1})}function Re(e,t){return showBox("groupsedit.php",{act:"bl_edit",name:"/id"+e,gid:t.get().gid},{stat:["page.css","ui_controls.js","ui_controls.css"],dark:1})}function Be(e){return e.get().gid?"/gim"+e.get().gid:"/im"}function Fe(e,t,n,r){var a;return!showTabbedBox("al_im.php",{act:"a_important",offset:"0"},{onDone:function(r,i){i&&(a=n(r,e,t,i))},params:{width:638,onHide:function(){AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0)},onDestroy:function(){a&&a.unmount()}}},r)}function Ne(){return"INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName||document.activeElement.getAttribute("contenteditable")}function He(e,t,n){var r=geByClass1("_im_mess_"+e,n);return r&&toggleClass(r,"im-mess_fav",t),n}function je(e,t,n){var r=geByClass1("_im_unread_bar_row",t);if(!r)return t;var a=domClosestSibling(r,"._im_mess_stack",-1),i=domClosestSibling(r,"._im_mess_stack"),s=a?geByClass("_im_mess",a).pop():null,o=i?geByClass1("_im_mess",i):null;if(re(r),_(t),!o||!s)return t;var l=domData(s,"msgid"),u=domData(o,"msgid"),c=(0,lt.getMessage)(e,n,l),d=(0,lt.getMessage)(e,n,u);if(D(e.tabs[n],c,d,e))return t;var g=geByClass1("_im_stack_messages",a),m=geByClass1("_im_stack_messages",i).children;return(0,ht.toArray)(m).forEach(function(e){re(e),g.appendChild(e)}),re(i),t}function Ue(e,t,n){var r=(0,lt.getFirstUnread)(e,e.get().peer);if(!r)return[!1,0];var a=geByClass1("_im_mess_"+r,t);if(!a){var i=(0,lt.getLastMessage)(e,e.get().peer,r);if(!i)return[!0,0];a=geByClass1("_im_mess_"+i.messageId,t)}var s=hasClass(a,"_im_mess_srv")?a:gpeByClass("_im_mess_stack",a);if(!s)return[!0,0];var o=a?a.offsetTop:0,l=s.offsetTop+o,u=n.contHeight();return l<=n.scrollTop()+n.getScrollHeight()?[!0,0]:[!1,Math.max(0,u-l)]}function Ge(e,t,n){cancelEvent(t);var r=gpeByClass("_im_top_notice",n);fadeOut(r,200,re.pbind(r));var a=gpeByClass("_im_page_dialogs",r);a&&hasClass(a,"im-page--dialogs-notice")&&removeClass(a,"im-page--dialogs-notice"),ajax.post("al_im.php",{act:"a_hide_top_notice",type:r.getAttribute("data-type"),hash:r.getAttribute("data-hash")})}function qe(e,t,n){cancelEvent(t);var r=gpeByClass("_im_aside_notice",n);slideUp(r,200,re.pbind(r)),ajax.post("al_im.php",{act:"a_hide_top_notice",type:r.getAttribute("data-type"),hash:r.getAttribute("data-hash")})}function ze(e,t,n,r,a){return n=n.replace(/\<br\s*\/?\>(\n)?/gi," ").replace(/[\n\r]/gi," "),n=(0,ft.replaceMentions)(n,function(e,t,n,r,a){return a}),r&&(n=Emoji.emojiToHTML(n,!0)),t&&"..."!==t.trim()&&!k(e)&&(n=getTemplate("im_topic",{topic:t,cls:"im-topic_dialog"})+n),!n&&a.length>0&&(n=getTemplate("im_dialog_media",{name:Ye(a[0],a)})),n}function Ve(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return[e,t]}function We(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(r>50)return[[],e.length];for(var a=[],i=!1;n<e.length;){var s=e[n];if("id"===s)i=t[n];else if(","===s&&i)a.push(Ve(i)),i=!1;else if("("===s){var o=We(e,t,n+1,r+1),l=st(o,2),u=l[0],c=l[1];n=c,a.push(Ve(i,u)),i=!1}else if(")"===s)return i!==!1&&a.push(Ve(i)),[a,n];n++}return i&&a.push(Ve(i)),[a,n];
}function Ke(e){if(jt[e])return jt[e];for(var t=e?e.length:0,n=[],r=[],a="",i=0;t>i;i++){var s=e[i],o=s.charCodeAt(0);o>=48&&57>=o||"_"===s||"-"===s?a+=s:("("===s||")"===s||":"===s||","===s)&&(""!==a&&(r.push(a),n.push("id"),a=""),r.push(s),n.push(s))}a.length>0&&(r.push(a),n.push("id"));var l=We(n,r),u=st(l,1),c=u[0];return Object.keys(jt).length>300&&(jt={}),jt[e]=c,c}function Ye(e,t){var n={photo:getLang("mail_added_photos","raw"),video:getLang("mail_added_videos","raw"),audio:getLang("mail_added_audios","raw")};switch(e.type){case"fwd":var r=Ke(e.raw).length;return langNumeric(r,getLang("mail_fwd_msgs","raw"),!0);case"photo":case"video":case"audio":var a=t.filter(function(t){return t.type===e.type}).length;return langNumeric(a,n[e.type],!0);case"audio_playlist":return getLang("mail_added_audio_playlist");case"doc":switch(e.kind){case"graffiti":return getLang("mail_added_graffiti");case"audiomsg":return getLang("mail_added_audiomsg");default:return getLang("mail_added_docs")}case"geo":case"map":return getLang("mail_added_geo");case"wall":return getLang("mail_added_wall");case"wall_reply":return getLang("mail_added_wall_reply");case"gift":return getLang("mail_added_gift");case"link":case"share":return getLang("mail_added_link");case"sticker":return getLang("mail_added_sticker");case"chronicle":return getLang("mail_added_chronicle");case"chronicle_invite":return getLang("mail_invite_chronice");case"market":return getLang("mail_added_market_item");case"money_transfer":return getLang("mail_added_money_transfer");case"money_request":return getLang("mail_added_money_request");case"story":return getLang("mail_added_story");case"mask":return getLang("mail_added_mask")}return""}function Qe(e){addClass(e,"im-send-btn_loading")}function Xe(e){removeClass(e,"im-send-btn_loading")}function Je(e){var t=e.get(),n=(0,lt.getPinnedMessage)(e);if(!n||!(0,yt.isPinnedMessageVisibleInTab)(e,(0,lt.getPeer)(e)))return"";var r=(0,vt.oCacheGet)(e,n.userId);if(!r)return"";var a=n.text;a=!a&&n.attaches.length?getTemplate("im_pinned_message_media",{text:Ye(n.attaches[0],n.attaches)}):x(a,n&&n.kludges||{})||"",a=a.replace(/<br\s?\/?>/gi," ");var i=getTemplate("im_pinned_message",{date:getSmDate(n.date,t.timeshift),content:a,link:r.link,name:r.name});return i}function $e(e,t,n,r,a){var i=e.get(),s=void 0;return!showTabbedBox("al_im.php",{act:"a_get_pinned_message_box",chat:n,hash:i.tabs[n].hash},{onDone:function(n,a){a&&(s=r(n,e,t,a))},params:{width:638,onHide:function(){AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0)},onDestroy:function(){s&&s.unmount()}}},a)}function Ze(e,t){return k(e.peerId)?e.memberIds.indexOf(t)>=0&&e.inactiveIds.indexOf(t)<0:!1}function et(e){return!k(e.peerId)||e.data.kicked?0:e.memberIds.length-e.inactiveIds.length}function tt(e,t){var n=(0,vt.oCacheGet)(e,t.peerId);return n&&(t.photo=t.photo||n.photo,t.name=t.name||n.name,t.href=t.link||n.link,t.sex=t.sex||n.sex),t.last_touched=t.last_touched||0,t.verified=!!t.verified,t.lastmsg=t.lastmsg||t.lastmsg_meta&&t.lastmsg_meta[0]||!1,t.folders=t.folders||null,t.unread=t.unread||0,t.last_seen=t.last_seen||[0,0,0],t.online=t.last_seen&&t.last_seen[0]||0,t.out_up_to=t.out_up_to||t.in_up_to||0,t}function nt(e,t){for(var n in t)tt(e,t[n])}function rt(e,t){var n=[],r=t.find(function(e){return"fwd"===e[0]}),a=r&&r[1]||[];for(a.length>Ft&&(r[1]=a.slice(0,Ft));e.length>Bt;){var i=e.substr(0,Bt).lastIndexOf(" ");-1==i&&(i=Bt),n.push({msgText:trim(e.substr(0,i))}),e=trim(e.substr(i))}for(e.length&&n.push({msgText:e,attaches:t}),n.length||n.push({attaches:t}),a=a.slice(Ft);a.length;a=a.slice(Ft))n.push({attaches:[["fwd",a.slice(0,Ft)]]});return n}function at(e){return e.length>Bt}function it(e,t,n){var r=!1;showBox("al_im.php",{act:"a_chat_preview",chat_id:t.invite_chat_id,hash:t.invite_hash},{stat:["boxes.css"],params:{dark:1,hideButtons:!0,onHide:function(){e.set(n),r&&r.unmount()}},onDone:function(t,n){r=(0,_t.mount)(t.bodyNode,e)}},{})}Object.defineProperty(t,"__esModule",{value:!0}),t.MESSAGE_SEARCH_CLASS=t.CLEAR_RECENT_CLASS=t.HIDE_ASIDE_NOTICE_CLASS=t.HIDE_TOP_NOTICE_CLASS=t.SHOW_CHAT_MEMBERS_CLASS=t.DESELECT_ALL_CLASS=t.CHAT_INVITE_BY_LINK=t.CHAT_UNPIN_MESSAGE=t.CHAT_PIN_MESSAGE=t.CHAT_PHOTO_REMOVE=t.CHAT_PHOTO_UPDATE=t.CHAT_KICK_USER=t.CHAT_INVITE_USER=t.CHAT_TITLE_ACTION=t.CREATE_CHAT_ACTION=t.TYPING_CLASS=t.RESTORE_CLASS=t.ORIGINAL_CLASS=t.FAILED_CLASS=t.SENDING_CLASS=void 0;var st=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},lt=n(86);Object.keys(lt).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return lt[e]}})}),t.getClassicChatHeight=a,t.setClassicChatHeight=i,t.fixTableCellChildHeight=s,t.applyInnerHtml=o,t.renderSticker=l,t.isAlreadyDeleted=u,t.replaceMessageAttrs=c,t.isVoiceMessageAvailable=d,t.getAvailableMicrophones=g,t.renderAttach=m,t.dayFromVal=f,t.showInvisibleBar=_,t.editAndReplaceMessage=p,t.renderMessage=h,t.appendToHistory=v,t.restoreQueue=b,t.markMessagesAsRead=C,t.replaceAttaches=E,t.isDuplicate=w,t.isReservedPeer=S,t.isUserPeer=T,t.isChatPeer=k,t.isPeerActive=P,t.isTabLoaded=M,t.isTabLoadedWithMessage=L,t.parseMessage=x,t.convertPeerToUrl=R,t.unUrlPeer=B,t.simplifyCounter=F,t.chatActions=N,t.renderPhotos=U,t.renderPhotosFromTab=G,t.renderBtnSearchOnlyMessages=q,t.renderMessagesSep=z,t.renderConversationsSep=V,t.renderPopularSuggSep=W,t.renderClearRecent=K,t.renderPopularSuggestions=Y,t.setMessageError=Q,t.startResendMessage=X,t.removeMessages=J,t.removeMessagesWithRestore=Z,t.restoreMessage=ee,t.formatTyper=te,t.formatTyperHelper=ne,t.renderEmptySearch=ie,t.isServiceMsg=oe,t.serviceLink=le,t.renderServiceMsg=ue,t.addChatPhotoToUpdate=ce,t.replaceSpecialSymbols=de,t.isSelfMessage=ge,t.showVerifiedTooltip=me,t.wrapLoading=fe,t.tabFromIds=_e,t.checkSelectClick=pe,t.renderGoTo=he,t.showFlushDialog=ve,t.showUnpinDialog=be,t.cleanHistory=ye,t.showChatMembers=Ce,t.inviteUser=Ee,t.showUnreadOnly=we,t.changeTab=Se,t.isImportant=Te,t.isUnrespond=ke,t.isPeerBlocked=Ie,t.isPendingForward=Pe,t.isPeerBlockedByMe=Me,t.blockLatencyCompensation=Le,t.showSpamLayer=Ae,t.getLastSeenTextInHeader=De,t.getMobileIcon=Oe,t.showBlacklistBoxUser=xe,t.showBlacklistBox=Re,t.getBaseLink=Be,t.showFavvedBox=Fe,t.isEditableFocused=Ne,t.updateStar=He,t.removewNewUnreadBarAndMerge=je,t.isMessagesVisible=Ue,t.hideTopNotice=Ge,t.hideAsideNotice=qe,t.renderShortText=ze,t.attachToText=Ye,t.lockButton=Qe,t.unlockButton=Xe,t.renderPinnedMessage=Je,t.showPinnedBox=$e,t.isUserAliveInChat=Ze,t.getAliveMembersCount=et,t.normalizeTab=tt,t.normalizeTabsGotFromServer=nt,t.splitMessageToParts=rt,t.isMessageTooLong=at,t.showInvitationBox=it;var ut=n(74),ct=r(ut),dt=n(27),gt=r(dt),mt=n(15),ft=n(24),_t=n(61),pt=n(100),ht=n(123),vt=n(90),bt=n(36),yt=n(119),Ct=t.SENDING_CLASS="_im_mess_sending",Et=t.FAILED_CLASS="_im_mess_failed",wt=t.ORIGINAL_CLASS="_im_mess_original",St=t.RESTORE_CLASS="_im_mess_restore",Tt=(t.TYPING_CLASS="_im_typing",t.CREATE_CHAT_ACTION="chat_create"),kt=t.CHAT_TITLE_ACTION="chat_title_update",It=t.CHAT_INVITE_USER="chat_invite_user",Pt=t.CHAT_KICK_USER="chat_kick_user",Mt=t.CHAT_PHOTO_UPDATE="chat_photo_update",Lt=t.CHAT_PHOTO_REMOVE="chat_photo_remove",At=t.CHAT_PIN_MESSAGE="chat_pin_message",Dt=t.CHAT_UNPIN_MESSAGE="chat_unpin_message",Ot=t.CHAT_INVITE_BY_LINK="chat_invite_user_by_link",xt=(t.DESELECT_ALL_CLASS="_im_deselect_all",t.SHOW_CHAT_MEMBERS_CLASS="_im_show_chat_mems",t.HIDE_TOP_NOTICE_CLASS="_im_top_notice_hide",t.HIDE_ASIDE_NOTICE_CLASS="_im_aside_notice_hide",t.CLEAR_RECENT_CLASS="_im_clear_recent"),Rt=t.MESSAGE_SEARCH_CLASS="_im_mess_search",Bt=3980,Ft=100,Nt=8,Ht="chatPosition",jt={}},function(e,t,n){var r=n(19),a=n(46),i=n(9),s=n(113),o=n(10),l="prototype",u=function(e,t,n){var c,d,g,m,f=e&u.F,_=e&u.G,p=e&u.S,h=e&u.P,v=e&u.B,b=_?r:p?r[t]||(r[t]={}):(r[t]||{})[l],y=_?a:a[t]||(a[t]={}),C=y[l]||(y[l]={});_&&(n=t);for(c in n)d=!f&&b&&void 0!==b[c],g=(d?b:n)[c],m=v&&d?o(g,r):h&&"function"==typeof g?o(Function.call,g):g,b&&s(b,c,g,e&u.U),y[c]!=g&&i(y,c,m),h&&C[c]!=g&&(C[c]=g)};r.core=a,u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,e.exports=u},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function a(e){return e&&e.__esModule?e:{"default":e}}function i(e,t,n){removeClass(t.parentNode,"im-page--dialogs_with-mess");var r=n.getCurrentElements().filter(function(e){return e.message});n.toTop(),n.reset(),(0,ie.statlogsProbValueEvent)(.01,"im_search_stat",1,"search_messages_only"),r.length>0?(r=[{type:"sep_messages"}].concat(r),e.setState({searchOnlyMessages:!0})):r=[L()],n.pipeReplace(Promise.resolve(r))}function s(e){return hasClass(e,"_im_search")}function o(e,t,n,r){if((0,Q.isSearching)(e)&&e.get().searchAllLoaded||(0,Q.isRecentSearchesActive)(e))return Promise.resolve([]);if(e.get().dialog_search_going||(0,Y.isClassicInterface)(e)&&0!==e.get().peer)return Promise.resolve(!1);if((0,Q.isSearching)(e))return(0,K.searchMessages)((0,Q.getSearchText)(e),e.get()).then(function(e){var t=W(e,2),n=t[0],r=t[1];return M(r,n)});var a=e.get().active_tab,i=e.get().dialog_tabs_all;return i[J.FOLDER_ALL]&&!(0,Y.isReversedDialogs)(e)||i[a]?0===q(e).length?Promise.resolve([{type:"empty_dialogs"}]):Promise.resolve([]):e.set(K.loadDialogs).then(function(t){var n=q(e);return 0===n.length?[{type:"empty_dialogs"}]:n})}function l(e,t,n,r,a){if(!gpeByClass("_im_peer_target",r.target)){var i=t.get(),o=s(a),l=parseInt(domData(a,"peer"),10),u=parseInt(domData(a,"msgid"),10),c=(0,Q.getTab)(t,l);if(hasClass(a,"_im_create_email")){var d=trim(geByClass1("_im_dialog_link",a).textContent);c={name:d,type:"email_create"}}if(checkEvent(r))return window.open(h(t,c,u,o));if(c&&"email_create"===c.type)return(0,K.createEmailChat)(c.name,i).then(function(e){return i.longpoll.push([ne.changePeer(e,!1,!0,!0)])})["catch"](function(e){showFastBox(getLang("global_error"),e),document.activeElement&&document.activeElement.blur()});if(n.saveScroll("list"),o&&i.msgid!==u)i.longpoll.push([ne.changePeer(l,u)]);else if(l!==i.peer){i.longpoll.push([ne.changePeer(l,!1,!0,!0)]);var g=(0,Q.isSearching)(t);g&&!hasClass(a,"_dont_add_recent")&&(0,K.saveRecentSearchPeer)(l,cur.imDb),g&&c&&!(0,Y.isClassicInterface)(t)&&setTimeout(function(){var e=c.message?c.message.messageId:c.peerId;n.scrollToElement(e.toString(),!0,0,"center")},100)}else l===i.peer&&i.longpoll.push([ne.changePeer(l,!1,!0,!o)]);cancelEvent(r)}}function u(e,t,n,r){var a=void 0;!(0,Y.isChatPeer)(t)||"string"==typeof n.photo&&""!==n.photo?(a='<img src="'+n.photo+'" alt="">',r&&(a=getTemplate("im_dialogs_link_img",{href:n.href,photo:a}))):a=(0,Y.renderPhotosFromTab)(e,n,!r);var i='<span class="_im_dialog_link">'+n.tab+"</span>";return{photo:a,userLink:i}}function c(e){return!(0,Y.isPendingForward)(e)}function d(e,t,n){return n?getTemplate("im_img_prebody",{photo:t}):e+":"}function g(e,t,n,r,a,i,s,o,l,u,c){var g="",m="";return t&ne.FLAG_OUTBOUND?g=d(getLang("mail_by_you"),c,u):(0,Y.isChatPeer)(r)&&0!==a&&(g=d((0,se.oCacheGet)(e,a).first_name,(0,se.oCacheGet)(e,a).photo,u)),o=(0,Y.renderShortText)(r,l,o,i,s),m=g?getTemplate("im_drow_prebody",{prebody:g,body:o}):o}function m(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},i=[];return(0,Y.isClassicInterface)(r)&&i.push("nim-dialog_classic"),(0,Q.isRecentSearchesActive)(r)&&i.push("nim-dialog_recent"),i.push("nim-dialog_empty"),a.search&&i.push("_im_search"),getTemplate("im_drow",{peer:e.peerId,msg_id:"",photo:t,user_link:n,date:"",body:"",unread:"",more:i.join(" "),is_star:"",unread_message_string:"",is_online:onlinePlatformClass(e.online),is_unread:"",is_unread_out:"",is_selected:e.peerId==r.get().peer?"nim-dialog_selected _im_dialog_selected":""})}function f(e,t,n){return n&ne.FLAG_OUTBOUND?(0,Y.isSelfMessage)(t.peerId,e.get().gid)?!1:(0,Y.isChatPeer)(t.peerId)&&t.data&&t.data.closed?!1:t.unread?!1:t.lastmsg<=t.out_up_to?!1:!0:!1}function _(e){var t=C(e),n=e.unread>0?e.unread:"";return n>0&&t}function p(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=u(e,t.peerId,t,(0,Y.isClassicInterface)(e)),i=a.photo,s=a.userLink,o=n||C(t);if(!o)return m(t,i,s,e,r);var l=o.flags,c=y(t,e,n),d=[];r.search&&d.push("_im_search","nim-dialog_search"),inArray(t.peerId,e.get().mutedPeers)&&d.push("nim-dialog_muted"),t.verified&&d.push("nim-dialog_verified"),(0,Q.isRecentSearchesActive)(e)&&d.push("nim-dialog_recent"),-1===o.messageId&&d.push("nim-dialog_empty"),(0,Y.isClassicInterface)(e)&&d.push("nim-dialog_classic"),t.folders&ne.FOLDER_IMPORTANT&&d.push("nim-dialog_starred"),!r.search&&(0,Y.isUnrespond)(e,t.peerId,t)&&d.push("nim-dialog_unrespond");var g=e.get().timeshift,p=f(e,t,l)?"nim-dialog_unread-out":"",h=t.unread>0?getLang("mail_im_new_messages",t.unread):"";return getTemplate("im_drow",{peer:t.peerId,msg_id:o.messageId,photo:i,user_link:s,date:o.date?getShortDateOrTime(o.date,g,!0,getLang("months_sm_of","raw")):"",body:c,unread_message_string:h,tab_name:stripHTML(t.tab),unread:(0,Y.simplifyCounter)(t.unread),more:d.join(" "),is_online:onlinePlatformClass(t.online),is_unread:_(t)?"nim-dialog_unread":"",is_unread_out:p,is_selected:r.noselect||t.peerId!=e.get().peer?"":"nim-dialog_selected _im_dialog_selected"})}function h(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1,a=(0,Y.getBaseLink)(e),i=function(){return a+"?sel="+(0,Y.convertPeerToUrl)(t.peerId)+(r&&n?"&msgid="+n:"")};return"email_create"===t.type?a+"?email="+t.name:r?i():(0,Y.isUserPeer)(t.peerId)||(0,Y.isCommunityPeer)(t.peerId)?(0,Y.isClassicInterface)(e)?i():t.href:i()}function v(e,t,n,r,a){if(!t.deletedDialog){if(hasClass(e,"nim-conversation-search-row"))return void b(e,t,n);var i=C(t),s=i.flags,o=y(t,n),l=u(n,t.peerId,t,(0,Y.isClassicInterface)(n)),c=l.photo,d=n.get().timeshift,g=i.date?getShortDateOrTime(i.date,d,!0,getLang("months_sm_of","raw")):"";B(e,t),val(geByClass1("_dialog_body",e),o),val(geByClass1("_im_dialog_date",e),g),val(geByClass1("_im_dialog_unread_ct",e),(0,Y.simplifyCounter)(t.unread)),val(geByClass1("_im_dialog_link",e),t.tab);var m=geByClass1("_im_dialog_photo",e);m.innerHTML!==c&&val(m,c),toggleClass(e,"nim-dialog_verified",!!t.verified),toggleClass(e,"nim-dialog_starred",t.folders&ne.FOLDER_IMPORTANT),toggleClass(e,"nim-dialog_muted",inArray(t.peerId,n.get().mutedPeers)),toggleClass(e,"nim-dialog_unrespond",(0,Y.isUnrespond)(n,t.peerId,t)),toggleClass(e,"nim-dialog_classic",(0,Y.isClassicInterface)(n)),removeClass(e,"nim-dialog_failed"),removeClass(e,"nim-dialog_deleted"),addClass(e,"_im_dialog"),toggleOnline(geByClass1("_im_peer_online",e),t.online),_(t)&&addClass(e,"nim-dialog_unread"),toggleClass(e,"nim-dialog_recent",(0,Q.isRecentSearchesActive)(n)),toggleClass(e,"nim-dialog_empty",-1===i.messageId),f(n,t,s)&&addClass(e,"nim-dialog_unread-out"),a&&setTimeout(function(){addClass(geByClass1("_im_dialog_"+t.peerId,r),"nim-dialog_injected")},100)}}function b(e,t,n){B(e,t),toggleClass(e,"nim-dialog_recent",(0,Q.isRecentSearchesActive)(n)),val(geByClass1("_im_dialog_unread_ct",e),(0,Y.simplifyCounter)(t.unread));var r=u(n,t.peerId,t,(0,Y.isClassicInterface)(n)),a=r.photo,i=geByClass1("_im_dialog_photo",e);i.innerHTML!==a&&val(i,a),toggleOnline(geByClass1("_im_peer_online",e),t.online),_(t)&&addClass(e,"nim-dialog_unread")}function y(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,r=n||C(e);if((0,Y.isPeerBlocked)(e.peerId,t)){var a=t.get().block_states[e.peerId].name,i=getLang("mail_community_answering").replace("{username}",a);return getTemplate("im_drow_prebody",{prebody:i,body:""})}return(0,Y.isServiceMsg)(r)?(0,Y.renderServiceMsg)(t,r,e,!1):g(t,r.flags,e,e.peerId,r.userId,!0,r.attaches,r.text,r.subject,(0,Y.isClassicInterface)(t),(0,se.oCacheGet)(t,t.get().id).photo)}function C(e){var t=e.lastmsg_meta;if(isArray(t)&&(t=(0,te.addMessageEvent)([4].concat(t))),!t){var n="";return n=(0,Y.isChatPeer)(e.peer)?getLang("mail_im_n_chat_members",(0,Y.getAliveMembersCount)(e)):e.online?getLang("global_online_sm"):getLang("mail_offline"),(0,te.addMessageEvent)([4,-1,0,e.peer,"","",n,{},-1])}return t}function E(e,t,n,r,a){var i=geByClass1("_dialog_body",t);addClass(t,"nim-dialog_deleted"),removeClass(t,"_im_dialog"),val(i,getTemplate("im_delete_actions",{text:langNumeric(n,getLang("mail_im_X_message_deleted","raw")),peer:e,spam_id:r}))}function w(e,t,n){var r=(0,Y.showFlushDialog)(t,function(a){n().updateMenu(e),(0,Y.cleanHistory)(e,r,n,K.flushHistory,t)})}function S(e,t,n,r,a,i){var s=gpeByClass("_im_dialog",i,n);if(s){var o=intval(domData(s,"peer"));if(t.get().recentSearch){var l=(0,K.removeFromRecentSearch)(o,cur.imDb);return re(s),cancelEvent(a),0===l.length&&U(t,r,e),!1}var u=(0,Y.isCommunityPeer)(o)||(0,Y.isUserPeer)(o);(0,Y.isClassicInterface)(t)&&u?(0,K.deleteDialog)(o,t.get()).then(function(n){var r=W(n,2),a=r[0],i=r[1];a?(E(o,s,a,i,t),e().updateMenu(t)):w(t,o,e)}):w(t,o,e)}return cancelEvent(a),!1}function T(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=u(e,t.peerId,t,(0,Y.isClassicInterface)(e)),a=r.photo,i=r.userLink,s=c(e),o=""===n?[]:[n];return(0,Q.isRecentSearchesActive)(e)&&o.push("nim-dialog_recent"),(0,Y.isClassicInterface)(e)&&o.push("nim-csr_classic"),inArray(t.peerId,e.get().mutedPeers)&&o.push("nim-dialog_muted"),getTemplate("im_conversation_search_row",{peer:t.peerId,msg_id:t.lastmsg||"",photo:a,user_link:i,unread:(0,Y.simplifyCounter)(t.unread),tab_name:stripHTML(t.tab),is_unread:_(t)?"nim-dialog_unread":"",is_online:onlinePlatformClass(t.online),is_selected:t.peerId==e.get().peer&&s?"nim-dialog_selected _im_dialog_selected":"",more:o.join(" ")})}function k(e,t){return!e.get().unread_only||t.unread>0}function I(e,t){switch(t.type){case"sep_btn_search_msg":return(0,Y.renderBtnSearchOnlyMessages)(e);case"sep_messages":return(0,Y.renderMessagesSep)();case"sep_conversations":return(0,Y.renderConversationsSep)();case"sep_popular":return(0,Y.renderPopularSuggSep)();case"popular_sugg":return(0,Y.renderPopularSuggestions)(e);case"email_create":var n={peerId:t.peerId,lastmsg:-1,photo:"/images/contact_2x.png",online:"",type:t.type,name:t.query,tab:t.query};return T(e,n,"_im_create_email");case"clear_recent":return(0,Y.renderClearRecent)();case"empty_dialogs":return getTemplate("im_dialogs_none",{msg:getLang("mail_dialogs_list_empty")});case"empty":return getTemplate("im_dialogs_none",{msg:getLang("mail_im_search_empty")});default:return t.message?p(e,t,t.message,{noselect:!0,search:!0}):t.local_index||(0,Q.isSearching)(e)?T(e,t):p(e,t)}}function P(e,t,n,r,a,i){var s=intval(domData(i,"peer")),o=domData(i,"action"),l=domData(i,"sid"),u=geByClass1("_im_dialog_"+s,t),c=intval(domData(i,"spam"));switch(o){case"restore":u&&e.set(K.restoreDialog.bind(null,s,l,c)).then(function(){addClass(u,"_im_dialog"),removeClass(u,"nim-dialog_deleted"),v(u,e.get().tabs[s],e,t,!1),r().updateMenu(e)});break;case"spam":var d=getLang("mail_im_dialog_marked_spam")+'\n        <button type="button" class="nim-dialog--daction nim-dialog--daction_last _im_dialog_daction"\n          data-action="restore"\n          data-spam="1"\n          data-sid="'+l+'" data-peer="'+s+'">\n            '+getLang("mail_restore")+"\n        </button>";if(u){var g=geByClass1("_dialog_body",u);val(g,d),(0,K.spamDialog)(s,l,e.get())}break;case"block":var m=void 0;m=(0,Y.isCommunityInterface)(e)?(0,Y.showBlacklistBox)(s,e):(0,Y.showBlacklistBoxUser)(s,e),m.once("success",function(){e.set(K.flushHistory.bind(null,s)).then(function(){n().restoreDialogs(e)})})}cancelEvent(a)}function M(e,t){return e.map(function(e){return(0,te.addMessageEvent)([4].concat(e))}).map(function(e){return extend({},t[e.peerId],{message:e})})}function L(e){return{type:"empty",lang:e}}function A(e,t,n){return(0,Y.isClassicInterface)(n)||t().toggleSettingsLoader(n,!0),e.checkMore(!(0,Y.isClassicInterface)(n)).then(function(){(0,Y.isClassicInterface)(n)||t().toggleSettingsLoader(n,!1)})}function D(e,t){var n=e.get().msg_local_ids_sort&&e.get().msg_local_ids_sort[t.lastmsg];return"undefined"!=typeof n?2e9+n:t.lastmsg}function O(e,t,n,r){var a=gpeByClass("_im_dialog",r,t),i=intval(domData(a,"peer"));return e.set(K.toggleDialogImportant.bind(null,i)),setTimeout(function(){R(e,t,n,r)},100),cancelEvent(n),!1}function x(e,t,n){var r=void 0;return t.message&&n.message?(r=n.message.messageId-t.message.messageId,r=(0,Y.isReversedDialogs)(e)?-r:r):t.message&&!n.message?r=1:n.message&&!t.message?r=-1:(r=D(e,n)-D(e,t),r=(0,Y.isReversedDialogs)(e)?-r:r),r}function R(e,t,n,r){var a=r.getBoundingClientRect().top;showTooltip(r,{text:function(){var n=gpeByClass("_im_dialog",r,t),a=domData(n,"peer");return e.get().tabs[a].folders&ne.FOLDER_IMPORTANT?getLang("mail_im_toggle_important_off"):getLang("mail_im_toggle_important")},black:1,zIndex:1,shift:[14,8],toup:(0,Q.isSearching)(e)?a>190:a>150})}function B(e,t){var n=t.unread>0?getLang("mail_im_new_messages",t.unread):"",r=geByClass1("_im_unread_blind_label",e);val(r,n)}function F(e,t,n,r,a){var i=gpeByClass("_im_dialog",a,t),s=intval(domData(i,"peer")),o=e.get().tabs[s].lastmsg;return e.set(K.markDialogAnswered.bind(null,s,o)).then(function(){v(i,e.get().tabs[s],e,t),(0,Q.isRecentSearchesActive)(e)||n().restoreDialogs(e)}),showDoneBox(getLang("mail_marked_as_answered"),{out:1e3}),cancelEvent(r),!1}function N(e){var t=42,n=60,r=45,a=37,i=(0,Q.isSearching)(e),s=e.get().searchOnlyMessages;return(0,Y.isClassicInterface)(e)?{top:i&&!s?n+a-1:n,bottom:(0,Y.isCommunityInterface)(e)?t:t+r}:{top:i&&!s?a-1:0,bottom:0}}function H(e,t){e.hoverFirstElement(de,N(t))}function j(e){e.unhoverElements(de)}function U(e,t,n){if((0,Q.doPopularSuggExist)(e)){var r=[{type:"sep_popular"},{type:"popular_sugg"}];t.pipeReplace(Promise.resolve(r)),t.toTop()}else n().cancelSearch(e),cancelStackFilter("im_search")}function G(e,t,n,r,a){return{selectPeer:function(t,n){for(var r=geByClass("_im_dialog",e),a=n.get().peer,i=0;i<r.length;i++){var o=r[i],l=intval(domData(o,"peer")),u=intval(domData(o,"msgid"));l===a&&(!s(o)||t===u&&s(o))?(addClass(o,"nim-dialog_selected"),addClass(o,"_im_dialog_selected")):hasClass(o,"_im_dialog_selected")&&(removeClass(o,"nim-dialog_selected"),removeClass(o,"_im_dialog_selected"))}},appendFastDialogs:function(t,r,a){removeClass(e.parentNode,"im-page--dialogs_with-mess"),n.saveScroll("list"),a?(n.reset(),(0,Y.isPendingForward)(t)||(0,Q.isRecentSearchesActive)(t)||!(0,X.doesSearchResultContainConversations)(r)?(0,Q.isRecentSearchesActive)(t)&&((0,X.doesSearchResultContainConversations)(r)&&(r=[{type:"clear_recent"}].concat(r)),(0,Q.doPopularSuggExist)(t)&&(r=[{type:"sep_popular"},{type:"popular_sugg"}].concat(r))):r=[{type:"sep_btn_search_msg"},{type:"sep_conversations"}].concat(r),t.setState({searchOnlyMessages:!1}),n.pipeReplace(Promise.resolve(r)).then(function(){return H(n,t)})):n.pipe(Promise.resolve(r)),(!(0,Y.isClassicInterface)(t)||(0,Y.isReservedPeer)(t.get().peer))&&n.toTop()},deactivate:function(){n.deactivate()},activate:function(){n.activate()},hoverFirstDialog:function(e){H(n,e)},hoverNextDialog:function(e){n.hoverNextElement(de,ce,N(e))},hoverPrevDialog:function(e){n.hoverPrevElement(de,ce,N(e))},unhoverDialogs:j.bind(n),selectHoveredDialog:function(t){var a=geByClass1("_im_dialog_hovered",e);a||(a=geByClass1("_im_dialog",e)),a&&l(r,t,n,{},a)},appendSearch:function(t,r,a){var i=M(a,r);a.length>0?(addClass(e.parentNode,"im-page--dialogs_with-mess"),n.pipe(Promise.resolve([{type:"sep_messages"}].concat(i))).then(function(){return H(n,t)})):(0===n.getCurrentElements().length&&n.pipeReplace(Promise.resolve([L()])),removeClass(e.parentNode,"im-page--dialogs_with-mess"))},updateDialog:function(t,n){var r=geByClass1("_im_dialog_"+t);r&&!s(r)&&v(r,n.get().tabs[t],n,e)},focusOnSelected:function(e){var t=e.get().peer;if(t){var r=geByClass1("_im_dialog_"+t);r?n.scrollTop(r.offsetTop-r.offsetHeight):n.toTop()}},restoreScroll:function(e){var t=n.restoreScroll("list");t||n.toTop()},restoreDialogs:function(t,a,i){removeClass(e.parentNode,"im-page--dialogs_with-mess"),t.setState({searchOnlyMessages:!1}),0!==q(t).length||n.isLoading()||(a=!0),a&&n.reset(),i&&n.wipe(),n.pipeReplace(Promise.resolve(q(t))).then(function(e){if(a&&(!(0,Y.isClassicInterface)(t)||!t.get().peer)){var i=A(n,r,t);return n.toTop(),i}}).then(function(){return j(n)})},appendDialogs:function(t,r){removeClass(e.parentNode,"im-page--dialogs_with-mess"),r.forEach(function(n){var r=geByClass1("_im_dialog_"+n.peerId,e);r&&b(r,n,t)}),(0,Y.isPendingForward)(t)||(0,Q.isRecentSearchesActive)(t)||!(0,X.doesSearchResultContainConversations)(r)||(r=[{type:"sep_btn_search_msg"},{type:"sep_conversations"}].concat(r)),t.setState({searchOnlyMessages:!1}),n.isEmpty()&&0===r.length&&(0,Y.isPendingForward)(t)&&(r=[L(getLang("mail_im_search_empty_chats"))]),n.replacePreserveOrder(r)},updateCounter:function(t,n){var r=geByClass1("_im_dialog_"+n,e),a=(0,Q.getTab)(t,n);if(r&&!s(r)&&(B(r,a),val(geByClass1("_im_dialog_unread_ct",r),(0,Y.simplifyCounter)(a.unread)),toggleClass(r,"nim-dialog_unread",a.unread>0),toggleClass(r,"nim-dialog_unread-out",f(t,a,a.lastmsg_meta.flags))),(0,Q.isRecentSearchesActive)(t)){var i=geByClass1("_im_sugg_"+n);i&&(val(geByClass1("_sugg_unread_ct",i),(0,Y.simplifyCounter)(a.unread)),toggleClass(i,"sugg-is_unread",a.unread>0))}},removeDialog:function(e,t){n.remove(t)},updateOnline:function(t,n){var r=geByClass1("_im_dialog_"+t,e);if(r){var a=n.get().tabs[t],i=geByClass1("_im_peer_online",r);toggleOnline(i,a.online)}},setDialogFailed:function(t,n,r){var a=geByClass1("_im_dialog_"+t,e);if(a){var i=r.get().tabs[t];i.lastmsg===n&&(addClass(a,"nim-dialog_failed"),val(geByClass1("_im_dialog_unread_ct",a),"!"))}},scrollUp:function(e){n.toTop(e),n.saveScroll("list",!0)},saveScroll:function(e){n.saveScroll("list",!0)},promoteDialog:function(r,a){var i=geByClass1("_im_dialog_"+a.peerId,e);if((!i||s(i))&&(0,Q.isSearching)(r))return void n.unsetScroll("list");var o=r.get().tabs[a.peerId];k(r,o)&&(n.pipeReplace(Promise.resolve(q(r)),void 0,!0).then(function(t){!inArray(a.peerId,t)&&i&&v(i,r.get().tabs[a.peerId],r,e)}),t().updateTyping(a,r))},removeSelection:function(t){var r=t.get().peer.toString(),a="._im_dialog_"+r+"."+ce.join("."),i=domQuery(a,e)[0];ce.forEach(function(e){return removeClass(i,e)}),(0,Y.isClassicInterface)(t)||n.hoverElement(r,de,N(t))},updateScroll:function(){n.updateScroll()},updateTyping:function(t,n){var r=geByClass1("_im_dialog_"+t.peerId,e);if(r&&!s(r)&&!n.get().tabs[t.peerId].deletedDialog){var a=geByClass1("_im_dialog_typing",r),i=!(0,Y.isClassicInterface)(n),o=(0,Y.formatTyper)(n.get().tabs[t.peerId].typing,t.peerId,!0,n.get(),1,i);val(a,o),toggleClass(r,"nim-dialog_typing",o)}},unmount:function(){n.unmount(),(0,ae.destroyModule)(a)}}}function q(e){var t=e.get().active_tab,n=e.get().dialog_tabs[t],r=e.get().tabs;return n.map(function(e){return r[e]}).sort(x.bind(null,e))}function z(e,t){return t.message?t.message.messageId:(0,Q.isSearching)(e)&&t.peerId?t.peerId+"cr":t.peerId||t.type}function V(e,t,n){var r=(0,ae.createMutations)(G),a=r.callMutations,s=r.bindMutations,u=function(e,n){var r=n.getBoundingClientRect().top;showTooltip(n,{text:function(){return(0,Q.isRecentSearchesActive)(t)?getLang("mail_hide_from_recent"):getLang("mail_delete")},black:1,center:!0,shift:(0,Y.isClassicInterface)(t)?[-4,10]:[2,10],toup:r>150||(0,Q.isSearching)(t),zIndex:1})},c=function(e,t){var n=t.getBoundingClientRect().top;showTooltip(t,{text:getLang("mail_end_conversation"),black:1,center:!0,zIndex:1,shift:[1,4],toup:n>150})},d=R.bind(null,t,e),g=O.bind(null,t,e),m=F.bind(null,t,e,a),f=geByClass1("_im_dialogs_search"),_={idFn:function(e){return z(t,e)},hoverableFn:function(e){return hasClass(e,"_im_dialog")},renderFn:I.bind(null,t),more:o.bind(null,t,a),onScroll:(0,Y.isClassicInterface)(t)?function(){var e=bodyNode.scrollTop||document.documentElement.scrollTop;0>=e&&!layers.visible&&browser.safari?addClass(f,"im-page--header_static"):removeClass(f,"im-page--header_static")}:!1},p=(0,ee.mount)(e,(0,Z["default"])({limit:40,offset:0,nativeScroll:!!(0,Y.isClassicInterface)(t),height:oe,elements:q(t)}),function(){return _}),h=l.bind(null,n,t,p),v=i.bind(null,t,e,p),b=P.bind(null,t,e,a,n),y=S.bind(null,n,t,e,p),C=(0,ae.createModule)({handlers:function(r,a){a(e,"click","_im_dialog_close",y),a(e,"click","_im_dialog_markre",m),a(e,"click",le,g),a(e,"click","_im_dialog",h),a(e,"click",Y.MESSAGE_SEARCH_CLASS,v),a(e,"mouseover","_im_dialog_close",u),a(e,"mouseover","_im_dialog_markre",c),a(e,"click",Y.CLEAR_RECENT_CLASS,function(){(0,K.resetRecentSearch)(cur.imDb),U(t,p,n)}),a(e,"mouseover",le,d),a(e,"click",ue,b),r(e,"mouseover",throttle(p.unhoverElements.bind(p,de),100))}});return s(e,a,p,n,C)}Object.defineProperty(t,"__esModule",{value:!0});var W=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=V;var K=n(107),Y=n(41),Q=n(86),X=n(110),J=n(27),$=n(89),Z=a($),ee=n(101),te=n(74),ne=r(te),ae=n(100),ie=n(37),se=n(90),oe=64,le="_im_dialog_star",ue="_im_dialog_daction",ce=["_im_dialog_selected","nim-dialog_selected"],de=["_im_dialog_hovered","nim-dialog_hovered"]},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t){var n=e.exports={version:"2.2.1"};"number"==typeof __e&&(__e=n)},function(e,t){function n(){u=!1,s.length?l=s.concat(l):c=-1,l.length&&r()}function r(){if(!u){var e=setTimeout(n);u=!0;for(var t=l.length;t;){for(s=l,l=[];++c<t;)s&&s[c].run();c=-1,t=l.length}s=null,u=!1,clearTimeout(e)}}function a(e,t){this.fun=e,this.array=t}function i(){}var s,o=e.exports={},l=[],u=!1,c=-1;o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new a(e,t)),1!==l.length||u||setTimeout(r,0)},a.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=i,o.addListener=i,o.once=i,o.off=i,o.removeListener=i,o.removeAllListeners=i,o.emit=i,o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t,n){"use strict";function r(e,t,n,r,a){var i=52,s=105+((0,p.isPinnedMessageVisibleInTab)(e,(0,m.getPeer)(e))?i:0);showTooltip(t,{shift:[n,10],black:1,className:"_im_history_tooltip "+r,appendParentCls:"_im_mess_stack",toup:t.getBoundingClientRect().top>s+37,text:a})}function a(e,t,n){var r=gpeByClass("_im_mess",n),a=intval(domData(r,"msgid")),s=e.get().peer,o=(0,m.getMessage)(e,s,a),l=!(0,g.isImportant)(o);return e.get().longpoll.push([{peerId:s,messageId:a,type:l?_.SET_FLAGS:_.RESET_FLAGS,flags:_.FLAG_IMPORTANT}]),e.set(c.favMessage.bind(null,[a],l,s)),i(e,-10,t,n),!1}function i(e,t,n,a){var i=getLang("mail_im_toggle_important").length>14;
r(e,a,i?86:34,i?"im-star-tt_long":"im-star-tt",function(){var t=domData(gpeByClass("_im_mess",a),"msgid"),n=(0,m.getMessage)(e,e.get().peer,t);return n?(0,g.isImportant)(n)?getLang("mail_im_unmark_important"):getLang("mail_im_toggle_important"):""})}function s(e,t,n){var r=e.get().peer,a=+domData(domClosest("im-mess",n.target),"msgid");return Promise.all((0,c.processFwd)([a],r,e)).then(function(t){return e.set(c.forwardMessages.bind(null,t,r,cur.imDb))}).then(function(){return t().respond(e,r)}),!1}function o(e,t,n,a){r(e,a,18,"im-reply-tt",getLang("mail_im_reply"))}function l(e,t){return{markImportant:function(t,n,r){(0,d.updateStar)(t,n,e)},unmount:function(){(0,f.destroyModule)(t)}}}function u(e,t,n){var r=i.bind(null,t,0),u=a.bind(null,t),c=o.bind(null,t,0),d=s.bind(null,t,n),g=(0,f.createModule)({handlers:function(t,n){n(e,"click",h,u),n(e,"mouseover",h,r),n(e,"click",v,d),n(e,"mouseover",v,c)}});return l(e,g)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=u;var c=n(107),d=n(41),g=n(15),m=n(86),f=n(100),_=n(74),p=n(119),h="_im_mess_fav",v="_im_mess_reply"},function(e,t){"use strict";Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e,t){for(var n=0;n<this.length;++n)if(e.call(t,this[n],n,this))return n;return-1}}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e,t){for(var n=0;n<this.length;++n)if(e.call(t,this[n],n,this))return this[n]}})},function(e,t,n){"use strict";function r(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}function a(e,t,n,a,i){if(!(0,u.isSearchingInplace)(e.get().peer,e.get())&&!(hasClass(i,l.FAILED_CLASS)||hasClass(i,l.SENDING_CLASS)||hasClass(i,"_im_mess_srv")||(0,l.checkSelectClick)(a,i)||"A"===a.target.tagName)){var s=intval(domData(i,"msgid")),o=e.get().peer,d=e.get().tabs[o].deleted||[];if(!inArray(s,d)){var g=void 0;g=a.shiftKey?(0,c.getMessageRangeFromSelection)(e,o,s):[s],e.set(u.addSelection.bind(null,g)).then(function(){var a=(0,c.getSelectedMessages)(e),i=!1;g.forEach(function(e){var t=geByClass1("_im_mess_"+e,n);if(t){var r=inArray(e,a);i|=r,toggleClass(t,"im-mess_selected",r);var s=void 0;s=r?getLang("mail_deselect_message"):getLang("mail_select_message");var o=geByClass1("_im_mess_blind_label_select",t);attr(o,"aria-label",s)}}),i&&r(),t().changedMessageSelection(e)})}}}function i(e,t){return{cleanSelection:function(t){t.map(function(t){return geByClass1("_im_mess_"+t,e)}).filter(function(e){return e}).forEach(function(e){return removeClass(e,"im-mess_selected")})},unmount:function(){(0,o.destroyModule)(t)}}}function s(e,t,n){var r=a.bind(null,t,n,e),s=(0,o.createModule)({handlers:function(t,n){n(e,"click","_im_mess",r)}});return i(e,s)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=s;var o=n(100),l=n(41),u=n(107),c=n(86)},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t,n,r){if(!e.loading&&!e.all){var a=n.scrollTop+window.innerHeight-n.scrollHeight;if(a>-300){var i=geByClass1("_im_peer_history",t.bodyNode);e.loading=!0,(0,d.wrapLoading)(i)((0,l.loadImportant)(e.offset).then(function(t){var n=o(t,4),a=(n[0],n[1]),s=(n[2],n[3]);e.all=s.all,e.offset=s.offset,e.all?addClass(i,"im-important_all"):e.loading=!1,r.set(l.mergeTabs.bind(null,(0,d.tabFromIds)(s.msgs,s.hash)));var u=ce("div");u.innerHTML=a,i.appendChild(u)}),"bottom")}}}function i(e,t,n){for(var r=arguments.length,a=Array(r>3?r-3:0),i=3;r>i;i++)a[i-3]=arguments[i];a.filter(function(e){return inArray(e.type,[_.SET_FLAGS,_.RESET_FLAGS,_.CHANGE_PEER])}).forEach(function(r){if(r.type===_.CHANGE_PEER)return void n.hide();if(r.flags===_.FLAG_IMPORTANT){var a=r.type===_.SET_FLAGS;e.set(l.updateFavMessage.bind(null,[r.messageId],0,a)).then(function(n){t.markImportant(r.messageId,a,e)})}})}function s(e,t,n,r){var s=ge("box_layer_wrap"),o=t.get().longpoll,l=(0,m["default"])({peer:0,longpoll:o,oCache:{},tabs:(0,d.tabFromIds)(r.msgs,r.hash)}),g=(0,c.mount)(e.bodyNode,l,function(){return{}}),_=(0,u.mount)(e.bodyNode,t),p=i.bind(null,t,g,e);o.on("data",p);var h=a.bind(null,{all:!1,loading:r.all,offset:r.offset},e,s,l),v=(0,f.createModule)({handlers:function(e,t){e(s,"scroll",h)}});return{unmount:function(){(0,f.destroyModule)(v),_.unmount(),g.unmount(),o.off("data",p)}}}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=s;var l=n(107),u=n(110),c=n(48),d=n(41),g=n(89),m=r(g),f=n(100),_=n(74)},function(e,t,n){"use strict";function r(e,t,n,r){var a='<td class="im_cal_clear" colspan="7"><button type="button" class="im_cal_clear_lnk _im_clear_date">'+getLang("wall_clear_date_filter")+"</button></td>";return new Promise(function(e){stManager.add(["ui_controls.js","datepicker.js","datepicker.css"],function(){var t=new Datepicker(n,{width:140,resfmt:"plain",addRows:'<tr id="im_day_clear">'+a+"</tr>",addRowsM:'<tr id="im_month_clear">'+a+"</tr>",onUpdate:r});e(t)})})}function a(e,t,n,r,a){return{focus:function(e){uiSearch.focus(t),l(e,t,n,r)},changePeer:function(e,n){uiSearch.getFieldEl(t).value=n.get().tabs[e].searchText||""},unmount:function(){(0,f.destroyModule)(a),cancelStackFilter(_),r.then(function(e){return e.destroy()})}}}function i(e,t,n,r){e.set(m.setCurrentSearchDate.bind(null,e.get().peer,r.d+"."+r.m+"."+r.y)).then(o.bind(null,e,t,n))}function s(e,t){e.then(function(e){triggerEvent(geByClass1("datepicker_control",t),"mousedown",!1,!0)})}function o(e,t,n){e.get().peer;uiSearch.showProgress(n),(0,m.searchMessagesInplace)(e.get().peer,e.get()).then(function(r){uiSearch.hideProgress(n),t().insertSearch(r,e)})["catch"](function(e){uiSearch.focus(n),uiSearch.hideProgress(n)})}function l(e,t,n,r){cancelStackPush(_,c.bind(null,e,t,n,r))}function u(e,t,n,r,a,i){if("keyup"!==i.type||13==i.which){var s=clean(uiSearch.getFieldEl(t).value);e.set(m.setCurrentSearch.bind(null,s,e.get().peer)).then(a.bind(null,e,r,t))}}function c(e,t,n,r){cancelStackFilter(_),r.then(function(e){e.hide()}),e.set(m.cancelSearch.bind(null,e.get().peer)).then(function(){uiSearch.getFieldEl(t).value="",n().cancelSearch(e)})}function d(e,t,n,r){n.then(function(e){e.hide()}),e.set(m.clearDate.bind(null,e.get().peer)).then(o.bind(null,e,t,r))}function g(e,t,n){var l=geByClass1(h,e),g=geByClass1(v,e),m=i.bind(null,t,n,g),_=r(t,e,l,m),E=s.bind(null,_,e),w=u.bind(null,t,g,l,n,debounce(o,300)),S=c.bind(null,t,g,n,_),T=d.bind(null,t,n,_,g),k=(0,f.createModule)({handlers:function(t,n){t(geByClass1(p,e),"click",E),t(uiSearch.getFieldEl(g),"keyup",w),t(geByClass1(b,e),"click",w),t(geByClass1(y,e),"click",S),n(e,"click",C,T)}});return a(e,g,n,_,k)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=g;var m=n(107),f=n(100),_="im_hist_search",p="_im_search_date",h="_im_search_date_input",v="_im_search_history_input",b="_im_start_inplace_search",y="_im_cancel_inplace_search",C="_im_clear_date"},function(e,t,n){var r=n(45);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t,n){"use strict";var r=n(69).f,a=n(83),i=(n(9),n(88)),s=n(10),o=n(108),l=n(68),u=n(75),c=n(35),d=n(30),g=n(117),m=n(124),f=n(79).fastKey,_=m?"_s":"size",p=function(e,t){var n,r=f(t);if("F"!==r)return e._i[r];for(n=e._f;n;n=n.n)if(n.k==t)return n};e.exports={getConstructor:function(e,t,n,c){var d=e(function(e,r){o(e,d,t,"_i"),e._i=a(null),e._f=void 0,e._l=void 0,e[_]=0,void 0!=r&&u(r,n,e[c],e)});return i(d.prototype,{clear:function(){for(var e=this,t=e._i,n=e._f;n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=void 0),delete t[n.i];e._f=e._l=void 0,e[_]=0},"delete":function(e){var t=this,n=p(t,e);if(n){var r=n.n,a=n.p;delete t._i[n.i],n.r=!0,a&&(a.n=r),r&&(r.p=a),t._f==n&&(t._f=r),t._l==n&&(t._l=a),t[_]--}return!!n},forEach:function(e){o(this,d,"forEach");for(var t,n=s(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.n:this._f;)for(n(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!p(this,e)}}),m&&r(d.prototype,"size",{get:function(){return l(this[_])}}),d},def:function(e,t,n){var r,a,i=p(e,t);return i?i.v=n:(e._l=i={i:a=f(t,!0),k:t,v:n,p:r=e._l,n:void 0,r:!1},e._f||(e._f=i),r&&(r.n=i),e[_]++,"F"!==a&&(e._i[a]=i)),e},getEntry:p,setStrong:function(e,t,n){c(e,t,function(e,t){this._t=e,this._k=t,this._l=void 0},function(){for(var e=this,t=e._k,n=e._l;n&&n.r;)n=n.p;return e._t&&(e._l=n=n?n.n:e._t._f)?"keys"==t?d(0,n.k):"values"==t?d(0,n.v):d(0,[n.k,n.v]):(e._t=void 0,d(1))},n?"entries":"values",!n,!0),g(t)}}},function(e,t,n){var r=n(18),a=n(116).set;e.exports=function(e,t,n){var i,s=t.constructor;return s!==n&&"function"==typeof s&&(i=s.prototype)!==n.prototype&&r(i)&&a&&a(e,i),e}},function(e,t,n){"use strict";var r=n(83),a=n(127),i=n(120),s={};n(9)(s,n(66)("iterator"),function(){return this}),e.exports=function(e,t,n){e.prototype=r(s,{next:a(1,n)}),i(e,t+" Iterator")}},function(e,t,n){var r=n(129),a=n(29),i=n(28)("IE_PROTO"),s=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=a(e),r(e,i)?e[i]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?s:null}},function(e,t,n){"use strict";function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"im_settings";return getTemplate(e,{sound:ls.get("sound_notify_off")?getLang("mail_im_sound_off"):getLang("mail_im_sound_on"),browser:i()?getLang("mail_im_notifications_on"):getLang("mail_im_notifications_off")})}function a(e,t){showTooltip(t.target,{content:r("im_settings_pop"),dir:"down",shift:[220,9],hasover:!0,showdt:300})}function i(){return DesktopNotifications.supported()&&!DesktopNotifications.checkPermission()&&!ls.get("im_ui_notify_off")}function s(e,t,n,a,s){var o=domData(s,"action"),l=gpeByClass("_im_settings_menu",s),u=hasClass(l,"_im_settings_popup")?"im_settings_pop":"im_settings";switch(o){case"spam":(0,g.showSpamLayer)(e,c.mount,a);break;case"sound":ls.get("sound_notify_off")?ls.set("sound_notify_off",0):ls.set("sound_notify_off",1),l.outerHTML=r(u);break;case"browser":var d=i();d?(ls.set("im_ui_notify_off",1),l.outerHTML=r(u)):DesktopNotifications.checkPermission()?DesktopNotifications.requestPermission(function(){l.parentNode&&(l.outerHTML=r(u))}):(ls.set("im_ui_notify_off",0),l.outerHTML=r(u))}}function o(e,t){return{updateFilter:function(t){var n,r=t.get().active_tab===m.FOLDER_UNREAD;n=t.get().unread_cnt>0?getTemplate("im_filter",{filter:r?getLang("mail_to_all_dialogs"):getLang("mail_to_unread"),cls:""}):getTemplate("im_filter",{filter:getLang("mail_all_dialogs"),cls:"im-page--dialogs-filter_disabled"}),val(geByClass1(p,e),n)},toggleLoader:function(t,n){var r=geByClass1(f,e);toggleClass(r,"im-page--dialogs-settings_loading",n)},updateSettings:function(t){var n=geByClass1("_im_settings_menu",e);n.outerHTML=r()},unmount:function(){(0,u.destroyModule)(t)}}}function l(e,t,n){var r=a.bind(null,t),i=s.bind(null,t,n,e),l=function(e,r){if((0,g.showUnreadOnly)(t,n,d.changeDialogsTab)){var a=t.get().active_tab===m.FOLDER_UNREAD;val(r,getTemplate("im_filter",{filter:a?getLang("mail_to_all_dialogs"):getLang("mail_to_unread")}))}},c=(0,u.createModule)({handlers:function(t,n){n(e,"mouseover",f,r),n(e,"click",_,i),n(e,"click",p,l)}});return o(e,c)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=l;var u=n(100),c=n(99),d=n(107),g=n(41),m=n(27),f="_im_dialogs_cog_settings",_="_im_settings_action",p="_im_to_unread"},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e){var t=c.get(e.currentTarget);if(t){var n=t[e.type];if(n)for(var r,a=0;a<n.length;a++){var i,s=o(n[a],2),l=s[0],u=s[1];if(hasClass(e.target,l)?i=u(e,e.target):(r=gpeByClass(l,e.target,e.currentTarget))&&(i=u(e,r)),i===!1)break}}}function i(e,t,n,r){var i=c.get(e);i||(c.set(e,{}),i=c.get(e));for(var s=t.split(" "),o=0;o<s.length;o++){var l=s[o];i[l]||(i[l]=[],addEvent(e,l,a)),i[l].push([n,r])}}function s(e,t,n,r){var i=c.get(e);if(i){var s=(t.split(" ").forEach(function(t){i[t]&&(i[t]=i[t].filter(function(e){return e[0]!==n||e[1]!==r}),0===i[t].length&&removeEvent(e,t,a))}),Object.keys(i).map(function(e){return i[e].length}).reduce(function(e,t){return e+t}));0===s&&c["delete"](e)}}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.addDelegateEvent=i,t.removeDelegateEvent=s;var l=n(106),u=r(l),c=new u["default"]},function(e,t,n){var r=n(97),a=n(64),i=n(111);e.exports=function(e){return function(t,n,s){var o,l=r(t),u=a(l.length),c=i(s,u);if(e&&n!=n){for(;u>c;)if(o=l[c++],o!=o)return!0}else for(;u>c;c++)if((e||c in l)&&l[c]===n)return e||c;return!e&&-1}}},function(e,t,n){"use strict";function r(e,t){var n=domData(t,"chat-id"),r=domData(t,"hash");return lockButton(t),(0,s.joinChat)(n,r,e.get()).then(function(n){var r=i(n,1),a=r[0];unlockButton(t),e.get().longpoll.push([(0,l.changePeer)(a)])})["catch"](function(e){showFastBox(getLang("mail_join_invite_error_title"),e),unlockButton(t)})}function a(e,t){var n=(0,o.createModule)({handlers:function(n,a){a(e,"click",u,function(e){return r(t,e.target)})}});return{unmount:function(){(0,o.destroyModule)(n)}}}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=a;var s=n(107),o=n(100),l=n(74),u="_im_join_chat"},function(e,t,n){"use strict";function r(e){return{unmount:function(){(0,i.destroyModule)(e)}}}function a(e,t,n){var a=(0,i.createMutations)(r),s=(a.callMutations,a.bindMutations),o=(0,i.createModule)({handlers:function(e,t){}});return s(o)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=a;var i=n(100)},function(e,t){e.exports={}},function(e,t,n){var r=n(94),a=Math.min;e.exports=function(e){return e>0?a(r(e),9007199254740991):0}},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function a(e){return e&&e.__esModule?e:{"default":e}}function i(e){var t=e.updates;return t.map(function(e){switch(e[0]){case 0:return C.deleteEvent(e);case 1:return C.replaceFlagsEvent(e);case 2:return C.setFlagsEvent(e);case 3:return C.resetFlagsEvent(e);case 4:return C.addMessageEvent(e);case 5:return C.editMessageEvent(e);case 6:return C.readInboundEvent(e);case 7:return C.readOutboundEvent(e);case 8:return C.gotOnlineEvent(e);case 9:return C.gotOfflineEvent(e);case 10:return C.resetDirectoriesEvent(e);case 11:return C.replaceDirectoriesEvent(e);case 12:return C.setDirectoriesEvent(e);case 13:return C.deleteDialogEvent(e);case 51:return C.chatChangedEvent(e);case 61:return C.typingUserEvent(e);case 62:return C.typingChatEvent(e);case 70:return C.videoCallEvent(e);case 80:return C.unreadCountEvent(e);case 114:return C.notifySettingsChangedEvent(e);case-1:return C.resyncEvent();default:return C.emptyEvent(e)}})}function s(e,t){return Promise.resolve(extend({},t,{timeout:64>e?2*e:e}))}function o(e,t){return Promise.resolve(extend({},t,{imTs:e}))}function l(e){e.set(function(e){return Promise.resolve(extend({},e,{stopped:!0}))}).then(function(){e.get().cancelToken()})}function u(e,t){return t.cancelToken=e,Promise.resolve(t)}function c(e,t){return t.pauses||(t.pauses=[]),t.pauses.push(e),Promise.resolve(t)}function d(e){return e.pauses||(e.pauses=[]),(0,S.lplog)("Aborting all pauses","error"),e.pauses.forEach(function(e){return e()}),e.pauses=[],Promise.resolve(e)}function g(e,t,n,r){if(r.failed)var a=(0,E.abortablePause)(k,e),i=a.abort,s=a.pause;switch(r.failed){case 1:return(0,S.lplog)("Old timestamp, init resync","error"),e.set(c.bind(null,i)),n([C.resyncEvent()]),e.set(p.loadLongPollTs).then(s).then(m.bind(null,e,t,n));case 2:return(0,S.lplog)("Key is incorrect","error"),e.set(c.bind(null,i)),e.set(p.loadLongPollKey).then(s).then(m.bind(null,e,t,n));case 3:throw nav.reload({force:!0}),new Error("ts is very wrong");default:return e.set(o.bind(null,r.ts)).then(function(){return r})}}function m(e,t,n){if(e.get().stopped)return Promise.resolve({updates:[]});if(t())return Promise.reject(new Error("pause"));var r=e.get(),a=r.imUrl+"/"+r.imPart,i=(0,b.plaingetCancelable)(a,{act:"a_check",key:r.imKey,version:I,ts:r.imTs,wait:25,mode:r.mode}),o=i.request,l=i.cancel;return e.set(u.bind(null,l)).then(function(){return o}).then(function(t){return e.set(s.bind(null,1)),JSON.parse(t)}).then(g.bind(null,e,t,n))}function f(e,t,n){e.get().stopped||((0,S.lplog)("New request"),m(e,n,t).then(i).then(function(e){return(0,S.lplog)("Request success","success"),e}).then(t)["catch"](function(t){return e.get().stopped?void(0,S.lplog)("Stopped longpoll"):("pause"!==t.message&&topError(t),(0,S.lplog)("Error, waiting: "+(t.message||"no message (probably browser reset)"),"error"),e.set(s.bind(null,n()?k/2:e.get().timeout)).then(function(){var t=(0,E.abortablePause)(e.get().timeout,e),n=t.abort,r=t.pause;return e.set(c.bind(null,n)).then(r)}))}).then(f.bind(null,e,t,n)))}function _(e){var t=e.id,n=e.gid,r=e.key,a=e.ts,i=e.url,s=e.lhost,o="main",u=new EventEmitter,c=(0,w.initQueue)(function(e,t){return u.trigger("data",t),Promise.resolve({})}),g=c.pause,m=c.resume,_=c.pushMessage,p=c.isPaused,h=c.reset,b=(0,v["default"])({id:t,gid:n,mode:T,timeout:1,imKey:r,imTs:a,imPart:i,imUrl:s,pause:!1});return f(b,_.bind(null,o),p.bind(null,o)),{on:u.on.bind(u),off:u.off.bind(u),abortPauses:function(){return b.set(d)},stop:l.bind(null,b),pause:g.bind(null,o),resume:m.bind(null,o),reset:h.bind(null,o),push:function(e){return u.trigger("data",e)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.eventTypes=void 0,t.startLongPoll=_;var p=n(107),h=n(89),v=a(h),b=n(109),y=n(74),C=r(y),E=n(17),w=n(1),S=n(123),T=(t.eventTypes=C,202),k=4,I=2},function(e,t,n){var r=n(76)("wks"),a=n(71),i=n(19).Symbol,s="function"==typeof i;e.exports=function(e){return r[e]||(r[e]=s&&i[e]||(s?i:a)("Symbol."+e))}},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t,n){var r=n.reduce(function(e,t){return e[t.peerId]||(e[t.peerId]=[]),e[t.peerId].push(t.messageId),e},{});Object.keys(r).forEach(function(n){var a=r[n];e.set(ie.removeMessages.bind(null,a,n)).then(function(){t.removeMessages(a,intval(n),e)})})}function s(e,t,n,r){t.set(ie.updateChatPhoto.bind(null,e)).then(function(){var a=e.kludges.source_act;n.updateDialog(e.peerId,t),r.updateChatPhoto(e,a,t)})}function o(e,t,n,r,i,s,o){e.set(ie.updateActions.bind(null,t,r,n)).then(function(){return t===se.CHAT_INVITE_USER?(e.set(ie.chatUserHasJoined.bind(null,n,i,r)),e.set(ie.loadChatMember.bind(null,a({},n,[r]))).then(function(t){return r===vk.id&&e.get().peer===n?e.set(ie.getPinnedMessage.bind(null,n)).then(function(e){return(0,ie.setActions)(e.get())}):Promise.resolve(t)})):(r===vk.id&&e.get().peer===n&&e.set(ie.unpinMessageOptimistic.bind(null,n)),e.set(ie.chatUserHasLeft.bind(null,n,i,r)))}).then(function(){e.get().peer===n&&(o.updateChat(e,n),s.updateDialog(n,e))})}function l(e,t){"spam"===t?(0,se.showSpamLayer)(e,Z.mount,{}):"fav"===t&&(0,se.showFavvedBox)(e,{},le.mount,{})}function u(e,t){if(e.get().gid){var n=t.parentNode,r=geByClass("_im_right_menu_counter",n),a=e.get().dialog_tab_cts;r.forEach(function(e){var t=domData(e,"tab");val(e,a[t]||"")})}}function c(e,t,n,r){e.set(ie.cancelRecording).then(function(e){n.cancelRecording()}),AudioMessagePlayer.detachPlayer(),t.removeSelection(e),removeClass(r,"im-page_history-show"),n.stopLoading();var a=e.get().peer;e.set(ie.changePeer.bind(null,0,!1)).then(function(){window.tooltips&&window.tooltips.hideAll(),E(),(0,se.isClassicInterface)(e)&&t.activate(),n.changePeer(e),(0,se.isClassicInterface)(e)&&t.restoreScroll(e),setTimeout(function(){e.get().longpoll.push([J.transitionEvent("search")])},13),(0,se.isLocksAvailable)(e)&&(0,se.isPeerBlockedByMe)(a,e)&&e.set(ie.releaseBlock.bind(null,a))})}function d(e,t,n,r,a){e.forEach(function(e){var i=e.kludges.source_act,l=intval(e.kludges.source_mid);switch(i){case se.CHAT_PHOTO_REMOVE:case se.CHAT_PHOTO_UPDATE:s(e,t,n,r);break;case se.CHAT_KICK_USER:case se.CHAT_INVITE_USER:o(t,i,e.peerId,l,e.userId,n,r);break;case se.CHAT_TITLE_ACTION:var u=e.kludges.source_text;t.set(ie.setChatTitle.bind(null,e.peerId,u)).then(function(){r.updateChatTopic(e.peerId,t),(0,se.isClassicInterface)(t)&&a.updateName(e.peerId,t)});break;case se.CHAT_PIN_MESSAGE:case se.CHAT_UNPIN_MESSAGE:(0,se.isTabLoaded)(t.get(),e.peerId)&&t.set(ie.getPinnedMessage.bind(null,e.peerId)).then(function(){return(0,me.pinnedMessageUnHide)(t,e.peerId,function(){return r},!1)})}})}function g(e,t){return 2e9>t&&e&&!e.match(/^\s*(Re(\(\d*\))?\:)?\s*\.\.\.\s*$/)}function m(e,t){var n=t.flags&J.FLAG_OUTBOUND,r=inArray(t.peerId,e.get().mutedPeers),a=t.flags&J.FLAG_DELETED,i=e.get().gid;if(!n&&!r&&!a){var s=g(t.subject,t.peerId)||"",o=(s?s+" ":"")+t.text||"",l=t.userId,u=t.peerId,c=void 0,d=void 0,m=e.get().tabs[u];if(t.kludges&&t.kludges.source_act&&(o=stripHTML((0,se.renderServiceMsg)(e,t,m,!1))),(!e.get().notify_msg&&!(0,se.isChatPeer)(u)||i&&!e.get().mute)&&window.Notifier&&Notifier.playSound({author_id:u}),!(0,se.isChatPeer)(u))return;o=trim(replaceEntities(stripHTML(o.replace(/<br>/g,"\n").replace(/<\*>.*$/,"")))),o=(0,W.replaceMentions)(o,function(e,t,n,r,a){return a}),(0,se.isChatPeer)(u)?(c=(0,ce.oCacheGet)(e,l).name,m.tab&&(c+=" » "+m.tab),d=(0,ce.oCacheGet)(e,l).photo):(c=m.tab,d=m.photo);var f=t.attaches[0];if(f&&"fwd"===f.type)o+="\n["+getLang("mail_added_msgs")+"]";else if(f){var _="doc"===f.type&&"graffiti"===f.kind?"graffiti":f.type;o+="\n["+getLang("mail_added_"+_)+"]"}c=trim(replaceEntities(stripHTML((c||"").replace("&nbsp;"," ")))),window.Notifier&&Notifier.proxyIm({id:t.messageId,text:o,author_id:u,title:c,author_photo:d})}}function f(e,t){var n=e.get().longpoll.push.bind(null,[J.resetPeer()]),r=function a(){var r=e.get().selectedMessages;r&&r.length?(e.setState({selectedMessages:[]}).then(function(){t.changedMessageSelection(e),t.cleanSelection(r)}),setTimeout(function(){return cancelStackPush("im_peer",a)},0)):n()};cancelStackPush("im_peer",r)}function _(e){e.set(ie.leaveInvitation)}function p(e,t){var n=e.get().tabs[t.peerId],r=e.get().active_tab;return r===oe.FOLDER_ALL?!0:(0,ie.filterFromTab)(r)(n)}function h(e){var t=e.attaches.filter(function(e){return"sticker"!==e.type});return(0,se.isServiceMsg)(e)||0===t.length}function v(e,t,n){addClass(n,"im-page_history-show"),t.loadingPeer(e)}function b(e,t){(0,se.isPendingForward)(e)&&(cancelStackFilter("forward"),e.set(ie.forwardMessages.bind(null,e.get().pendingForward,t,cur.imDb)))}function y(e,t){var n=document.querySelector(we),r=(0,se.isCommunityInterface)(e)?ye:Ce,a=n?n.offsetHeight:0;return r+=Ee,r+=a,Math.floor((t.offsetHeight-r)/he)}function C(e,t){var n=y(e,t);if(e.get().tabbedPeers.length>n){var r=e.get().tabbedPeers.filter(function(t){var n=t.peer;return intval(n)!==e.get().peer}),a=r.map(function(t){var n=t.peer;return e.get().tabs[n]}),i=a.sort(function(e,t){return t.last_touched-e.last_touched}),s=[];0!==e.get().peer&&s.push(e.get().tabs[e.get().peer]);var o=s.concat(i).slice(n).map(function(e){return e.peerId}),l=e.get().tabbedPeers.filter(function(e){return!inArray(e.peer,o)});return e.set(ie.updateTabbedPeers.bind(null,l,!0))}return Promise.resolve(e)}function E(){for(var e=curBox();e;)e.hide(),e=curBox()}function w(e,t,n,r,a,i,s,o,l){e.set(ie.cancelRecording).then(function(){r.cancelRecording()}),AudioMessagePlayer.detachPlayer(),t.forward&&r.hideFwd(e),(0,ae.isSearching)(e)&&t.cancelSearch&&(a.clearSearch(e),n.restoreDialogs(e)),S(e,o,l),v(e,r,i);var u=e.get().peer;(0,ie.updateMentions)(e.get()),(0,se.isFullyLoadedTab)(e,t.peerId)&&(t.msgid&&!(0,ae.getMessage)(e,t.peerId,t.msgid)||!t.msgid&&!(0,ae.getMessage)(e,t.peerId,(0,ae.getTab)(e,t.peerId).lastmsg))&&e.mutate(function(e){e.tabs[t.peerId].msgs=void 0,e.tabs[t.peerId].msgid=void 0});var c=e.set(ie.changePeer.bind(null,t.peerId,t.msgid)).then(function(e){var n=e.get(),r=ie.loadPeer.bind(null,t.peerId,!1,t.msgid,!1,n);return n.tabs[t.peerId]?Promise.resolve(n):e.set(r)}).then(function(){n.selectPeer(t.msgid,e),b(e,e.get().peer),window.tooltips&&tooltips.hideAll(),E(),r.preparePeer(e),f(e,r),(0,se.isClassicInterface)(e)&&(n.deactivate(),C(e,i).then(function(){return s.updateMenu(e)}))});return c=t.msgid?c.then(function(){return e.set(ie.selectPeerOnMessage.bind(null,t.peerId===u,u))}):c.then(function(){return e.set(ie.selectPeer.bind(null,!0))}),c.then(function(){if(e.get().peer===t.peerId){if(t.forward){var n=e.get().tabs[e.get().peer];!n.scrollBottom&&n.unread&&e.set(ie.readLastMessages.bind(null,e.get().peer))}(0,se.isClassicInterface)(e)&&s.updateMenu(e),r.changePeer(e,!1),r.updateTyping(t,e),(0,ie.updateMentions)(e.get())}})["catch"](function(e){return(0,de.imWeirdCatch)("applyNewPeer",e)})}function S(e,t,n){t&&e.get().shown&&(t.hide(e),n().createCanceled(e))}function T(e,t,n){(0,ae.isSearching)(e)&&(t.clearSearch(e),n.restoreDialogs(e))}function k(e,t,n,r,a,i,s){(0,se.isClassicInterface)(e)&&(a.saveScroll(e),i.saveScroll(e)),r.rotateCross(e),addClass(s,"im-page_creating"),e.setState({isCreating:!0}),n&&n.show(e,t),(0,se.isClassicInterface)(e)&&(setStyle(s,{height:L(s,e).page}),setTimeout(function(){addClass(s,"im-page_cropped")},200)),(0,ie.toggleConversation)(!0)}function I(e,t,n,r){n&&n.hide(e,t)}function P(e,t,n,r,i,s,o,g,f,b,y,E,P,M,L,A,D,O,x,R){return{changePeer:function(e,n){t.selectPeer(e,n)},cancelSearch:function(e){T(e,r,t)},loadingPeer:function(e){v(e,n,i)},restoreDialogs:function(e,n,r){t.restoreDialogs(e,n,r)},focusSearch:function(e){r.focusInput(e)},appendSearch:function(e,n,r,a){t.appendSearch(e,n,r,a)},appendDialogs:function(e,n){t.appendDialogs(e,n)},showCreation:function(e,a){k(e,a,b,r,t,n,i)},updateState:function(e,r){t.updateDialog(e,r),r.get().peer===e&&n.updateChat(r,e)},appendFastDialogs:function(e,n){t.appendFastDialogs(e,n,!0)},createCanceled:function(e,a){r.createCanceled(e,a),(0,se.isClassicInterface)(e)?(setStyle(i,{height:"auto"}),removeClass(i,"im-page_cropped"),setTimeout(function(){return r.focusInput(e)},0),0===e.get().peer?t.restoreScroll(e):n.restoreScroll(e,e.get().peer)):setTimeout(function(){0===e.get().peer?r.focusInput(e):n.focustTxt(e)},0),removeClass(i,"im-page_creating"),e.setState({isCreating:!1})},updateMenu:function(e){A&&A.updateMenu(e)},hideFwd:function(e){n.hideFwd(e)},updateDialog:function(e,n){t.updateDialog(e,n)},focusTxt:function(e){n.focustTxt(e)},resync:function(e){(0,ae.isSearching)(e)&&r.clearSearch(e),t.restoreDialogs(e,!0,!0),t.focusOnSelected(e),b&&b.hide(e),(0,se.isCommunityInterface)(e)&&u(e,i),(0,se.isClassicInterface)(e)&&e.get().tabbedPeers.forEach(function(t){var n=t.peer;A.updateCounter(e,n),A.updateName(n,e)}),n.cleanSelection(e.get().selectedMessages||[]),n.cancelSearch(e,!0),(0,se.isReservedPeer)(e.get().peer)||n.changePeer(e,!1);var a=e.get().gid?"l_mgid"+e.get().gid:"msg";handlePageCount(a,e.get().unread_cnt)},toggleSettingsLoader:function(e,t){y.toggleLoader(e,t)},onUserActions:function(e,t){if(!(0,ie.isSearchingInplace)(e.get().peer,e.get())){var r=e.get(),a=r.peer;if((0,se.isFullyLoadedTab)(r,a)&&!s.is_idle){var i=(0,ae.countUnread)(e.get().peer,e.get());if(i>0){var o=r.tabs[a];!o.skipped&&n.isNewMessagesVisible(e)&&(n.hideGoToEnd(!0),e.set(ie.readLastMessages.bind(null,a)))}}}},removeSelection:function(e){t.removeSelection(e),r.focusInput(e)},route:function(e,a,s,o){if("undefined"!=typeof e[0])return!0;e.box&&(e={box:e.box});var u=!1;return e.invite_chat_id&&s.invite_hash?!0:(Object.keys(e).sort().forEach(function(e){switch(e){case"sel":u=!0;var a=s.sel?(0,se.unUrlPeer)(s.sel):0,c=o.back;0===a?E.get().longpoll.push([J.resetPeer(!1,c)]):E.get().longpoll.push([J.changePeer(a,s.msgid||!1)]);break;case"invite_chat_id":case"invite_hash":_(E);break;case"tab":S(E,b,f),u=!0;var d=s.tab||oe.FOLDER_ALL;E.get().longpoll.push([J.changeTab(d)]);break;case"act":s.act&&"create"===s.act?k(E,[],b,r,t,n,i):I(E,[],b,i);break;case"q":s.q?r.setSearch(E,s.q):r.clearSearch(E);break;case"box":l(E,s.box)}}),(0,se.isClassicInterface)(E)&&"undefined"==typeof e.sel&&A.updateMenu(E),u&&T(E,r,t),!1)},updateDialogFilters:function(e){(0,ae.isSearching)(e)||t.restoreDialogs(e),y.updateFilter(e)},removePeer:function(e,n){t.removeDialog(e,n),t.saveScroll(e),e.get().peer===n&&e.get().longpoll.push([J.resetPeer()]),(0,se.isClassicInterface)(e)&&A.updateMenu(e)},newMessage:function(e){(0,se.isClassicInterface)(e)||t.scrollUp(!0)},onEvents:function(e,s){var l=s.filter(function(e){return e.type!==J.ADD_MESSAGE||!(e.flags&J.FLAG_STEALTH)}),_=s.filter(se.isServiceMsg),v=s.filter(function(e){return e.type===J.ADD_MESSAGE});d(_,e,t,n,A),e.set(ie.checkNewPeople.bind(null,_,v,o)).then(function(){l.forEach(function(s){switch(s.type){case J.ADD_MESSAGE:var o=e.get().tabs[e.get().peer],l=!o||!o.msgs||0==o.msgs.length,d=(0,se.isDuplicate)(s,e.get()),_=(0,ae.isCommunityBlocked)(e,s.peerId);if(0===d){s.flags&J.FLAG_OUTBOUND||e.set(ie.updateFavAndTitle.bind(null,s.peerId,!0)),e.set(ie.addMessage.bind(null,s)),C(e,i),p(e,s)&&(m(e,s),t.updateTyping(s,e),(0,ae.isSearching)(e)?t.updateDialog(s.peerId,e):t.promoteDialog(e,s));var v=(0,ae.isCommunityBlocked)(e,s.peerId);v===!1&&_===!0&&n.updateActions(e),(0,se.isClassicInterface)(e)&&(A.updateCounter(e,s.peerId),A.updateMenu(e)),n.updateTyping(s,e),n.addMessage(e,s),(0,se.isClassicInterface)(e)||y.updateFilter(e),h(s)||!(0,se.isFullyLoadedTab)(e,s.peerId)||s.local||e.set(ie.loadMedia.bind(null,s)).then(function(e){n.replaceAttachmentPlaceholders(e,s)})}else 2===d?(h(s)||e.set(ie.loadMedia.bind(null,s)).then(function(e){n.replaceAttachmentPlaceholders(e,s)}),e.set(ie.replaceMessage.bind(null,s)),n.replaceMessageAttrs(s,e),t.updateDialog(s.peerId,e)):(0,ae.isSearching)(e)||t.promoteDialog(e,s);o&&l&&R();break;case J.EDIT_MESSAGE:e.set(ie.editMessage.bind(null,s)).then(function(e){t.updateDialog(s.peerId,e),n.updateTyping(s,e),n.editMessage(e,s),!h(s)&&(0,se.isFullyLoadedTab)(e,s.peerId)&&e.set(ie.loadMedia.bind(null,s)).then(function(e){n.replaceAttachmentPlaceholders(e,s)})});case J.READ_INBOUND:e.set(ie.markInboundMessagesAsRead.bind(null,s)).then(function(e){t.updateCounter(e,s.peerId),n.updateGoToEnd(e,!0),(0,se.isClassicInterface)(e)&&A.updateCounter(e,s.peerId),(0,ae.isSearching)(e)||t.restoreDialogs(e),y.updateFilter(e)});break;case J.READ_OUTBOUND:e.set(ie.markOutboundMessagesAsRead.bind(null,s)).then(function(e){t.updateCounter(e,s.peerId),n.markMessagesAsRead(e,s)});break;case J.UNREAD_COUNT:e.set(ie.updateUnreadCount.bind(null,s.count)).then(function(){var t=e.get().gid?"l_mgid"+e.get().gid:"msg";handlePageCount(t,s.count),y.updateFilter(e),
(0,se.isClassicInterface)(e)&&u(e,i)});break;case J.GOT_ONLINE:case J.GOT_OFFLINE:var E=s.type===J.GOT_ONLINE;e.set(ie.updateOnline.bind(null,s.userId,E?s.platform:!1,s.lastSeenTs)).then(function(e){(0,se.isTabLoaded)(e.get(),s.userId)&&(t.updateOnline(s.userId,e),n.updateOnline(s.userId,e))});break;case J.SET_FLAGS:case J.RESET_FLAGS:if(s.flags&(J.FLAG_DELETED|J.FLAG_DELETED_FOR_ALL)&&s.type===J.SET_FLAGS&&!(0,se.isAlreadyDeleted)(e,s.peerId,s.messageId)&&!e.get().blockedFlagUpdates[s.peerId]&&g(s),s.flags===J.FLAG_IMPORTANT){var S=s.type===J.SET_FLAGS;e.set(ie.updateImportant.bind(null,S?1:-1,s.messageId)).then(function(){(0,se.isClassicInterface)(e)||r.updateImportantCnt(e)}),e.set(ie.updateFavMessage.bind(null,[s.messageId],s.peerId,S)).then(function(t){n.markImportant(s.messageId,S,e)})}break;case J.TYPING:(0,se.isSelfMessage)(s.peerId,e.get().gid)||(e.set(ie.setTyping.bind(null,s.peerId,s.userId)).then(function(e){(0,se.isTabLoaded)(e.get(),s.peerId)&&(n.updateTyping(s,e),t.updateTyping(s,e))}),e.set(ie.waitTyping.bind(null,s.peerId,s.userId)).then(function(e){(0,se.isTabLoaded)(e.get(),s.peerId)&&(n.updateTyping(s,e),t.updateTyping(s,e))}));break;case J.NOTIFY_SETTINGS_CHANGED:B(e,f,s.peerId,0!==s.disabledUntil);break;case J.RESYNC:e.get().longpoll.pause(),e.set(ie.resync).then(f().resync).then(function(){return e.get().longpoll.resume()});break;case J.TRANSITION:P.transition(s.state);break;case J.RESET_PEER:if(s.removeActivePeer){var k=e.get().tabbedPeers.filter(function(t){var n=t.peer,r=t.type;return n!==e.get().peer&&"perm"===r});e.setState({tabbedPeers:k})}c(e,t,n,i),s.cancelSearch&&T(e,r,t),(0,se.isClassicInterface)(e)&&A.updateMenu(e),r.focusInput(e);break;case J.CHANGE_TAB:(0,se.changeTab)(s.tab,e,f,ie.changeDialogsTab).then(function(e){y.updateFilter(e)});break;case J.RESET_DIRECTORIES:case J.SET_DIRECTORIES:case J.REPLACE_DIRECTORIES:e.set(ie.updateFolderState.bind(null,s.peerId,s.mask,s.type,s.local)).then(function(e){(0,ae.isSearching)(e)||s.type===J.RESET_DIRECTORIES&&s.mask===J.FOLDER_IMPORTANT||s.type===J.REPLACE_DIRECTORIES||t.restoreDialogs(e),t.updateDialog(s.peerId,e),u(e,i),e.get().peer===s.peerId&&n.changedMessageSelection(e)});break;case J.DELETE_DIALOG:e.set(ie.deletedDialog.bind(null,s.peerId,Promise.resolve([]))).then(function(){f().removePeer(e,s.peerId),f().updateDialogFilters(e)});break;case J.CHANGE_PEER:w(e,s,t,n,r,i,A,b,f);break;case J.MUTEX:var I=a({},s.peerId,s),M=(0,se.isPeerBlocked)(s.peerId,e);e.set(ie.updateBlockStates.bind(null,I)).then(function(){t.updateDialog(s.peerId,e);var r=(0,se.isPeerBlocked)(s.peerId,e);(0,se.isFullyLoadedTab)(e.get(),s.peerId)&&M!==r&&n.updateChat(e,s.peerId)});break;case J.FAILED_MESSAGE:e.set(ie.setMessageErrored.bind(null,s.peer,s.message)).then(function(){n.setMessageErrored(s.peer,s.message,s.error,e),t.setDialogFailed(s.peer,s.message.messageId,e)});break;case J.RESEND:var L=s.message.messageId;e.set(ie.resendMessage.bind(null,s.peerId,L,s.message)).then(function(){n.resendMessage(s.peerId,L),t.promoteDialog(e,s.message)})}})})},updateHistory:function(e){return n.updateHistory(e)},cancelRecording:function(){return E.set(ie.cancelRecording).then(function(){return n.cancelRecording()})},fixHeight:function(){R()},unmount:function(){(0,K.destroyModule)(e),clearInterval(E.get().update_title_to),s.stop(),o.stop(),t.unmount();var a=window.devicePixelRatio>=2?"_2x":"";setFavIcon("/images/icons/favicons/fav_logo"+a+".ico"),n.unmount(),r.unmount(),cancelStackFilter("im_peer"),y.unmount(),b&&b.unmount(),A&&A.unmount(),D&&D(),M&&M(),(0,se.isLocksAvailable)(E)&&E.get().peer&&E.set(ie.releaseBlock.bind(null,E.get().peer)),O.unmount(),A&&A.unmount(),x.unmount(),clearInterval(L),cur.imDb.unmount(),cur.imDb=!1}}}function M(e,t,n,r){(0,se.isReservedPeer)(t.get().peer)||e().onUserActions(t,r),t.set(ie.updateFavAndTitle.bind(null,!1,!1))}function L(e,t){var n=ge("page_header"),r=geByClass1("_im_page_history",e),a=window.clientHeight()-n.offsetHeight-fe-2,i=(0,se.isClassicInterface)(t)?pe:_e,s={page:Math.max(a,i)};if((0,se.isClassicInterface)(t)){var o=(0,se.getClassicChatHeight)();o=o>0?Math.min(o-n.offsetHeight-fe-2,a):a;var l=hasClass(r,"im-page--history_empty-hist")?o:a;s.history=Math.max(o,i),s.chat=Math.max(l,i)}return s}function A(e,t,n,r,a){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:!0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:!1;if(!isFullScreen()){var o=L(e,t);if(setStyle(e,{minHeight:o.page}),(0,se.isClassicInterface)(t)&&("undefined"==typeof t.get().chatResizeInitialized&&t.set(ie.initializeChatResize),setStyle(e,{height:t.get().isCreating?o.page:"auto"}),setStyle(geByClass1("_im_page_dialogs",e),{minHeight:o.page,position:"static",top:0}),setStyle(geByClass1("_im_page_history",e),{minHeight:o.history,position:"relative",top:0}),setStyle(geByClass1("_im_chat_body_abs",e),{minHeight:o.chat,height:o.chat,position:"relative",top:0})),browser.safari&&s&&"function"==typeof s&&s(),r&&r.updateScroll(),a&&a.updateScroll(),n){var l=n.updateScroll();n.scrollFix(t,t.get().peer,l)}i&&setTimeout(function(){return A(e,t,n,r,a,!1)},100)}}function D(e){var t="safari-repaint";e.forEach(function(e){hasClass(e,t)&&removeClass(e,t),addClass(e,t)}),setTimeout(function(){e.forEach(function(e){removeClass(e,t)})},100)}function O(){var e=[geByClass1("_im_dialog_actions"),geByClass1("_im_chat_input_w"),ge("side_bar"),geByClass1("_im_right_menu"),geByClass1("_im_dialogs_settings"),geByClass1("_im_dialogs_search")];D(e)}function x(e,t,n,r){function i(){var t=(0,V.getNativeOption)("scrollLeft"),n=hasClass(e,"im-page--header_static"),r=[];c!==t?r=u.slice().concat([e]):n!==d&&(r=[e]),c=t,d=n,r.length>0&&r.forEach(function(r){var i=e===r&&n?0:-t;setStyle(r,a({},cssTransformProp,0===i?"unset":"translateX("+i+"px)"))})}if(browser.mobile)return!1;var s=ge("side_bar"),o=geByClass1("_im_chat_input_w",r),l=geByClass1("_im_dialog_actions",r),u=[t,n,s,o,l],c=null,d=hasClass(e,"im-page--header_static");return addEvent(window,"scroll",i),i(),function(){removeEvent(window,"scroll",i),setStyle(s,{transform:""})}}function R(e){var t=e.get();if(!(0,se.isLocksAvailable)(e))return null;var n=(0,$.createWorker)(t.mutex_key,function(e){t.longpoll.push([J.mutexEvent(e)])},function(e,n){return(0,ie.getMutexQueue)(t.gid).then(function(e){var t=N(e,1),n=t[0];return n})}),r=n.stop;return r}function B(e,t,n,r){e.set(ie.setMutedPeer.bind(null,n,r)).then(t().updateState.bind(null,n))}function F(e,t){var n=t.get(),r=void 0,a=window.devicePixelRatio>=2?"_2x":"";setFavIcon("/images/icons/favicons/fav_im"+a+".ico"),A(e,t,!1,!1,!1,!0),show(e),t.set(ie.fetchLocalHints);var s=(0,K.createMutations)(P),o=s.callMutations,u=s.bindMutations,c=(0,Q.startLongPoll)(n);c.on("data",function(){for(var e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];return o().onEvents(t,n)});var d=geByClass1("_im_dialogs_search",e),g=geByClass1("_im_dialogs_settings",e),m=(0,H.mount)(geByClass1("_im_page_dcontent",e),t,o),_=(0,j.mount)(geByClass1("_im_page_history",e),t,o),p=(0,U.mount)(d,t,o),h=(0,G.mount)(g,t,o),v=(0,te.mount)(t);cur.imDb=(0,ne.mount)(t.get().gid?-t.get().gid:vk.id),(0,se.isClassicInterface)(t)&&h.updateSettings(t);var b=void 0,y=void 0;if((0,se.isClassicInterface)(t)){var C=geByClass1("_im_ui_peers_list",e.parentNode);b=(0,ee.mount)(C,t,o),y=x(d,g,geByClass1("_im_right_menu",e.parentNode),e)}(0,se.isClassicInterface)(t)&&n.peer&&m.deactivate(),n.gid||(r=(0,q.mount)(geByClass1("_im_dialogs_creation",e),t,o));var E=n.isCreating,w=E?"create":0===n.peer?"search":"default";E&&r.show(t,[]);var S=(0,Y.create)(t,w,m,_,p,r),T=(0,ue.mount)(t,S);_.updateScroll();var k=M.bind(null,o,t,S);(0,se.isReservedPeer)(n.peer)||setTimeout(function(){return f(t,_)},10);var I=new IdleManager({id:"im",element:document,focusElement:window,triggerEvents:"mouseover mousedown keypress"}),L=debounce(O,300),D=A.bind(null,e,t,_,m,r,!1,L);t.setState({longpoll:c}),t.set(ie.setExecStack.bind(null,[])),I.on("unidle",function(){c.abortPauses(),k()}),I.start(),nav.objLoc.box&&(l(t,nav.objLoc.box),(0,z.updateLocation)({box:null}));var B=R(t);t.set(ie.fetchFriends.bind(null,cur.imDb));var F=void 0;(0,se.isLocksAvailable)(t)&&(F=setInterval(se.blockLatencyCompensation.bind(null,t,n.longpoll),2e3)),t.get().invitation&&(0,se.showInvitationBox)(t,t.get().invitation,ie.leaveInvitation);var N=(0,re.throttleAccumulate)(i.bind(null,t,_),200),V=se.hideTopNotice.bind(null,t),W=se.hideAsideNotice.bind(null,t),X=(0,K.createModule)({handlers:function(t,n){t(document,"mousemove mousedown keypress",k),t(window,"resize",D),n(e,"click",se.HIDE_TOP_NOTICE_CLASS,V),n(gpeByClass("_im-page-wrap",e),"click",se.HIDE_ASIDE_NOTICE_CLASS,W),browser.safari&&t(document,"visibilitychange",O)}});return u(X,m,_,p,e,I,c,N,o,r,h,t,S,B,F,b,y,v,T,D)}Object.defineProperty(t,"__esModule",{value:!0});var N=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=F;var H=n(44),j=n(77),U=n(98),G=n(58),q=n(2),z=n(21),V=n(3),W=n(24),K=n(100),Y=n(33),Q=n(65),X=n(74),J=r(X),$=n(80),Z=n(99),ee=n(38),te=n(84),ne=n(26),re=n(123),ae=n(86),ie=n(107),se=n(41),oe=n(27),le=n(51),ue=n(104),ce=n(90),de=n(36),me=n(119),fe=30,_e=400,pe=250,he=32,ve=12,be=52,ye=5*he+2*ve+be,Ce=3*he+2*ve,Ee=10,we="._im_aside_notice"},function(e,t){e.exports=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var r=n(82),a=n(6),i=n(126),s=Object.defineProperty;t.f=n(124)?Object.defineProperty:function(e,t,n){if(r(e),t=i(t,!0),r(n),a)try{return s(e,t,n)}catch(o){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t){e.exports={im_img_prebody:'<div class="im-prebody"> <img alt="" src="%photo%" /> </div>',im_admin_link:' (<a href="%href%" class="_im_admin_name" target="_blank">%name%</a>)',im_right_menu_tpl:'<a id="ui_rmenu_peer_%peer%" href="%href%" class="_im_peer_tab ui_rmenu_item %cls%"%attrs%>\n  <span>%label%</span>\n</a>',im_right_menu_sep:'<div class="ui_rmenu_sep"></div>',im_right_menu_ct:'<span class="ui_rmenu_count im-right-menu--count _im_r_ct">%count%</span> <button type="button" class="im-right-menu--close _im_r_cl"></button><span class="im-right-menu--text _im_r_tx">%name%</span>',im_dialogs_link_img:'<a href="%href%" class="_im_peer_target _online_reader" target="_blank"><div class="im_grid">%photo%</div></a>',im_dialogs_link:'<a href="%href%" class="_im_peer_target _online_reader" target="_blank">%photo%</a>',im_peer_photo:'<div class="nim-peer %online_class% %modifier_class%"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo"> %owner_photo% </div> </div> </div>',im_owner_item:'<a href="%link%" class="olist_item_wrap%cls%" id="olist_item_wrap%owner_id%" >\n  <div class="olist_item clear_fix">\n    <div class="olist_item_photo_wrap %img_cls%">\n      <img class="olist_item_photo" src="%photo%"/>\n    </div>\n    <div class="olist_item_name">%name%</div>\n    <div class="olist_checkbox"></div>\n  </div>\n</a>',im_simple_name:'<div class="im-page--title %more_cls%"> <span class="im-page--title-main" title="%name_attr%" %ads_union%><span class="im-page--title-main-in"><a href="%href%" target="_blank" class="im-page--title-main-inner _im_page_peer_name">%name%</a><span class="im-page--title-main-verified _im_chat_verified"></span></span></span> <span class="im-page--title-meta _im_page_peer_online">%online%</span> </div>',im_simple_link:'<a href="%href%" class="_im_header_link" target="_blank">%content%</a>',im_selected_messages:'<span class="im-page--selected-messages-count">%label%</span> <button aria-label="%tip%" type="button" class="im-page--selected-messages-remove"></button>',im_topic:"<div class='im-topic %cls%'>%topic%</div>",im_stack_date:' <a href="%link%" class="_im_mess_link" >%date%</a>',im_dialogs_none:'<li data-list-id="002300" class="im-page--dialogs-empty"> %msg%</li>',im_filter:'<a class="im-page--dialogs-filter %cls%">%filter%</a>',im_drow_prebody:'<span class="nim-dialog--who">%prebody%</span> <span class="nim-dialog--inner-text">%body%</span>',im_attach_mess:' <div class="im-fwd %modifier%"> <span class="im-fwd--title"> <span class="im-fwd--title-name">%text%</span> <span class="im-fwd--date">%date%</span></span> <span class="im-fwd--close _im_fwd_close"></span> <div rel="button" tab-index="0" type="button" class="im-fwd--messages _im_will_fwd">%messages%</div> </div>',im_preloader:'<div class="im-preloader %cls%"> %preloader%</div>',im_service_row:'<ul class="ui_clean_list"> <li class="im-mess im-mess_srv _im_mess _im_mess_srv _im_mess_%message_id%" data-msgid="%message_id%" data-from="%from_id%" data-ts="%date%"> <span class="im-mess--fav fl_r"></span> <div class="im-mess--check fl_l"></div> <div class="im-mess--text">%text%</div> </li> </ul>',im_chat_members:'<button type="button" class="_im_chat_members im-page--members">%name%</button>',im_mess_stack:'<div class="im-mess-stack _im_mess_stack %cls%" data-peer="%peerId%" data-admin="%admin%"> <div class="im-mess-stack--photo"> <div class="nim-peer nim-peer_small fl_l"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo"> <a target="_blank" class="im_grid" href="%href%"><img alt="%name%" src="%photo%" /></a> </div> </div> </div> </div> <div class="im-mess-stack--content"> <div class="im-mess-stack--info"> <div class="im-mess-stack--pname"> %stack_name% <span class="im-mess-stack--tools">%date%</span> </div> </div> <ul class="ui_clean_list im-mess-stack--mess _im_stack_messages"> %messages% </ul> </div> </div>',im_mess_stack_name:'<a href="%link%" class="im-mess-stack--lnk%class%" title="" target="_blank">%name%</a>',im_message_media:'<div class="_im_msg_media%messageId%" class="wall_module">%attaches%</div>%text%',im_dialog_media:'<span class="nim-dialog--preview nim-dialog--preview-attach">%name%</span>',im_typing:'<div class="im-page--typing _im_typing"> <div class="im-typing %cls%"><div class="pr im-typing--icon" id=""><div class="pr_bt"></div><div class="pr_bt"></div><div class="pr_bt"></div></div><span class="_im_typing_name">&nbsp;</span></div> </div>',ctrl_submit_hint:function(){return'<div class="reply_submit_hint_wrap" >\n  <div class="reply_submit_hint_title">'+getLang("wall_reply_submit_settings")+'</div>\n  <div class="reply_submit_hint_opts" id="">\n    <div class="radiobtn %enter_on% _im_submit_btn" data-val="0" onclick="radiobtn(this, 0, \'im_submit\'); "><div class="radiobtn_label">'+getLang("wall_reply_submit_settings_1")+'</div></div>\n    <div class="radiobtn %ctrl_on% _im_submit_btn" data-val="1" onclick="radiobtn(this, 1, \'im_submit\'); "><div class="radiobtn_label">'+getLang("wall_reply_submit_settings_2")+"</div></div>\n  </div>\n</div>"},im_day_bar:'<h5 class="im-page--history-new-bar im-page--history-new-bar_days _im_bar_date %day_class%" data-date="%date%"><span>%day%</span></h5>',im_mess_bar:function(){return'<h4 class="im-page--history-new-bar _im_unread_bar_row"><span>'+getLang("mail_new_unread_msgs")+"</span></h4>"},im_drow:function(){return'<li data-list-id="%peer%" class="nim-dialog _im_dialog _im_dialog_%peer% %is_unread% %is_unread_out% %is_selected% %more%" data-peer="%peer%" data-msgid="%msg_id%"> <div class="nim-dialog--photo"> <div class="nim-peer %is_online% _im_peer_online"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo _im_dialog_photo"> %photo% </div> </div> </div> </div> <div class="nim-dialog--content"> <div class="nim-dialog--cw"> <span role="link" class="blind_label" aria-label="'+getLang("mail_im_to_multidialog")+': %tab_name%"></span> <div class="nim-dialog--date _im_dialog_date">%date%</div> <button type="button" class="nim-dialog--close _im_dialog_close"></button> <button type="button" class="nim-dialog--markre _im_dialog_markre"></button> <div class="nim-dialog--name"> <span class="nim-dialog--name-w" aria-hidden="true"> %user_link% </span> <span class="nim-dialog--verfifed _im_dialog_verified"></span> <span class="nim-dialog--mute"></span> <button type="button" class="nim-dialog--star _im_dialog_star"></button> </div> <div class="nim-dialog--text-preview"> <span class="nim-dialog--preview _dialog_body" tabindex="0">%body%</span> <span class="nim-dialog--typing _im_dialog_typing"></span><span class="nim-dialog--typer-el"></span> </div> <label class="blind_label _im_unread_blind_label">%unread_message_string%</label> <div class="nim-dialog--unread _im_dialog_unread_ct" aria-hidden="true">%unread%</div> </div> </div> </li>'},im_conversation_search_row:function(){return'<li data-list-id="%peer%" class="nim-dialog nim-conversation-search-row _im_dialog _im_dialog_%peer% %is_unread% %is_selected% %more%" data-peer="%peer%" data-msgid="%msg_id%"> <div class="nim-dialog--photo"> <div class="nim-peer nim-peer_search %is_online% _im_peer_online"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo _im_dialog_photo"> %photo% </div> </div> </div> </div> <div class="nim-dialog--content"> <div class="nim-dialog--cw"> <span role="link" class="blind_label" aria-label="'+getLang("mail_im_to_multidialog")+': %tab_name%"></span> <button type="button" class="nim-dialog--close _im_dialog_close"></button> <div class="nim-dialog--name"> <span class="nim-dialog--name-w" aria-hidden="true"> %user_link% </span> </div> <div class="nim-dialog--unread _im_dialog_unread_ct" aria-hidden="true">%unread%</div> </div> </div> </li>'},im_delete_actions:function(){return'<span class="nim-dialog--who">%text%</span> <button class="nim-dialog--daction ui_bullet _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="restore" type="button">'+getLang("mail_restore")+'</button> <button class="nim-dialog--daction ui_bullet _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="spam" type="button">'+getLang("mail_im_mark_spam")+'</button> <button class="nim-dialog--daction nim-dialog--daction_last _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="block" type="button">'+getLang("mail_user_black_list")+"</button>"},im_chat_change_topic:function(){return'<div class="im_change_topic_wrap clear_fix"> <div class="im_change_topic_label fl_l ta_r">'+getLang("mail_chat_topic_change_label")+'</div> <div class="im_change_topic_labeled fl_l"> <input class="text _im_chat_topic_change_input" value="%value%"/> </div> </div>'},im_msg_row:function(){return'<li class="im-mess %cls% _im_mess_%msg_id%" aria-hidden="%aria_hidden%" data-ts="%ts%" data-msgid="%msg_id%" data-peer="%from_id%"> <div class="im-mess--actions"> <span role="link" aria-label="'+getLang("mail_im_reply")+'" class="im-mess--reply _im_mess_reply"></span><span role="link" aria-label="'+getLang("mail_important_message")+'" class="im-mess--fav _im_mess_fav"></span> </div> <div class="im-mess--check fl_l"></div> <div class="im-mess--text wall_module _im_log_body">%text%</div> <span tabindex="0" role="link" aria-label="'+getLang("mail_select_message")+'" class="blind_label im-mess--blind-select _im_mess_blind_label_select"></span> <span class="blind_label im-mess--blind-read _im_mess_blind_unread_marker" %unread_params%></span> <span class="im-mess--marker _im_mess_marker" %marker_params%></span> </li>'},im_wrap_mobile:'<b class="mob_onl %class%" %attrs% onmouseover="mobileOnlineTip(this, {%params%})"></b>',im_pinned_message:'<div class="im-page-pinned _im_pinned_message"> <button class="im-page-pinned--hide _im_pin_hide"></button> <div class="im-page-pinned--meta"> <a href="%link%" target="_blank" class="im-page-pinned--name">%name%</a> <span class="im-page-pinned--date">%date%</span> </div> <div class="im-page-pinned--content">%content%</div> </div>',im_pinned_message_media:'<span class="im-page-pinned--media">%text%</span>'}},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+r).toString(36))}},function(e,t){e.exports=function(){throw new Error("define cannot be used indirect")}},function(module,exports,__webpack_require__){"use strict";function uploadFailed(e,t,n){var r=void 0!==t.ind?t.ind:t,a=((t.fileName?t.fileName:t).replace(/[&<>"']/g,""),Upload.options[r]);if("fileApi"==Upload.types[r]&&!a.wiki_editor){var i=t.fileName?r+"_"+t.fileName:t;re("upload"+i+"_progress_wrap"),e().unchoose(i),1==a.filesTotalCount&&setTimeout(showFastBox({title:getLang("global_error")},getLang("mail_add_photo_error")).hide,2e3)}topError("Upload failed",{dt:-1,type:102,url:(ge("file_uploader_form"+r)||{}).action}),Upload.embed(r)}function onPhotoUploaded(e,t,n){var r=void 0!==e.ind?e.ind:e,a=(e.fileName?e.fileName:e).replace(/[&<>"']/g,""),i=e.fileName?r+"_"+e.fileName:e,s=ge("upload"+i+"_progress_wrap");s&&hide(geByClass1("progress_x",s)),ajax.post("al_photos.php",extend({act:"choose_uploaded"},t),{onDone:function(e,t){n().choose("photo",e,extend(t,{upload_ind:r+"_"+a}))},onFail:uploadFailed.bind(null,n,e)})}function uploadHide(e){hide(geByClass1(DROPBOX_CLASS,e)),hide(geByClass1(UPLOAD_WRAP_CLASS,e))}function uploadShow(e){hide(geByClass1(DROPBOX_CLASS,e)),hide(geByClass1(UPLOAD_WRAP_CLASS,e))}function initUploader(text,store,parentMutations){var txtInput=geByClass1("_im_text_wrap",text),data=store.get().upload_options,uploadHolder=geByClass1(UPLOAD_CLASS,text),dropbox=geByClass1(DROPBOX_CLASS,text),docsOpening=!1;return Upload.init(uploadHolder,data.url,data.params,{file_name:"photo",file_size_limit:26214400,file_types_description:"Image files (*.jpg, *.jpeg, *.png, *.gif, *.heic, *.heif)",file_types:"*.jpg;*.JPG;*.png;*.PNG;*.gif;*.GIF;*.jpeg;*.JPEG;*.heic;*.HEIC;*.heif;*.HEIF",file_input:null,accept:"image/jpeg,image/png,image/gif,image/heic,image/heif",file_match:data.opts.ext_re,lang:data.opts.lang,wiki_editor:0,onUploadStart:function(e,t){removeClass(txtInput,"im-chat-input--textarea_drag");var n=void 0!==e.ind?e.ind:e,r=Upload.options[n];"form"==Upload.types[n]&&(geByClass1("file",ge("choose_photo_upload")).disabled=!0),"fileApi"==Upload.types[n]&&(cur.notStarted&&(boxQueue.hideLast(),delete cur.notStarted),r.multi_progress&&this.onUploadProgress(e,0,0))},onUploadComplete:function onUploadComplete(info,res){var params,i=void 0!==info.ind?info.ind:info,fileName=(info.fileName?info.fileName:info).replace(/[&<>"']/g,"");try{params=eval("("+res+")")}catch(e){params=q2ajx(res)}return params.photos?(statlogsValueEvent("upload_photo_fails",1,data.opts.server,"success"),void onPhotoUploaded(info,params,parentMutations)):void Upload.onUploadError(info)},onUploadProgress:function(e,t,n){var r=void 0!==e.ind?e.ind:e;if("fileApi"==Upload.types[r]){var a={loaded:t,total:n};e.fileName&&(a.fileName=e.fileName.replace(/[&<>"']/g,"")),parentMutations().progress("photo",r,a)}},onUploadError:function(e,t){statlogsValueEvent("upload_photo_fails",1,data.opts.server,t),uploadFailed(parentMutations,e,t)},onCheckServerFailed:function(){uploadHide(text)},onUploadCompleteAll:function(e){"form"==Upload.types[e]&&Upload.embed(e)},onDragEnter:function(e){if(browser.chrome&&e.dataTransfer&&e.dataTransfer.items&&!docsOpening){var t=e.dataTransfer.items[0].type.split("/");if(!t[1]||t[1].match(/^(jpg|jpeg|png|heic|heif)$/i)||ge("docs_choose_upload_area_wrap"))addClass(txtInput,"im-chat-input--textarea_drag");else{var n=store.get().gid?{imhash:store.get().im_doc_hash,from:"from_gim"}:{};cur.dropDoc=!0,docsOpening=!0,cur.chooseMedia=parentMutations().choose;var r=0;cur.showMediaProgress=function(){0===r&&boxQueue.hideLast(),r++,parentMutations().progress.apply(null,arguments)},cur.attachCount=parentMutations().attachCount,showBox("docs.php",extend({act:"a_choose_doc_box",toId:cur.gid?-cur.gid:void 0,scrollbar_width:sbWidth(),blockPersonal:cur.gid?1:0,mail_add:1},n),{stat:["docs.css"],params:{onBeforeHide:function(){docsOpening=!1}},onFail:function(){docsOpening=!1}}),setTimeout(uploadHide.bind(null,text))}}},onDragOut:function(){removeClass(txtInput,"im-chat-input--textarea_drag")},onDrop:function(){removeClass(txtInput,"im-chat-input--textarea_drag")},noFlash:1,multiple:1,multi_progress:1,max_files:10,chooseBox:1,clear:1,type:"photo",max_attempts:3,server:data.opts.server,error:data.opts.default_error,error_hash:data.opts.error_hash,dropbox:dropbox,label:data.opts.label,dragEl:bodyNode})}function mount(e,t,n){removeEvent(bodyNode,"dragover dragenter");var r=initUploader(e,t,n);uploadShow(e);var a=(0,_modules.createModule)({handlers:function(e){var t=ge("im_full_upload");e(t,"change",function n(i){Upload.onFileApiSend(r,i.target.files),(0,_modules.destroyModule)(a);var s=t.cloneNode();t.parentNode.replaceChild(s,t),t=s,e(t,"change",n)})}});return{paste:function(e){Upload.onFileApiSend(r,e)},unmount:function(){(0,_modules.destroyModule)(a),Upload.deinit(r)}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.mount=mount;var _modules=__webpack_require__(100),UPLOAD_CLASS="_im_upload",DROPBOX_CLASS="_im_upload_dropbox",UPLOAD_WRAP_CLASS="_im_upload_wrap"},function(e,t,n){"use strict";function r(e){var t=D(e,2),n=t[1];return{type:x,localId:n}}function a(e){var t=D(e,4),n=t[1],r=t[2],a=t[3];return{type:B,messageId:n,mask:r,peerId:a}}function i(e){var t=D(e,4),n=t[1],r=t[2],a=t[3];return{type:R,messageId:n,flags:r,peerId:a}}function s(e){var t=D(e,4),n=t[1],r=t[2],a=t[3];return{type:F,messageId:n,flags:r,peerId:a}}function o(e){for(var t=D(e,9),n=t[1],r=t[2],a=t[3],i=t[4],s=t[5],o=t[6],l=void 0===o?{}:o,u=t[7],c=t[8],d=[],g=1;l["attach"+g+"_type"];)d.push({type:l["attach"+g+"_type"],id:l["attach"+g],productId:l["attach"+g+"_product_id"],build:l["attach"+g+"_build"],kind:l["attach"+g+"_kind"]}),g++;if(l.fwd){var m=l.fwd.split(",").map(function(e){return{text:l["fwd"+e],id:e}});d.push({type:"fwd",raw:l.fwd,messages:m})}l.geo&&d.push({type:"geo",id:l.geo,productId:null,build:null});var f=l.title;return{type:N,messageId:intval(n),flags:intval(r),peerId:intval(a),date:intval(i),attaches:d,subject:f,text:s,kludges:l,randomId:intval(u),userId:(0,O.isChatPeer)(a)?intval(l.from):intval(a),chatLocalId:c}}function l(e){var t=o(e);return t.type=oe,t}function u(e){var t=D(e,3),n=t[1],r=t[2];return{type:H,peerId:n,upToId:r}}function c(e){var t=D(e,3),n=t[1],r=t[2];return{type:j,peerId:n,upToId:r}}function d(e){var t=D(e,4),n=t[1],r=t[2],a=t[3];return{type:U,userId:-n,platform:r,lastSeenTs:a}}function g(e){var t=D(e,4),n=t[1],r=t[2],a=t[3];return{type:G,userId:-n,reason:r,lastSeenTs:a}}function m(e){var t=D(e,4),n=t[1],r=t[2],a=t[3],i=void 0===a?!1:a;return{type:Q,peerId:n,mask:r,local:i}}function f(e){var t=D(e,3),n=t[1],r=t[2];return{type:X,peerId:n,mask:r}}function _(e){var t=D(e,4),n=t[1],r=t[2],a=t[3],i=void 0===a?!1:a;return{type:J,peerId:n,mask:r,local:i}}function p(e){var t=D(e,3),n=t[1],r=t[2];return{type:se,peerId:n,localId:r}}function h(e){var t=D(e,3),n=t[1],r=t[2];return{type:q,chatId:n,self:r}}function v(e){var t=D(e,2),n=t[1];return{type:z,userId:n,peerId:n}}function b(e){var t=D(e,3),n=t[1],r=t[2];return{type:z,userId:n,peerId:r+2e9}}function y(e){var t=D(e,3),n=t[1],r=t[2];return{type:V,userId:n,callId:r}}function C(e){var t=D(e,2),n=t[1];return{type:W,count:n}}function E(e){var t=D(e,2),n=t[1],r=void 0===n?{}:n;return{type:K,peerId:r.peer_id,sound:r.sound,disabledUntil:r.disabled_until}}function w(e){return{type:Y,params:e}}function S(e){return{type:Z,state:e}}function T(){return{type:$}}function k(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1;return{type:ee,cancelSearch:e,removeActivePeer:t}}function I(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1;return{type:ne,peerId:e,msgid:t,forward:n,cancelSearch:r}}function P(e){return{type:re,tab:e}}function M(e,t,n){return{type:ae,message:t,peer:e,error:n}}function L(e){var t=D(e,6),n=(t[0],t[1]),r=t[2],a=t[3],i=t[4],s=t[5];return{type:te,free:!!intval(n)||intval(i)===vk.id,resource:r,peerId:intval(a),who:intval(i),name:s}}function A(e,t){return{type:ie,message:t,peerId:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.FOLDER_UNRESPOND=t.FOLDER_IMPORTANT=t.FLAG_DELETED_FOR_ALL=t.FLAG_STEALTH=t.FLAG_MEDIA=t.FLAG_DELETED=t.FLAG_SPAM=t.FLAG_FRIENDS=t.FLAG_CHAT=t.FLAG_IMPORTANT=t.FLAG_OUTBOUND=t.FLAG_UNREAD=t.EDIT_MESSAGE=t.DELETE_DIALOG=t.RESEND=t.FAILED_MESSAGE=t.CHANGE_TAB=t.CHANGE_PEER=t.MUTEX=t.RESET_PEER=t.TRANSITION=t.RESYNC=t.SET_DIRECTORIES=t.REPLACE_DIRECTORIES=t.RESET_DIRECTORIES=t.EMPTY=t.NOTIFY_SETTINGS_CHANGED=t.UNREAD_COUNT=t.VIDEO_CALL=t.TYPING=t.CHAT_CHANGED=t.GOT_OFFLINE=t.GOT_ONLINE=t.READ_OUTBOUND=t.READ_INBOUND=t.ADD_MESSAGE=t.RESET_FLAGS=t.REPLACE_FLAGS=t.SET_FLAGS=t.DELETE=void 0;var D=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.deleteEvent=r,t.replaceFlagsEvent=a,t.setFlagsEvent=i,t.resetFlagsEvent=s,t.addMessageEvent=o,t.editMessageEvent=l,t.readInboundEvent=u,t.readOutboundEvent=c,t.gotOnlineEvent=d,t.gotOfflineEvent=g,t.resetDirectoriesEvent=m,t.replaceDirectoriesEvent=f,t.setDirectoriesEvent=_,t.deleteDialogEvent=p,t.chatChangedEvent=h,t.typingUserEvent=v,t.typingChatEvent=b,t.videoCallEvent=y,t.unreadCountEvent=C,t.notifySettingsChangedEvent=E,t.emptyEvent=w,t.transitionEvent=S,t.resyncEvent=T,t.resetPeer=k,t.changePeer=I,t.changeTab=P,t.failedMessage=M,t.mutexEvent=L,t.resendEvent=A;var O=n(41),x=t.DELETE="event_delete",R=t.SET_FLAGS="event_set_flags",B=t.REPLACE_FLAGS="event_replace_flags",F=t.RESET_FLAGS="event_reset_flags",N=t.ADD_MESSAGE="event_add_message",H=t.READ_INBOUND="event_read_inbound",j=t.READ_OUTBOUND="event_read_outbound",U=t.GOT_ONLINE="event_got_online",G=t.GOT_OFFLINE="event_got_offline",q=t.CHAT_CHANGED="event_chat_changed",z=t.TYPING="event_typing",V=t.VIDEO_CALL="event_video_call",W=t.UNREAD_COUNT="event_unread_count",K=t.NOTIFY_SETTINGS_CHANGED="event_notify_settings_changed",Y=t.EMPTY="event_empty",Q=t.RESET_DIRECTORIES="event_reset_directories",X=t.REPLACE_DIRECTORIES="event_replace_directories",J=t.SET_DIRECTORIES="event_set_directories",$=t.RESYNC="event_resync",Z=t.TRANSITION="transition_event",ee=t.RESET_PEER="reset_peer",te=t.MUTEX="mutex",ne=t.CHANGE_PEER="change_peer",re=t.CHANGE_TAB="event_change_tab",ae=t.FAILED_MESSAGE="event_failed_message",ie=t.RESEND="event_resend",se=t.DELETE_DIALOG="event_delete_dialog",oe=t.EDIT_MESSAGE="event_edit_message";t.FLAG_UNREAD=1,t.FLAG_OUTBOUND=2,t.FLAG_IMPORTANT=8,t.FLAG_CHAT=16,t.FLAG_FRIENDS=32,t.FLAG_SPAM=64,t.FLAG_DELETED=128,t.FLAG_MEDIA=512,t.FLAG_STEALTH=65536,t.FLAG_DELETED_FOR_ALL=1<<17,t.FOLDER_IMPORTANT=1,t.FOLDER_UNRESPOND=2},function(e,t,n){var r=n(10),a=n(25),i=n(122),s=n(82),o=n(64),l=n(128);e.exports=function(e,t,n,u,c){var d,g,m,f=c?function(){return e}:l(e),_=r(n,u,t?2:1),p=0;if("function"!=typeof f)throw TypeError(e+" is not iterable!");if(i(f))for(d=o(e.length);d>p;p++)t?_(s(g=e[p])[0],g[1]):_(e[p]);else for(m=f.call(e);!(g=m.next()).done;)a(m,_,g.value,t)}},function(e,t,n){var r=n(19),a="__core-js_shared__",i=r[a]||(r[a]={});e.exports=function(e){return i[e]||(i[e]={})}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){var n=ge("page_header"),r=geByClass1("_im_chat_input_w",t),a=r.offsetHeight-r.clientHeight;return Math.min(window.clientHeight()-a,Math.max(Math.max(0,e),Ce+n.offsetHeight+t.offsetTop))}function i(e,t){var n=intval(domData(t.target,"msgid")),r=gpeByClass("_im_mess_"+n,t.target),a=geByClass1("_im_log_body",r),i=geByClass1("_im_mess_susp_cont",r);
a.innerHTML=i.innerHTML}function s(e,t,n){var r=geByClass1(e,t),i=void 0,s=void 0;(0,de.initDraggable)(r,{onStartDrag:function(e,t){addClass(bodyNode,"cursor_ns_resize"),i=t,s=t},onDrop:function(){removeClass(bodyNode,"cursor_ns_resize")},onDrag:function(e,r){var o=a(s-i+r,t);(0,Y.setClassicChatHeight)(o),n().fixHeight()}})}function o(e,t){(0,de.removeDraggable)(geByClass1(e,t))}function l(e){hide(e.target)}function u(e,t,n,r,a,i,s,o,l){removeClass(e,"im-page--history_empty"),p(e,t,n,r,a,i,s,o,l)}function c(e,t,n,r,a){if(checkEvent(r))return!0;var i=q2ajx(a.getAttribute("href")),s=intval(i.msgid);s&&e.set(K.changePeer.bind(null,e.get().peer,s)).then(function(){w(n,t,s,e)}),cancelEvent(r)}function d(e,t,n){var r=(0,Q.getTab)(t,n),a=(0,K.strHistory)(r.history);toggleClass(e,"im-page--history_empty-hist",!a)}function g(e,t,n,r){if(hasClass(n.target,"_im_mess_marker")){var a=n.target;window.tooltips&&(0,$.toArray)(geByClass(Y.FAILED_CLASS,t)).map(function(e){return geByClass1("_im_mess_marker",e)}).filter(function(e){return e!==a}).forEach(function(e){return tooltips.hide(e,{fasthide:!0})});var i=domData(r,"msgid");showTooltip(a,{content:getTemplate("im_failed_menu",{id:i}),className:"im-page--failed-tt",appendParentCls:"_chat_body_wrap",dir:"down",noZIndex:!0,shift:[12,8],hasover:!0})}}function m(e){return geByClass1("_im_peer_history",e)}function f(e){addClass(e,"im-page--history_empty"),m(e).innerHTML=""}function _(e,t){var n=t.contHeight(),r=e.scrollTop+(n-e.contHeight);t.scrollTop(r)}function p(e,t,n,r,a,i,s){var o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:!0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:!1,u=(t.get().tabs||{})[n];a().hideError(),i.renderPeer(t);var c=geByClass1("_im_peer_history",e);if(!t.get().tabHistoryNotChanged){val(geByClass1("_im_page_peer_name",e),u.tab);var g=(0,K.strHistory)(u.history);d(e,t,n),g||(g=getLang("mail_im_here_history")),val(c,g),getAudioPlayer().updateCurrentPlaying(),(0,Y.isClassicInterface)(t)||(0,Y.fixTableCellChildHeight)("_chat_body_wrap",e),R(t,r,e)}if((0,K.isSearchingInplace)(n,t.get())?a().showSearch(t):a().cancelSearch(t,!1),s.changePeer(n,t),t.get().msgid)w(r,e,t.get().msgid,t);else if(u.scrollBottom&&o){_(u,r);var m=(0,Y.isMessagesVisible)(t,e,r),f=W(m,1),p=f[0];u.skipped||setTimeout(function(){u.unread&&!p&&I(t,e,!0),b(t,r,e)},100)}else E(r,e,a,t,l)||r.scrollBottom(ve)}function h(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,r=n||t.scrollTop(),a=t.scrollBottom(),i=t.contHeight(),s=e.get().peer;e.set(K.saveHistoryScroll.bind(null,s,r,a,i))}function v(){return J.screenfull.isFullscreen}function b(e,t,n){var r=(0,Q.isGoToEndVisible)(e),a=4*t.getScrollHeight();t.scrollBottom()>a&&!r&&I(e,n,!0,2*t.getScrollHeight())}function y(e,t,n,r,a,i,s,o){var l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:!0;if((e.get().history_init||(e.get().history_init=!0,!(o.scrollTop()>=0)))&&!v()&&(a.update(o),a.show(),0!==e.get().peer&&(0,Y.isFullyLoadedTab)(e.get(),e.get().peer)&&(fe["default"].onHistoryScroll(o.scrollTop()),!(layers.visible||e.get().showed&&(0,Y.isClassicInterface)(e))))){var u=(0,Q.isGoToEndVisible)(e),c=(0,Q.getTab)(e,e.get().peer);c&&!c.skipped&&0>s?b(e,o,i):s>0&&!c.skipped&&!c.unread&&H(e,i),k(e,o)&&(u&&c&&!c.skipped&&H(e,i),c.unread>0&&C(e));var d=(0,Y.wrapLoading)(n);if(!(0,K.isSearchingInplace)(e.get().peer,e.get())&&l&&r(o),!Fe&&(0>s||0===o.scrollBottom())&&o.scrollBottom()<he){if((0,K.isSearchingInplace)(e.get().peer,e.get()))return;if(c.skipped>0&&!e.get().no_moving_down){var g=gpeByClass("_im_page_history",g),m=e.get();Fe=!0;var f=e.set(K.loadLessHistory).then(t().loadHistory.bind(null,m.peer,{reversed:!0})).then(function(){C(e),Fe=!1,I(e,g),c.skipped||e.set(K.changePeer.bind(null,e.get().peer,!1))});return O(g,!0),void f.then(O.bind(null,g,!1))}}if(!Fe&&o.scrollTop()<he){if((0,K.isSearchingInplace)(e.get().peer,e.get())){Fe=!0;var _=t().getSearchResulstModule();return _.isAll(e)?void(Fe=!1):void d(_.loadMore(e).then(function(n){Fe=!1,n&&(t().loadHistory(e.get().peer,{},e,n),r(o))}),"up")}var p=e.get();c.allShown||(Fe=!0,d(e.set(K.loadMoreHistory.bind(null,0,0)).then(t().loadHistory.bind(null,p.peer,{})).then(function(){Fe=!1,r(o)}),"up"))}}}function C(e){return window.curNotifier&&curNotifier.idle_manager&&curNotifier.idle_manager.is_idle?void 0:e.set(K.readLastMessages.bind(null,e.get().peer))}function E(e,t,n,r,a){var i=geByClass1("_im_unread_bar_row",t);if(i){var s=r.get(),o=s.peer,l=i.getBoundingClientRect(),u=geByClass1("_im_chat_body_abs",t).getBoundingClientRect().top+20;if((0,Y.isClassicInterface)(r)){var c=(0,Y.isChatPeer)(o)&&(0,se.isPinnedMessageVisibleInTab)(s,o);u+=Se+(c?we:0)}var d=e.scrollTop()-u+l.top;return e.scrollTop(d),h(r,e,d),setTimeout(function(){o===r.get().peer&&y(r,n,m(t),function(){},a,t,0,e)},80),C(r),!0}return!1}function w(e,t,n,r){var a=geByClass1("_im_mess_"+n,t);if(a){var i=(0,Y.isClassicInterface)(r),s=r.get().peer,o=i?window.clientHeight():geByClass1("_im_chat_body_abs",t).offsetHeight,l=a.offsetTop+domPN(a).offsetTop+domPN(domPN(a)).offsetTop+domPN(domPN(domPN(a))).offsetTop;i&&(0,Y.isChatPeer)(s)&&(0,se.isPinnedMessageVisibleInTab)(r,s)&&(l-=we),e.scrollTop(l-e.getScrollHeight()/2+o/2),addClass(a,"im-mess_light"),setTimeout(function(){removeClass(a,"im-mess_light")},ye)}}function S(e,t,n){n.updateLastSeen(e)}function T(e,t,n,r,a){var i=domData(a,"action"),s=domData(a,"msgid"),o=geByClass1("_im_mess_marker",geByClass1("_im_mess_"+s));switch(i){case"resend":t(r,a);break;case"delete":e.set(K.removeFailed.bind(null,e.get().peer,s)).then(function(){(0,Y.removeMessages)([s],m(n))})}tooltips.hide(o,{fasthide:!0})}function k(e,t){return(0,Q.getUnreadScrollBottom)(e)>=intval(t.scrollBottom())}function I(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=e.get().peer;if(!(0,Y.isReservedPeer)(a)){var i=e.get().tabs[a],s=geByClass1(ke,t),o=geByClass1("_im_to_end_label",s);n&&i.unread>0?val(o,getLang("mail_im_new_messages",i.unread)):val(o,getLang("mail_im_to_end_new"));var l=!1;(n||i.skipped>0)&&!(0,K.isSearchingInplace)(e.get().peer,e.get())?(l=!0,addClass(s,"im-to-end_shown")):N(s,!0),e.set(K.updateGoToEndVisibility.bind(null,[l,intval(r)]))}}function P(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===e.scrollTop()&&0===e.scrollBottom())return!1;var n=e.scrollBottom();return(t?be+t:be)>n}function M(e,t,n,r){var a=domData(r,"msgid"),i=e.get().peer;e.get().imQueueResend(i,a).then(function(t){e.get().longpoll.push([(0,ue.resendEvent)(i,t.mess)])})}function L(e,t,n,r,a){var i=intval(domData(a,"peer")),s=intval(domData(gpeByClass("_im_mess",a),"msgid")),o=e.get().tabs[i].hash;return(0,K.restoreMessageSend)(s,i,o,e.get().gid),e.set(K.restoreMessage.bind(null,s,i)).then(Y.restoreMessage.bind(null,s,i,m(t))).then(function(){return R(e,n,t)}),!1}function A(e,t){e().showCreation(t)}function D(e,t,n){cancelStackFilter("forward"),e.set(K.prepareForward.bind(null,[])).then(function(){t().changePeer(!1,e),removeClass(n,"im-page--history_fwd"),e.get().longpoll.push([(0,ue.transitionEvent)("default")])})}function O(e,t){var n=geByClass1(ke,e);toggleClass(n,"im-to-end_loading",t)}function x(e,t,n,r){var a=t.get().tabs[t.get().peer];return a.skipped?(O(n,!0),void t.set(K.changePeer.bind(null,t.get().peer,!1)).then(function(){return t.set(K.loadPeer.bind(null,t.get().peer,!0,-1,!1))}).then(function(){O(n,!1),e().changePeer(t,!1,!1),C(t)})):(r.scrollBottom(ve),I(t,n),void C(t))}function R(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1;if((0,Y.isClassicInterface)(e)){var i=t.contHeight(),s=geByClass1("_im_chat_input_w",n),o=s.offsetHeight-s.clientHeight,l=geByClass1("_im_chat_resize",n),u=geByClass1("_im_chat_input_parent",n),c=geByClass1("_im_chat_audio_input_parent",n);if(r=r!==!1?r:(0,Y.getClassicChatHeight)(),r!==!1&&r>0){var d=a(r,n),g=hasClass(c,xe)||hasClass(c,Oe),m=g?c:u,f=d-m.offsetHeight;l.style.height=window.clientHeight()-d-o+"px",setStyle(s,{top:f+"px",bottom:"auto"})}else l.style.height="0px",setStyle(s,{top:"auto",bottom:"0px"});var _=geByClass1("_im_peer_history_w",n);return setStyle(_,{borderBottomWidth:s.offsetHeight-Ee-1}),t.contHeight()-i}(0,Y.fixTableCellChildHeight)("_chat_body_wrap",n);var p=t.getScrollHeight();t.update(!1,!0);var h=t.getScrollHeight();return p-h}function B(e,t,n,r){var a=t.offsetHeight;r(),e.heightIncreased(t.offsetHeight-a,n)}function F(e,t){var n=t.getBoundingClientRect().top;showTooltip(t,{className:"im-page--admin-tt",text:getLang("mail_only_admin_see"),appendParentCls:"_chat_body_wrap",shift:[20,5],dir:"auto",showdt:400,noZIndex:!0,toup:n>200})}function N(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1;t&&addClass(e,"im-to-end_fast"),removeClass(e,"im-to-end_shown"),t&&(e.offsetHeight,removeClass(e,"im-to-end_fast"))}function H(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,r=geByClass1(ke,t);e.set(K.updateGoToEndVisibility.bind(null,[!1,0])),N(r,n)}function j(e,t,n){J.screenfull.isFullscreen||0===t.get().peer||(0,Y.isClassicInterface)(t)||e().restoreScroll(t,t.get().peer)}function U(e,t){var n=e.get(),r=n.peer,a=domClosest(Re,t.target),i=intval(domData(a,"msgid")),s=(0,Q.getMessage)(e,r,i),o=s&&(0,Y.isServiceMsg)(s)&&s.kludges.source_act;if(o===Y.CHAT_PIN_MESSAGE||o===Y.CHAT_UNPIN_MESSAGE){var l=a.querySelector("."+Be);if(l&&"A"!==l.tagName){var u=s.kludges.source_chat_local_id;if(!u)return;(0,K.getMessageLocalId)(r,u,n).then(function(e){var t=W(e,1),n=t[0];if(n){var a="/im?sel="+(0,Y.convertPeerToUrl)(r)+"&msgid="+n,i=l.innerHTML;domReplaceEl(l,(0,Y.serviceLink)(a,i,!0,Be))}})}}}function G(e,t,n){var r=e.get(),a=r.peer,i=n.target.href&&n.target.href.match(/msgid=([\d]+)/),s=i&&i[1];if("A"===n.target.tagName&&s&&!(0,Y.isAlreadyDeleted)(e,a,s)&&!checkEvent(n)){var o=(0,Q.getMessage)(e,a,s);o?(e.setState({msgid:s}),(0,_e.updateLocation)({msgid:s}),t().focusOnMessage()):r.longpoll.push([(0,ue.changePeer)(a,s)])}cancelEvent(n)}function q(e){var t=(0,Q.getCurrentTab)(e);(0,Y.isChatPeer)(t.peerId)&&(t.pinHideId=cur.imDb.select(pe.PIN_HIDDEN_ID_OP,t.peerId))}function z(e,t,n,r,a,i,s,l,c,d,g,v,b,y,C){var E=void 0,T=throttle(function(){n.smoothScroll.apply(n,arguments)},300);return{changePeer:function(e){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!0;if(0===e.get().peer&&C.disable(),revertLastInlineVideo(t),0===e.get().peer)return f(t,e);if((0,Y.isFullyLoadedTab)(e.get(),e.get().peer)){removeClass(t,"im-page--history_search"),e.set(K.dropSelection),r.changeActions(e);var c=e.get().peer,d=e.get().prevPeer;removeClass(t,"im-page--history_loading"),s?a.restoreDraft(e):a.updateState(e),I(e,t),i().updateTyping({peerId:c},e),C.toggle(!0),S(e,t,r),(0,Y.isReservedPeer)(d)&&!(0,Y.isReservedPeer)(c)?(u(t,e,c,n,i,r,l,o,C),C.reset(n)):(0,Y.isReservedPeer)(d)||(0,Y.isReservedPeer)(c)||(p(t,e,c,n,i,r,l,o,C),C.reset(n))}},preparePeer:function(e){var n=e.get().peer;q(e),a.restoreDraft(e),i().updateTyping({peerId:n},e),i().hideError(),r.renderPeer(e),r.hideActions(e),l.changePeer(n,e),S(e,t,r),C.toggle(!1),H(e,t,!0)},saveScroll:function(e){return h(e,n)},loadingPeer:function(e){(0,K.isAnythingLoading)(e.get())||(removeClass(t,"im-page--history_empty"),addClass(t,"im-page--history_loading"))},stopLoading:function(e){removeClass(t,"im-page--history_loading")},deselectDialog:function(e){s().removeSelection(e)},replaceMessageAttrs:function(e,n){(0,Y.replaceMessageAttrs)(n.get(),m(t),e)},cleanSelection:function(e){d.cleanSelection(e)},updateDialogFilters:function(e){s().updateDialogFilters(e)},getSearchResulstModule:function(){return E},insertSearch:function(e,r){E||(E=(0,re.mount)(t,r,i)),addClass(t,"im-page--history_search"),e?(removeClass(t,"im-page--history_search-empty"),m(t).innerHTML=e):(addClass(t,"im-page--history_search-empty"),m(t).innerHTML=(0,Y.renderEmptySearch)()),R(r,n,t),n.scrollBottom(0),I(r,t),C.reset(n)},updateChatTopic:function(e,t){s().updateDialog(e,t),e===t.get().peer&&(r.renderPeer(t),r.renderActions(t))},updateActions:function(e){r.changeActions(e)},updateChatPhoto:function(e,a,i){if((0,Y.isPeerActive)(e.peerId,i.get())){r.renderPeer(i);var s=P(n);(0,Y.addChatPhotoToUpdate)(e,a,i.get(),m(t)),s&&n.scrollBottom(ve)}},markImportant:function(e,n,a){var i=geByClass1("_im_mess_"+e,t);i&&(r.changedMessageSelection(a),c.markImportant(e,n,a))},isNewMessagesVisible:function(e){return k(e,n)},loadHistory:function(e,r,a){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1,s=a.get();if((0,Y.isPeerActive)(e,s)){var o=i||s.tabs[e].historyToAppend;if(!o)return;var l=geByClass1("_im_peer_history",t),u=domFC(l),c=n.scrollBottom(),d=r.reversed?function(e){return l.appendChild(e)}:function(e){return l.insertBefore(e,u)},g=0;r.reversed&&(g=l.offsetHeight);var m=sech(o),f=document.createDocumentFragment();m.forEach(function(e){return f.appendChild(e)}),d(f),r.reversed&&C.heightIncreased(l.offsetHeight-g,n),r.reversed||n.scrollBottom(c),n.update(!1,!0);var _=m.filter(function(e){return hasClass(e,"_im_bar_date")});C.parseMore(_,n)}},sendMessage:function(e){0!==e.get().peer&&a.sendMessage()},editMessage:function(e,r){if((0,Y.isFullyLoadedTab)(e,r.peerId)&&(0,Y.isPeerActive)(r.peerId,e.get())){var a=geByClass1("_im_mess_"+r.messageId,t);if(!a)return;(0,Y.editAndReplaceMessage)(e.get(),r,t),C.reset(n)}},addMessage:function(e,r){if(!(0,K.isSearchingInplace)(r.peerId,e.get())){if((0,Y.isFullyLoadedTab)(e,r.peerId)&&(0,Y.isPeerActive)(r.peerId,e.get())){if(geByClass1("_im_mess_"+r.messageId,t))return;var a=m(t);B(C,a,n,function(){var s=P(n),o=geByClass1("_im_unread_bar_row",t),l=(0,Y.isMessagesVisible)(e,t,n),u=W(l,2),c=u[0],d=u[1];(0,Y.appendToHistory)(e.get(),r,a,!0,!0,!c&&!o),removeClass(t,"im-page--history_empty-hist");var g=(0,Q.getTab)(e,e.get().peer),m=(0,Y.isServiceMsg)(r)&&r.userId===vk.id,f=r.kludges&&r.kludges.source_act,_=m&&f!==Y.CHAT_PIN_MESSAGE&&f!==Y.CHAT_UNPIN_MESSAGE;g.skipped||c||!(0,X.isUnread)(g,r)||(0,X.isOut)(r)||I(e,t,!0,d),(r.local||s||_)&&n.scrollBottom(0),i().updateTyping(r,e),(0,$.toArray)(geByClass("_im_history_tooltip",t)).forEach(hide)});var s=domPS(domLC(a));if(hasClass(s,"_im_bar_date")){var o=ce("div");o.innerHTML=s.outterHTML,C.parseMore(o,n)}i().hideError(),C.update(n)}(0,K.updateMentions)(e.get())}},setMessageErrored:function(e,n,r,a){r&&i().showError(r),(0,Y.setMessageError)(e,n,t)},markMessagesAsRead:function(e,n){e.get().peer===n.peerId&&(0,Y.markMessagesAsRead)(e.get(),n.peerId,t)},compensateHistoryHeightChange:function(e){n.scrollTop(n.scrollTop()+e*we)},hideFwd:function(e){removeClass(t,"im-page--history_fwd")},updateTyping:function(e,n){if(!(0,K.isSearchingInplace)(e.peerId,n.get())){var r=n.get();if(n.get().peer===e.peerId&&(0,Y.isFullyLoadedTab)(r,e.peerId)){var a=(0,Y.formatTyper)(n.get().tabs[e.peerId].typing,e.peerId,!1,n.get()),s=geByClass1(Y.TYPING_CLASS,t);if(s||a){if(!s){var o=geByClass1(Le,t);val(o,getTemplate("im_typing",{cls:(0,Y.isClassicInterface)(n)?"im-typing_classic":""})),s=geByClass1(Y.TYPING_CLASS,t)}val(geByClass1("_im_typing_name",s),a),a?(addClass(s,"im-page--typing_vis"),i().hideError()):removeClass(s,"im-page--typing_vis")}}}},scrollFix:function(e,t,r){C.heightIncreased(r,n),C.update(n),(0,Y.isPeerActive)(t,e.get())&&P(n,r)&&n.scrollBottom(ve)},updateGoToEnd:function(e,r){var a=(0,Q.getTab)(e,e.get().peer);a&&a.skipped?I(e,t):H(e,t,r),g(0,n,!1);var i=e.get().peer;setTimeout(function(){e.get().peer===i&&h(e,n)})},newMessage:function(e){s().newMessage(e),H(e,t,!0)},scroll:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1;if(0!==e.get().peer){var i=r?n.getScrollHeight():40;a===!0&&(i=n.contHeight()),i="up"===t?-i:i,r||a?T(i,function(){g(i,n)}):(n.scrollTop(n.scrollTop()+i),g(i,n))}},showCreation:function(e,t){s().showCreation(e,t)},updateScroll:function(){return R(v,n,t)},toggleBarDate:function(e){C.toggle(e)},changedMessageSelection:function(e){r.changedMessageSelection(e)},updateOnline:function(e,t){(0,Y.isTabLoaded)(t.get(),e)&&e===t.get().peer&&r.renderPeer(t)},isEmpty:function(e){return a.isEmpty(e)},replaceAttachmentPlaceholders:function(e,r){(0,Y.isPeerActive)(r.peerId,e.get())&&(B(C,m(t),n,function(){var a=P(n);(0,Y.replaceAttaches)(t,r,e.get()),a&&n.scrollBottom(0)}),C.update(n))},removeMessages:function(e,r,a){a.get().peer===r&&((0,Y.removeMessages)(e,m(t)),R(a,n,t))},hideGoToEnd:function(e){H(v,t,e)},removeMessagesRestore:function(e,n,r,a){a.get().peer===n&&(0,Y.removeMessagesWithRestore)(e,n,r,m(t))},updateState:function(e,t){s().updateState(e,t)},updateChat:function(e,t){e.get().peer===t&&(r.changeActions(e),r.renderPeer(e),r.renderActions(e),a.updateState(e),(0,K.updateMentions)(e.get()))},focustTxt:function(e){a.focusOn(e)},showSearch:function(e){addClass(t,"im-page--hisory_search-open"),l.focus(e),e.setState({searchShown:!0}),(0,Q.getPinnedMessage)(e)&&this.updateChatTopic(e.get().peer,e)},cancelSearch:function(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!0;if(removeClass(t,"im-page--hisory_search-open"),removeClass(t,"im-page--history_search"),removeClass(t,"im-page--history_search-empty"),e.setState({searchShown:!1}),(0,Q.getPinnedMessage)(e)&&this.updateChatTopic(e.get().peer,e),r.changedMessageSelection(e),E&&(E.unmount(),E=!1),a&&!(0,Y.isReservedPeer)(e.get().peer)){var i=e.get().tabs[e.get().peer];m(t).innerHTML=(0,K.strHistory)(i.history),R(e,n,t),n.scrollBottom(0),e.get().msgid&&(w(n,t,e.get().msgid,e),I(e,t)),b(n),C.reset(n)}},updateHistory:function(e){0!==v.get().peer&&e(t)},focusOnMessage:function(){w(n,t,v.get().msgid,v)},unmount:function(){(0,Z.destroyModule)(e),n.destroy(),clearInterval(y),a.unmount(),r.unmount(),c.unmount(),d.unmount(),l.unmount(),cancelStackFilter("forward"),o("_im_chat_resize_track",t)},removePeer:function(e,t){s().removePeer(e,t)},restoreScroll:function(e,t){var r=e.get().tabs[t];r.scrollBottom?_(r,n):n.scrollBottom(ve)},resendMessage:function(e,n){e===v.get().peer&&(0,Y.startResendMessage)(e,n,t)},respond:function(e,t){a.attachMessages(e,t),a.focusOn(e);var r=(0,Q.getTab)(e,t);r&&!r.skipped&&(n.scrollBottom(ve),b(n))},startForward:function(e){addClass(t,"im-page--history_fwd"),geByClass1("_im_explain_fwd",t).textContent=getLang("mail_explain_fwd",e.get().pendingForward.length),s().cancelSearch(e),s().removeSelection(e),cancelStackPush("forward",function(){return D(e,s,t)})},cancelRecording:function(){a.cancelRecording()},hideError:function(){hide(geByClass1(Ae,t))},showError:function(e){geByClass1(Ae,t).innerHTML=e,show(geByClass1(Ae,t)),n.scrollBottom(ve)}}}function V(e,t,n){var r=geByClass1("_im_peer_history_w",e);show(r);var a=(0,Z.createMutations)(z),o=a.callMutations,u=a.bindMutations,f=function(e){var t=debounce(e,100),n=throttle(e,100);return function(e){t(e),n(e)}}(h.bind(null,t)),_=(0,le.mount)(t,e),p=y.bind(null,t,o,r,f,_,e),v=(0,oe.createScroll)(geByClass1("_im_chat_body_abs",e),{onScroll:p,nativeScroll:(0,Y.isClassicInterface)(t),shadows:!1});setTimeout(function(){t.get().peer&&(q(t),(0,Q.getCurrentTab)(t).pinned&&(o().updateChatTopic(t.get().peer,t),t.set(K.setActions),b.changeActions(t)),t.get().msgid?w(v,e,t.get().msgid,t):E(v,e,o,t,_)||v.scrollBottom(ve),t.get().history_init=!1,_.reset(v),I(t,e),y(t,o,r,f,_,e,0,v))},15);var b=(0,ee.mount)(geByClass1("_im_dialog_actions",e),t,o),C=(0,te.mount)(geByClass1("_im_text_input",e),t,o),k=(0,ne.mount)(geByClass1("_im_dialog_actions",e),t,o),P=(0,ae.mount)(e,t,o),O=((0,se.mount)(e,t,o),(0,ie.mount)(e,t,function(){return{changedMessageSelection:b.changedMessageSelection}}));(0,Y.isReservedPeer)(t.get().peer)||t.set(K.restoreHistoryQueue.bind(null,t.get().peer)).then(function(){(0,Y.restoreQueue)(t.get().peer,t.get(),m(e)),d(e,t,t.get().peer)}),s("_im_chat_resize_track",e,n);var R=M.bind(null,t,e),B=L.bind(null,t,e,v),N=D.bind(null,t,n,e),H=A.bind(null,n,t),V=x.bind(null,o,t,e,v),W=g.bind(null,t,e),X=T.bind(null,t,R,e),$=Y.showChatMembers.bind(null,t,o,K.setCreationType),re=c.bind(null,t,e,v),ce=j.bind(null,o,t,v),de=throttle(U.bind(null,t),1e3),ge=G.bind(null,t,o),me=(0,Z.createModule)({handlers:function(n,r){r(e,"click",Y.RESTORE_CLASS,B),r(e,"mouseover click",Y.FAILED_CLASS,W),r(e,"click","_im_mess_susp",i.bind(null,e)),r(e,"click",Te,N),r(e,"click",Ie,X),r(e,"click",Y.SHOW_CHAT_MEMBERS_CLASS,$),r(e,"click",Pe,re),r(e,"mouseover",Me,F),r(e,"mouseover",Re,de),r(e,"click",Be,ge),r(e,"click",Ae,l),r(e,"click",De,function(e){return t.get().longpoll.push([(0,ue.resetPeer)()])}),n(geByClass1("_im_peer_history_w",e),"mousemove",_.show),n(geByClass1("_im_start_new",e),"click",H),n(geByClass1(ke,e),"click",V),J.screenfull.raw&&n(document,J.screenfull.raw.fullscreenchange,ce)}});curNotifier.recvClbks.pin_hide=[function(e){e.hide?(0,se.pinnedMessageHide)(t,e.peer,o,!1):(0,se.pinnedMessageUnHide)(t,e.peer,o,!1)}];var fe=setInterval(S.bind(null,t,e,b),1e4);return u(me,e,v,b,C,o,n,k,P,O,p,t,f,fe,_)}Object.defineProperty(t,"__esModule",{value:!0});var W=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=V;var K=n(107),Y=n(41),Q=n(86),X=n(15),J=n(31),$=n(123),Z=n(100),ee=n(14),te=n(118),ne=n(52),re=n(110),ae=n(48),ie=n(50),se=n(119),oe=n(3),le=n(4),ue=n(74),de=n(11),me=n(8),fe=r(me),_e=n(21),pe=n(26),he=1e3,ve=-30,be=30,ye=2e3,Ce=700,Ee=15,we=52,Se=47,Te="_im_cancel_fwd",ke="_im_to_end",Ie="_im_failed_action",Pe="_im_mess_link",Me="_im_admin_name",Le="_im_typer_c",Ae="_im_error",De="_im_join_cancel",Oe="im-audio-message_recorded",xe="im-audio-message_recording",Re="_im_mess_srv",Be="im_srv_mess_link",Fe=!1},function(e,t){},function(e,t,n){var r=n(71)("meta"),a=n(18),i=n(129),s=n(69).f,o=0,l=Object.isExtensible||function(){return!0},u=!n(112)(function(){return l(Object.preventExtensions({}))}),c=function(e){s(e,r,{value:{i:"O"+ ++o,w:{}}})},d=function(e,t){if(!a(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!i(e,r)){if(!l(e))return"F";if(!t)return"E";c(e)}return e[r].i},g=function(e,t){if(!i(e,r)){if(!l(e))return!0;if(!t)return!1;c(e)}return e[r].w},m=function(e){return u&&f.NEED&&l(e)&&!i(e,r)&&c(e),e},f=e.exports={KEY:r,NEED:!1,fastKey:d,getWeak:g,onFreeze:m}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e){return e.queue||e.key}function i(e){return window.curNotifier?!curNotifier.addQueues[a(e)]:!1}function s(e){return window.curNotifier?void!curNotifier.addQueues[a(e)]:!1}function o(){p.forEach(function(e,t){var n=e.onData,r=e.onUpdateKey,a=e.ts;i(t)&&Notifier.addKey(extend(t,{ts:a}),d.bind(null,n,r,t))})}function l(){h||(h=setInterval(o,3e3))}function u(e){s(e),p["delete"](e),0===p.size&&(clearInterval(h),h=!1)}function c(e,t,n,r){var a;switch(e){case 1:case 2:case 3:case 5:a=r(t,e);break;case 4:a=(0,_.pause)(1).then(function(){return t});break;default:throw new Error("Unkonwn error from queue: "+e)}(0,_.pause)(3).then(function(){return a}).then(function(e){p.set(e,{onUpdateKey:r,onData:n,ts:e.ts}),o(),l()})}function d(e,t,n,r,a){return a.failed?(u(n),void c(a.err,n,e,t)):(p.set(n,{onData:e,onUpdateKey:t,ts:intval(a.ts)}),void a.events.map(function(e){return e.split("<!>")}).forEach(e))}function g(e,t,n){return Notifier.addKey(e,d.bind(null,t,n,e)),p.set(e,{onData:t,onUpdateKey:n,ts:e.ts}),l(),{stop:u.bind(null,e)}}Object.defineProperty(t,"__esModule",{value:!0}),t.createWorker=g;var m=n(106),f=r(m),_=n(17),p=new f["default"],h=!1},function(e,t,n){for(var r=n(87),a=n(113),i=n(19),s=n(9),o=n(63),l=n(66),u=l("iterator"),c=l("toStringTag"),d=o.Array,g=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],m=0;5>m;m++){var f,_=g[m],p=i[_],h=p&&p.prototype;if(h){h[u]||s(h,u,d),h[c]||s(h,c,_),o[_]=d;for(f in r)h[f]||a(h,f,r[f],!0)}}},function(e,t,n){var r=n(18);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t,n){var r=n(82),a=n(34),i=n(95),s=n(28)("IE_PROTO"),o=function(){},l="prototype",u=function(){var e,t=n(115)("iframe"),r=i.length,a=">";for(t.style.display="none",n(22).appendChild(t),t.src="javascript:",e=t.contentWindow.document,e.open(),e.write("<script>document.F=Object</script"+a),e.close(),u=e.F;r--;)delete u[l][i[r]];return u()};e.exports=Object.create||function(e,t){var n;return null!==e?(o[l]=r(e),n=new o,o[l]=null,n[s]=e):n=u(),void 0===t?n:a(n,t)}},function(e,t,n){"use strict";function r(e){var t=e.get().tabs,n=e.get().peer,r=Object.keys(t).filter(function(t){return(0,i.isFullyLoadedTab)(e,t)&&intval(t)!==n}).map(function(e){return t[e]});r.filter(function(e){return Date.now()-e.last_visited>l}).forEach(function(t){return e.set(s.cleanTab.bind(null,t.peerId))}),r.filter(function(t){return(0,i.isFullyLoadedTab)(e,t.peerId)&&"string"!=typeof t.history&&Date.now()-t.last_touched>u}).forEach(function(t){return e.set(s.stringifyTab.bind(null,t.peerId))})}function a(e){var t=setInterval(r.bind(null,e),o);return{unmount:function(){clearInterval(t)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=a;var i=n(41),s=n(107),o=5e3,l=54e6,u=72e5},function(e,t,n){var r=n(66)("unscopables"),a=Array.prototype;void 0==a[r]&&n(9)(a,r,{}),e.exports=function(e){a[r][e]=!0}},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function a(e){return e.get?e.get():e}function i(e,t){var n=a(e),r=n.tabs[n.peer];return Object.keys(r.msgs).filter(function(n){var a=v(e,t,n);return!(0,N.isOut)(a)&&intval(n)>r.in_up_to})[0]}function s(e){var t=a(e);return t.peer}function o(e,t){var n=a(e);return n.tabs[t]}function l(e){var t=a(e);return t.peer?t.tabs[t.peer]:null}function u(e){var t=a(e);return t.selectedMessages}function c(e,t,n){var r=o(e,t),a=u(e)[0];if("undefined"==typeof a)return[n];var i=Math.min(n,a),s=Math.max(n,a);return Object.keys(r.msgs).filter(function(e){return e>=i&&s>=e}).filter(function(t){return!(0,G.isServiceMsg)(v(e,e.get().peer,t))}).map(intval)}function d(e,t){var n=a(t),r=o(n,e),i=0;for(var s in r.msgs){var l=v(t,e,s);(0,N.isOut)(l)||(i+=(0,N.isUnread)(r,l)?1:0)}return i}function g(e,t,n){var r=o(e,t);return Object.keys(r.msgs).filter(function(r){return intval(v(e,t,r).randomId)===n}).length>0}function m(e,t,n){var r=g(e,t,n);return!!r}function f(e,t){var n=a(e),r=n.msg_local_ids_sort&&n.msg_local_ids_sort[t];return"undefined"!=typeof r?2e9+r:t}function _(e,t,n){var r=o(e,t),a=v(e,t,n),i=Object.keys(r.msgs).filter(function(n){var r=v(e,t,n);return!a.local&&r.local?!1:a.local&&!r.local?!0:f(e,a.messageId)>f(e,r.messageId)}),s=i.pop();return s?v(e,t,s):null}function p(e){return e&&e.length>0?j.addMessageEvent([0].concat(e)):e}function h(e,t,n){var r=o(e,t),i=v(e,t,n),s=a(e);return(0,N.isOut)(i)?(0,q.oCacheGet)(e,s.id).name:i.userId!==i.peerId?(0,q.oCacheExists)(e,i.userId)?(0,q.oCacheGet)(e,i.userId).name:!1:r.tab}function v(e,t,n){var r=o(e,t),a=r&&r.msgs&&r.msgs[n];return a?p(a):null}function b(e){var t=a(e);return t.gid||t.isClassic}function y(e){return a(e).gid}function C(e){return a(e).gid}function E(e){return a(e).gid}function w(e,t){var n=a(t);return n.tabs[e]||n.mapped_index[e]}function S(e){var t=a(e);return E(e)?19542789!==t.gid&&103416369!=t.gid?!1:t.active_tab===U.FOLDER_UNRESPOND||t.active_tab===U.FOLDER_UNREAD?!0:!1:!1}function T(e,t){e=a(e);var n=e.tabs[t]&&"undefined"!=typeof e.tabs[t].history;return e.tabs[t]&&e.tabs[t].msgs&&n?!0:!1}function k(e){var t=e.get().go_to_end_visible;return t?t[0]:!1}function I(e){var t=e.get().go_to_end_visible;return t?t[1]:0}function P(e){var t=a(e);return!t.lockedSending}function M(e){return e>-2e9&&0>e}function L(e,t){return M(t)?!!o(e,t).blocked_community:!1}function A(e){var t=a(e);return t.voice_message_available}function D(e){var t=a(e);return!(!O(t)&&!t.recentSearch)}function O(e){var t=a(e);return t.searchText}function x(e,t){var n=a(e);return t&&t!==O(e)||n.recentSearch?!0:!1}function R(e){var t=a(e);return t.recentSearch}function B(e){var t=l(e);return t&&t.pinned&&p(t.pinned)}function F(e){var t=e.get().popular_sugg;return t&&t.length>0}Object.defineProperty(t,"__esModule",{value:!0}),t.unpackStore=a,t.getFirstUnread=i,t.getPeer=s,t.getTab=o,t.getCurrentTab=l,t.getSelectedMessages=u,t.getMessageRangeFromSelection=c,t.countUnread=d,t.getMessageByRid=g,t.isRidExist=m,t.getLocalId=f,t.getLastMessage=_,t.parserMessage=p,t.getAuthorFullName=h,t.getMessage=v,t.isClassicInterface=b,t.isLocksAvailable=y,t.isFoldersAvailable=C,t.isCommunityInterface=E,t.getBareTab=w,t.isReversedDialogs=S,t.isFullyLoadedTab=T,t.isGoToEndVisible=k,t.getUnreadScrollBottom=I,t.isSendingAvailable=P,t.isCommunityPeer=M,t.isCommunityBlocked=L,t.checkVoiceMessageAvailable=A,t.isSearching=D,t.getSearchText=O,t.isSearchingValue=x,t.isRecentSearchesActive=R,t.getPinnedMessage=B,t.doPopularSuggExist=F;var N=n(15),H=n(74),j=r(H),U=n(27),G=n(41),q=n(90)},function(e,t,n){"use strict";var r=n(85),a=n(30),i=n(63),s=n(97);e.exports=n(35)(Array,"Array",function(e,t){this._t=s(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,a(1)):"keys"==t?a(0,n):"values"==t?a(0,e[n]):a(0,[n,e[n]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(e,t,n){var r=n(113);e.exports=function(e,t,n){for(var a in t)r(e,a,t[a],n);return e}},function(e,t,n){"use strict";function r(e,t){return t?void ls.set(e,t):ls.get(e)}function a(e){try{var t={};return Error.captureStackTrace(t,e),t.stack}catch(n){return""}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=debounce(r,300),s=extend({},e),o=[];return t.store&&(s=ls.get(t.key)||s),{get:function(){return s},set:function(e){var r=this,o=(0,i.isWeirdLogging)()?a(this.set):null;return e(s).then(function(e){return s=e,t.store&&n(t.key,e),r})["catch"](function(e){return(0,i.imWeirdCatch)("store_set_catch",e,{stack:o})})},setState:function(e){return this.set(function(t){return Promise.resolve(extend(t,e))})},stash:function(){o.push(s),s=extend({},e)},reset:function(){s=extend({},e)},unmount:function(){s={},e=!1},pop:function(){o.length>0&&(s=o.pop())},mutate:function(e){e(s),t.store&&n(t.key,s)}}};var i=n(36)},function(e,t,n){"use strict";function r(e){if(!e.first_name){var t=e.name.split(" ",2);e.first_name=t[0],e.short_name=t[1]?t[0]+" "+t[1].substr(0,1)+".":t[0]}e.inv_name||(e.inv_name=e.name),e.kick_name||(e.kick_name=e.inv_name)}function a(e,t){var n=(0,o.unpackStore)(e);return t in n.oCache}function i(e,t){var n=(0,o.unpackStore)(e).oCache[t];return n&&!n._n&&(r(n),n._n=1),n}function s(e,t){var n=(0,o.unpackStore)(e);n.oCache||(n.oCache={}),t.id&&(n.oCache[t.id]=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.oCacheExists=a,t.oCacheGet=i,t.oCacheAdd=s;var o=n(86)},function(e,t,n){var r=n(66)("iterator"),a=!1;try{var i=[7][r]();i["return"]=function(){a=!0},Array.from(i,function(){throw 2})}catch(s){}e.exports=function(e,t){if(!t&&!a)return!1;var n=!1;try{var i=[7],s=i[r]();s.next=function(){n=!0},i[r]=function(){return s},e(i)}catch(o){}return n}},function(e,t,n){"use strict";var r=n(103),a={};a[n(66)("toStringTag")]="z",a+""!="[object z]"&&n(113)(Object.prototype,"toString",function(){return"[object "+r(this)+"]"},!0)},function(e,t){e.exports=!1},function(e,t){var n=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:n)(e)}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,n){
"use strict";var r=n(19),a=n(42),i=n(113),s=n(88),o=n(79),l=n(75),u=n(108),c=n(18),d=n(112),g=n(91),m=n(120),f=n(55);e.exports=function(e,t,n,_,p,h){var v=r[e],b=v,y=p?"set":"add",C=b&&b.prototype,E={},w=function(e){var t=C[e];i(C,e,"delete"==e?function(e){return h&&!c(e)?!1:t.call(this,0===e?0:e)}:"has"==e?function(e){return h&&!c(e)?!1:t.call(this,0===e?0:e)}:"get"==e?function(e){return h&&!c(e)?void 0:t.call(this,0===e?0:e)}:"add"==e?function(e){return t.call(this,0===e?0:e),this}:function(e,n){return t.call(this,0===e?0:e,n),this})};if("function"==typeof b&&(h||C.forEach&&!d(function(){(new b).entries().next()}))){var S=new b,T=S[y](h?{}:-0,1)!=S,k=d(function(){S.has(1)}),I=g(function(e){new b(e)}),P=!h&&d(function(){for(var e=new b,t=5;t--;)e[y](t,t);return!e.has(-0)});I||(b=t(function(t,n){u(t,b,e);var r=f(new v,t,b);return void 0!=n&&l(n,p,r[y],r),r}),b.prototype=C,C.constructor=b),(k||P)&&(w("delete"),w("has"),p&&w("get")),(P||T)&&w(y),h&&C.clear&&delete C.clear}else b=_.getConstructor(t,e,p,y),s(b.prototype,n),o.NEED=!0;return m(b,e),E[e]=b,a(a.G+a.W+a.F*(b!=v),E),h||_.setStrong(b,e,p),b}},function(e,t,n){var r=n(53),a=n(68);e.exports=function(e){return r(a(e))}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e){return ge("im_dialogs_search",e)}function i(e,t,n,r,a,i){var s=trim(i);if((0,w.isSearchingValue)(e,s)){var o=g.bind(null,e,n,a,t);s?(e.setState({recentSearch:!1}),a.stop()):a.replaceOrAdd(o),cancelStackPush("im_search",o),s&&e.set(E.setCurrentSearch.bind(null,s,!1)).then(t),addClass(r,"im-page--dialogs-search_fill"),addClass(r,"_im_d_search")}else s||(a.stop(),e.set(E.setCurrentSearch.bind(null,"",!1)).then(t),removeClass(r,"im-page--dialogs-search_fill"),removeClass(r,"_im_d_search"))}function s(e,t,n){return function(){var r=(0,w.getSearchText)(t);r===e&&n.apply(void 0,arguments)}}function o(e,t,n){var r=t().appendFastDialogs.bind(null,n),a=s(e,n,r);return(0,E.searchFriends)(e,n.get()).then(function(t){var r=t;if(e.indexOf("@")>=0&&!(0,S.isCommunityInterface)(n)){var i={type:"email_create",query:clean(e),peerId:Math.random()};r=[i].concat(t)}return a(r),t})}function l(e,t,n){var r=(0,w.getSearchText)(n);return x(.01,"im_search_stat",1,"search_start"),(0,E.updateSearchQuery)(r),n.setState({recentSearch:!1}),r?(n.get().dialog_search_going=!0,o(r,e,n).then(function(a){var i=a.map(function(e){return e.peerId});return t(r,e,i,n)}).then(function(e){n.get().dialog_search_going=!1})["catch"](function(){})):(e().restoreDialogs(n,!1,!0),Promise.resolve(!1))}function u(e,t,n,r){var a=r.get(),i=s(e,r,t().appendDialogs.bind(null,r)),o=s(e,r,t().appendSearch);return(0,S.isPendingForward)(r)?(0,E.searchHints)(e,n,"all",a).then(i):Promise.all([(0,E.searchHints)(e,n,"all",a).then(i),(0,E.searchMessages)(e,a)]).then(function(e){var t=C(e,2),n=C(t[1],2),a=n[0],i=n[1];o(r,a,i,!0)})}function c(e,t,n){n().showCreation(e)}function d(e,t,n,r){var s=a(t);s.value=q,i(e,r,t,s,n,s.value)}function g(e,t,n,r){cancelStackFilter("im_search");var s=a(t);uiSearch.reset(s),e.setState({recentSearch:!1}),i(e,r,t,s,n,s.value)}function m(e,t,n,r,a,i){(0,w.isSearching)(e)?(g(e,t,a,n),setTimeout(function(){return _(e,i)},10)):(window.tooltips&&tooltips.hide(i,{showsp:0}),c(e,i,r))}function f(e,t,n,r,a){return(0,S.showFavvedBox)(e,n,A.mount,r)}function _(e,t){return showTooltip(t,{appendEl:bodyNode,text:function(){return(0,w.isSearching)(e)?getLang("mail_cancel"):getLang("mail_start_conversaion")},black:1,shift:[3,-1],appendCls:"js-im-page"})}function p(e,t,n){var r=n.target;e.set(E.toggleCommunityMute.bind(null,t)).then(function(){toggleClass(r,"im-page--gim-mute_muted",e.get().mute),t&&v(e,{target:r})})}function h(e,t,n,r,a){if(!(0,w.isSearching)(e)){var s=cur.imDb.select(D.RECENT_SEARCH_OP);if(0!==s.length||(0,O.doPopularSuggExist)(e)){e.setState({recentSearch:!0}),i(e,function(){(0,w.isSearching)(e)||(r.stop(),a().restoreDialogs(e,!1,!0))},t,n,r,"");var o=s.filter(function(t){return!(0,S.isTabLoadedWithMessage)(e.get(),t)}),l=s.filter(function(t){return(0,S.isTabLoadedWithMessage)(e.get(),t)}).reduce(function(t,n){return t[n]=(0,w.getTab)(e,n),t},{});e.get().friendsTree.then(function(t){var n=t.list.filter(function(e){return inArray(e[0],o)}).reduce(function(e,t){return e[t[0]]=(0,E.localIndexToDialog)(t),e},{}),r=extend({},n,l);return a().appendFastDialogs(e,s.map(function(e){return r[e]})),(0,E.searchHints)(!1,Object.keys(n),!1,e.get())}).then(function(t){a().appendDialogs(e,t)})}}}function v(e,t){var n=t.target;return showTooltip(n,{text:function(){return e.get().mute?getLang("mail_im_sound_off"):getLang("mail_im_sound_on")},black:1,shift:[13,9],appendCls:"js-im-page"})}function b(e,t,n,r,i){return{focusInput:function(t){uiSearch.focus(a(e).parentNode)},createCanceled:function(e,n){removeClass(t,"im-dialog-select_rotated")},rotateCross:function(e){addClass(t,"im-dialog-select_rotated")},setSearch:function(t,n){d(t,e,r,function(){})},clearSearch:function(t){g(t,e,r,function(){})},updateImportantCnt:function(t){var n=t.get().important_cnt,r=geByClass1(R,e);toggleClass(r,"im-page--stars_hidden",0===n),r.innerHTML="<i></i> "+n},unmount:function(){r.stop(),(0,I.destroyModule)(i),uiSearch.destroy(n),cancelStackFilter("im_search")}}}function y(e,t,n){var r=geByClass1("_im_search_croll",e),s=a(e),o=(0,k["default"])("im_search",["_im_search_croll","_im_page_dcontent","_im_d_search","_im_dialog"]),c=(0,M.debouncedPromise)(u,300),d=l.bind(null,n,c),g=i.bind(null,t,d,e,s,o),y=m.bind(null,t,e,d,n,o,r),C=f.bind(null,t,e,n),E=geByClass1("_im_dialogs_search_input",e);uiSearch.init(E,{onChange:g});var w=_.bind(null,t,r),T=geByClass1(B,e);s.value&&g(s.value);var P=(0,I.createModule)({handlers:function(a,i){if(a(geByClass1("_im_av_time",e),"mouseover",function(e){showTooltip(e.target,{text:getLang("mail_admin_av_time"),dir:geByClass1("_im_top_notice")?"down":"up",shift:[0,8]})}),a(r,"click",y),a(r,"mouseover",w),a(geByClass1(R,e),"click",C),(0,S.isClassicInterface)(t)){var l=p.bind(null,t,!0),u=v.bind(null,t);a(T,"click",l),a(T,"mouseover",u)}a(s,"focus",function(){t.get().longpoll.push([(0,L.transitionEvent)("search")])}),a(s,"click",function(){h(t,e,s,o,n)}),a(s,"blur",function(){var e=void 0;e=0===t.get().peer?"search":(0,S.isPendingForward)(t)?"search":"default",t.get().longpoll.push([(0,L.transitionEvent)(e)])})}});return(0,S.isClassicInterface)(t)&&p(t,!1,{target:T}),b(e,r,E,o,P)}Object.defineProperty(t,"__esModule",{value:!0});var C=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=y;var E=n(107),w=n(86),S=n(41),T=n(105),k=r(T),I=n(100),P=n(37),M=n(17),L=n(74),A=n(51),D=n(26),O=n(86),x=debounce(P.statlogsProbValueEvent,1e3),R="_im_important_counter",B="_im_gim_mute"},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t,n,r){if(!e.loading&&!e.all){var a=n.scrollTop+window.innerHeight-n.scrollHeight;if(a>-300){var i=geByClass1("_im_peer_history",t.bodyNode);e.loading=!0,(0,h.wrapLoading)(i)((0,p.loadSpam)(e.offset,r.get().gid).then(function(t){var n=_(t,4),a=(n[0],n[1]),s=(n[2],n[3]);e.all=s.all,e.offset=s.offset,e.all?addClass(i,"im-important_all"):e.loading=!1,r.set(p.mergeTabs.bind(null,(0,h.tabFromIds)(s.msgs,s.hash)));var o=ce("div");o.innerHTML=a,i.appendChild(o)}),"bottom")}}}function i(){return'<button aria-label="'+getLang("mail_deselect_all")+'" type="button" class="im-deselect '+h.DESELECT_ALL_CLASS+'"></button>'}function s(e,t){var n=t.get().selectedMessages,r=geByClass1("_im_spam_box",e.bodyNode),a=geByClass1("ui_tab_sel",e.bodyNode);if(n.length>0){var s=getLang("mail_selected",n.length);s=s.replace("{count}",n.length),val(a,s+i())}else val(a,getLang("mail_spam"));0===n.length?removeClass(r,"im-important-box_with-sel"):(addClass(r,"im-important-box_with-sel"),val(geByClass1(w),getLang("mail_im_mark_notspam",n.length)),val(geByClass1(S),getLang("mail_im_mark_delspam",n.length)))}function o(e,t,n){var r=e.get().selectedMessages;e.set(p.cleanSelected).then(n.cleanSelection.bind(null,r)).then(function(n){return s(t,e)})}function l(e,t,n,r){var a=gpeByClass("_im_mess",r,t);if(a){var i=intval(domData(a,"msgid"));a&&((0,p.removeMessageSend)([i],0,e.get().tabs[0].hash,"undel",e.get().gid),(0,h.restoreMessage)(i,0,t))}}function u(e,t,n){var r=e.get().selectedMessages;(0,p.removeMessageSend)(r,0,e.get().tabs[0].hash,"delete",e.get().gid),(0,h.removeMessagesWithRestore)(r,0,"delete",t),o(e,t,n)}function c(e,t,n){var r=e.get().selectedMessages;(0,p.removeMessageSend)(r,0,e.get().tabs[0].hash,"nospam",e.get().gid),r.map(function(e){return geByClass1("_im_mess_"+e)}).filter(function(e){return e}).forEach(function(e){var t=intval(domData(e,"peer")),n=intval(domData(e,"msgid"));val(e,(0,h.renderGoTo)(t,n)),addClass(e,"im-mess_light")}),o(e,t,n)}function d(e,t,n,r,a){var i=gpeByClass("_im_mess",a,t.bodyNode),s=intval(domData(i,"peer")),o=intval(domData(i,"msgid"));return t.hide(),n().unmount(),e.get().longpoll.push([(0,E.changePeer)(s,o)]),stopEvent(r),cancelEvent(r),!1}function g(e,t,n,r){var a=showFastBox({title:getLang("mail_deleteall1"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},getLang("mail_delete_all_spam"),getLang("mail_delete"),function(i){(0,p.flushSpam)(e,r).then(function(e){var t=_(e,2),n=(t[0],t[1]);showDoneBox(n)}),a.hide(),t.hide(),n().unmount()},getLang("mail_close"),function(e){a.hide()})}function m(e,t){return{unmount:function(){t.unmount(),(0,v.destroyModule)(e)}}}function f(e,t,n){var r=ge("box_layer_wrap"),i=(0,v.createMutations)(m),f=i.callMutations,_=i.bindMutations,p=(0,C["default"])({peer:0,oCache:{},tabs:(0,h.tabFromIds)(n.msgs,n.hash),gid:t.get().gid}),y=a.bind(null,{all:n.all,loading:!1,offset:n.offset},e,r,p),E=l.bind(null,p,e.bodyNode),T=d.bind(null,t,e,f),k=g.bind(null,n.hash,e,f,t.get().gid),I=(0,b.mount)(e.bodyNode,p,function(t){return{changedMessageSelection:s.bind(null,e)}}),P=u.bind(null,p,e.bodyNode,I),M=c.bind(null,p,e.bodyNode,I),L=o.bind(null,p,e,I),A=(0,v.createModule)({handlers:function(t,n){t(r,"scroll",y),t(geByClass1(S,e.bodyNode),"click",P),t(geByClass1(w,e.bodyNode),"click",M),t(geByClass1("_im_spam_flush",e.bodyNode),"click",k),n(e.bodyNode,"click","_im_mess_restore",E),n(e.bodyNode,"click","_im_go_to",T),n(e.bodyNode,"click",h.DESELECT_ALL_CLASS,L)}});return _(A,I)}Object.defineProperty(t,"__esModule",{value:!0});var _=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=f;var p=n(107),h=n(41),v=n(100),b=n(50),y=n(89),C=r(y),E=n(74),w="_im_spam_not_spam",S="_im_spam_spam"},function(e,t,n){"use strict";function r(e){return{callMutations:function(){if("function"==typeof e)throw console.trace(),new Error("Mutations are not initialized");return e},bindMutations:function(){return e=e.apply(void 0,arguments)}}}function a(e,t,n,r){addEvent(t,n,r),e._registeredHandlers.push(["bind",t,n,r])}function i(e,t,n,r,a){(0,l.addDelegateEvent)(t,n,r,a),e._registeredHandlers.push(["delegate",t,n,r,a])}function s(e){var t={_registeredHandlers:[]};return e.handlers(a.bind(null,t),i.bind(null,t)),t}function o(e){e._registeredHandlers.forEach(function(e){var t=e.slice(1);"delegate"===e[0]?l.removeDelegateEvent.apply(void 0,t):removeEvent.apply(void 0,t)}),e._registeredHandlers=[]}Object.defineProperty(t,"__esModule",{value:!0}),t.createMutations=r,t.createModule=s,t.destroyModule=o;var l=n(59)},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){return(0,M.toArray)(e).find(function(e){return domData(e,"list-id")===t})}function i(e,t){return(0,M.toArray)(e).findIndex(function(e){return domData(e,"list-id")===t})}function s(e,t,n,r){if(n){o(e,t,r);var i=domData(n,"list-id"),s=i&&a(t.children,i);s&&r.forEach(function(e){return addClass(s,e)}),e.setState({hoveredListItemId:i})}}function o(e,t,n){var r=domQuery("."+n.join("."),t);r&&(0,M.toArray)(r).forEach(function(e){n.forEach(function(t){return removeClass(e,t)})}),e.setState({hoveredListItemId:null})}function l(e,t){var n=t&&domQuery("."+t.join("."),e)[0];return n?domData(n,"list-id"):null}function u(e,t,n){return e.map(t).reduce(function(e,t){return e[t]=!0,e},n)}function c(e,t,n){var r=e.filter(function(e){return!n.ids[t(e)]});return{_sortedEls:!1,els:r,ids:u(r,t,n.ids),elements:n.elements.concat(r)}}function d(e,t,n){return{ids:u(n.get().elements,e,{}),scrolls:t,activated:!0}}function g(e,t,n){return n.elements=n.elements.filter(function(n){return t(n)!==e}),delete n.ids[e],Promise.resolve(n)}function m(e,t,n){var r=[];n.elements=n.elements.map(function(n){var a=t(n),i=e.filter(function(e){return t(e)===a})[0];return r.push(a),i||n});var a=e.filter(function(e){return!inArray(t(e),r)});return n.elements=n.elements.concat(a),Promise.resolve(n)}function f(e,t){var n=t.get();return!n._sortedEls&&e&&t.setState({elements:n.elements.sort(e),_sortedEls:!0}),t.get().elements}function _(e){var t={};return e.forEach(function(e){"r"===e[0]&&t["a,"+e[1]]?delete t["a,"+e[1]]:t[e[0]+","+e[1]]=e}),Object.keys(t).map(function(e){return t[e]})}function p(e,t){for(var n=[],r=Math.max(e.length,t.length),a=0;r>a;a++){var i=e[a],s=t[a];!i&&s?n.push(["a",s,a]):i&&!s?n.push(["r",i,a]):i!==s&&(n.push(["r",i,a]),n.push(["a",s,a]))}var o=_(n),l=_(n.reverse());return o.length>l.length?l:o}function h(e,t,n,r,a,i){for(var s=0;r>s;s++)e=domNS(e);var o=se(a(t));return domData(o,"list-id",n),e?i.insertBefore(o,e):i.appendChild(o),e}function v(e,t,n,r){if(0!==t.length){t=t.sort(function(e,t){return e[2]-t[2]});var a=t.filter(function(e){return"a"===e[0]}),i=t.filter(function(e){return"r"===e[0]});if(i.map(function(t){return e.children[t[2]]}).forEach(function(e){return re(e)}),0!==a.length)for(var s=a.shift(),o=s[2],l=h(e.children[o],n[s[2]],s[1],0,r,e),u=0;u<a.length;u++)s=a[u],l=h(e.children[o],n[s[2]],s[1],s[2]-o,r,e),o=s[2]}}function b(e,t){e.get().loading?t.update(!1,!0):(e.get().loading=!0,t.update(!1,!0),e.get().loading=!1)}function y(e,t,n,r,a){var i=r.get(),s=i.limit,o=i.offset,l=n().sortFn,u=f(l,r).slice(0,o+s),c=(0,M.toArray)(e.children).map(function(e){return domData(e,"list-id")}).filter(function(e){return!!e}),d=u.map(function(e){return n().idFn(e).toString()}),g=p(c,d);return v(e,g,u,n().renderFn),b(r,t),a?g.filter(function(e){return"a"==e[0]}).map(function(e){return parseInt(e[1])}):void 0}function C(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=e.get(),l=t.getContainer().children,u=i(l,n||o.hoveredListItemId);if(!(0>u)){var c;c=o.limit+o.offset<u?e.setState({offset:u-o.limit+1}).then(y.bind(null,t.getContainer(),t,parentMutations)):Promise.resolve(),c.then(function(){var e=l[u],n=t.scrollTop(),i=t.getScrollHeight(),o=e.offsetHeight;a="center"===a?-.5*t.getScrollHeight():a,s="center"===s?i/2:s;var c=r?function(e){t.smoothScroll(e-t.scrollTop())}:t.scrollTop.bind(t),d=n+a>e.offsetTop,g=o+e.offsetTop>n+i-s;d?c(e.offsetTop-a):g&&c(e.offsetTop-i+o+s)})}}function E(e,t){if(e.get().loading||e.get().stop||!e.get().activated)return Promise.resolve([]);Math.random();e.get().loading=!0;for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;n>a;a++)r[a-2]=arguments[a];return t.apply(void 0,r).then(function(t){e.get().loading=!1})}function w(e,t,n){return n.scrolls||(n.scrolls={}),(!n.scrolls[e]||t)&&(n.scrolls[e]={scrolled:n.scrolled||0,scrollItem:n.scrollItem}),Promise.resolve(n)}function S(e,t,n,r){var a=e.get(),i=a.elements,s=r.getContainer(),o=e.setState({offset:a.offset+a.limit}).then(function(n){var o,l=a.offset,u=a.limit;return u+l>i.length?o=t().more(l,u).then(function(t){return t===!1?[]:(0===t.length&&e.setState({stop:!0}),t)}).then(k.bind(null,e,s,r,t,a.pipeId)):(o=Promise.resolve(),y(s,r,t,e)),o});if(!n){var l=i.length>0?"im-preloader_fixed-bottom":"im-preloader_fixed-center";(0,P.wrapLoading)(s)(o,"bottom",l)}return o}function T(e,t){var n=e.get().pipeId;return!("undefined"!=typeof n&&"undefined"!=typeof t&&n!==t)}function k(e,t,n,r,a,i){return T(e,a)?e.setState(c(i,r().idFn,e.get())).then(y.bind(null,t,n,r)):!1}function I(e,t,n){var c=E.bind(null,t,S.bind(null,t,n)),f=function(e,r){(t.get().activated||e)&&("undefined"!=typeof r&&t.get().elements.length>0&&t.setState({scrolled:r}),n().onScroll&&n().onScroll())},_=(0,L.createScroll)(e,{noScroll:t.get().noScroll,nativeScroll:t.get().nativeScroll,scrollChange:f.bind(null,!1),more:n().more?c.bind(null,!1):!1}),p=(0,A.createModule)({handlers:function(r,a){a(e,"click",t.get().elCls,n().onClick)}});return t.setState(d(n().idFn,{},t)),{pipe:function(e,r){return t.setState({pipeId:r}),e.then(k.bind(null,t,_.getContainer(),_,n,r))},replacePreserveOrder:function(e){return t.set(m.bind(null,e,n().idFn)).then(y.bind(null,_.getContainer(),_,n))},pipeReplace:function(e,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;return t.setState({pipeId:r,stop:!1}),e.then(function(e){return T(t,r)?t.setState({elements:e,_sortedEls:!1,ids:u(e,n().idFn,{})}).then(y.bind(null,_.getContainer(),_,n,t,a)):void 0})},wipe:function(){_.getContainer().innerHTML=""},deactivate:function(){t.setState({activated:!1})},activate:function(){t.setState({activated:!0})},saveScroll:function(e,n){return t.set(w.bind(null,e,n))},updateScroll:function(){_.update(!1,!0)},toTop:function(e){_.scrollTop(0),e&&f(e,0)},scrollTop:function(e){return _.scrollTop(e)},restoreScroll:function(e){var n=t.get().scrolls,a=n[e];return a&&(t.setState({scrolls:extend({},n,r({},e,null))}),_.scrollTop(a.scrolled)),!!a},unsetScroll:function(e){t.setState({scrolls:extend({},t.get().scrolls,r({},e,null))})},scrollPage:function(e,t){var n=_.scroll.scroller,r=_.scrollTop(),a="up"===e?-1:1,i=r+a*n.clientHeight;t?_.smoothScroll(i-r):_.scrollTop(i)},scrollToElement:function(e,n,r,a){C(t,_,e,n,r,a)},checkMore:function(e){return t.get().elements.length<t.get().limit?c(e,_):Promise.resolve([])},add:function(e,r){return k(t,_.getContainer(),_,n,r,e)},hoverNextElement:function(e,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=_.getContainer(),u=o.children,c=t.get().hoveredListItemId||l(o,r),d=i(u,c),g=(0,M.toArray)(u).slice(d+1).find(n().hoverableFn);s(t,o,g,e),C(t,_,null,!1,a.top,a.bottom)},hoverPrevElement:function(e,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=_.getContainer(),u=o.children,c=t.get().hoveredListItemId||l(o,r),d=i(u,c),g=d>=0&&(0,M.toArray)(u).slice(0,d).reverse().find(n().hoverableFn);s(t,o,g,e),C(t,_,null,!1,a.top,a.bottom)},hoverFirstElement:function(e,r){var a=_.getContainer(),i=a.children,o=(0,M.toArray)(i).findIndex(n().hoverableFn),l=i[o];!t.get().hoveredListItemId&&l&&(s(t,a,l,e),C(t,_,o,!1,r.top,r.bottom))},hoverElement:function(e,n,r){var a=_.getContainer(),o=a.children,l=i(o,e),u=o[l];u&&(s(t,a,u,n),C(t,_,l,!1,r.top,r.bottom))},unhoverElements:function(e){o(t,_.getContainer(),e)},reset:function(){var e=t.get().scrolls;t.reset(),t.setState(d(n().idFn,e,t))},getHoveredElement:function(){return a(_.getContainer().children,t.get().hoveredListItemId)},getCurrentElements:function(){return t.get().elements},isLoading:function(){return t.get().loading},isEmpty:function(){return 0===t.get().elements.length},remove:function(e){t.set(g.bind(null,e,n().idFn)).then(y.bind(null,_.getContainer(),_,n))},unmount:function(){(0,A.destroyModule)(p),_.destroy()}}}Object.defineProperty(t,"__esModule",{value:!0}),t.createIdMap=u,t.addElements=c,t.collapseOps=_,t.distance=p,t.mount=I;var P=n(41),M=n(123),L=n(3),A=n(100)},function(e,t,n){var r=n(129),a=n(97),i=n(60)(!1),s=n(28)("IE_PROTO");e.exports=function(e,t){var n,o=a(e),l=0,u=[];for(n in o)n!=s&&r(o,n)&&u.push(n);for(;t.length>l;)r(o,n=t[l++])&&(~i(u,n)||u.push(n));return u}},function(e,t,n){var r=n(45),a=n(66)("toStringTag"),i="Arguments"==r(function(){return arguments}()),s=function(e,t){try{return e[t]}catch(n){}};e.exports=function(e){var t,n,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=s(t=Object(e),a))?n:i?r(t):"Object"==(o=r(t))&&"function"==typeof t.callee?"Arguments":o}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e){return e.which||e.keyCode}function i(e,t){var t=e.get().tabbedPeers[t];t&&e.get().longpoll.push([(0,m.changePeer)(t.peer,!1,!0,!0)])}function s(e,t,n){!n||inArray(a(n),c.UNPRINTABLE_KEYS)||(0,d.isSearchingInplace)(e.get().peer,e.get())||(0,g.isEditableFocused)()||n.ctrlKey||browser.mac&&n.metaKey||n.key&&1!==n.key.length||t.signal("printable",n)}function o(e,t,n){a(n)===c.ENTER&&e.signal(a(n),n)}function l(e,t,n,r){var s=a(r);if(!layers.visible){if(s>=49&&57>=s&&(r.ctrlKey||r.metaKey&&browser.mac)&&(0,g.isClassicInterface)(t))return i(t,s-49),cancelEvent(r);inArray(s,c.UP_DOWN_CONTROLS)&&e.signal(s,r)}}function u(e,t){var n=browser.mozilla?"keydown":"keypress",r=(0,_["default"])({signalTimer:!1}),a=s.bind(null,e,t),i=l.bind(null,t,e,r),u=o.bind(null,t,r),c=(0,p.createModule)({handlers:function(e,t){e(document,"keydown",i),e(document,"keyup",u),e(document,n,a)}});return{unmount:function(){(0,p.destroyModule)(c)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=u;var c=n(27),d=n(107),g=n(41),m=n(74),f=n(89),_=r(f),p=n(100)},function(e,t){"use strict";function n(e){l=l.reduce(function(t,n){var r=o(n,2),a=r[0],i=r[1],s=i(e);return s?t:t.concat([[a,i]])},[])}function r(e,t){c===!1&&(c=!0,document.body.addEventListener("click",n,!0)),l=l.concat([[e,t]])}function a(e){l=l.filter(function(t){var n=o(t,1),r=n[0];return r!==e}),0===u&&(document.body.removeEventListener("click",n,!0),c=!1)}function i(e,t){l=l.map(function(n){var r=o(n,2),a=r[0],i=r[1];return a===e?[e,t]:[a,i]})}function s(e,t){return 0===t.length?function(t){return e(t),!0}:function(n){var r=t.reduce(function(e,t){return e&&!domClosest(t,n.target)},!0);return r&&e(n),r}}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t["default"]=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return u++,{stop:function(){u--,a(e)},replaceOrAdd:function(n){var a=l.filter(function(t){var n=o(t,1),r=n[0];return e===r}),u=s(n,t);a.length>0?i(e,u):r(e,u)}}};var l=[],u=0,c=!1},function(e,t,n){n(92),n(114),n(81),n(121),e.exports=n(46).Map},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){return e.resync_in_process?e.resync_in_process:Promise.resolve(!1)}function s(e){if(!e.renew_hashes){var t=e.last_hashes_update||0;if(Date.now()-t<1e4)return Promise.resolve();var n=Object.keys(e.tabs).filter(function(t){return(0,Zt.isFullyLoadedTab)(e,t)});e.renew_hashes=(0,Wt.post)(on,{act:"a_renew_hash",peers:n.join(","),gid:e.gid}).then(function(t){var r=Vt(t,1),a=r[0];return n.forEach(function(t){e.tabs[t].hash=a[t]}),delete e.renew_hashes,e.last_hashes_update=Date.now(),e})}return e.renew_hashes}function o(e,t,n){return i(e).then(function(r){return r?t.apply(void 0,n):s(e).then(function(e){return t.apply(void 0,n)})})}function l(e){return function(){var t=arguments,n=t[t.length-1];return e.apply(void 0,t)["catch"](function(r){if(r&&r.match&&r.match(/1001;/))return o(n,e,t);throw r})}}function u(e){return"string"==typeof e?se("<div>"+e+"</div>"):e}function c(e,t){var n=e.indexOf(t);-1===n&&e.push(t)}function d(e,t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}function g(e){return"string"==typeof e?e:e.innerHTML}function m(e,t){return t.block_states=extend(t.block_states,e),Promise.resolve(t)}function f(e,t,n,r,a){return a.tabHistoryNotChanged=!1,(0,Xt.retryFn)(Wt.post,3,function(e){return e-1})(on,{act:"a_start",peer:e,msgid:n,history:t,prevpeer:a.prevPeer,gid:a.gid,block:r}).then(function(t){var r=Vt(t,5),i=r[0],s=r[1],o=r[2],l=r[3],u=r[4];if(s.forEach(function(e){return(0,rn.oCacheAdd)(a,e)}),a.tabs||(a.tabs={}),a.dialog_tab_cts=u,a.tabs[e]||(a.tabs[e]=(0,Zt.normalizeTab)(a,i)),m(l,a),n){if(a.tabs[e]){var c=a.tabs[e].lastmsg,d=a.tabs[e].lastmsg_meta;extend(a.tabs[e],i),a.tabs[e].lastmsg=c,a.tabs[e].lastmsg_meta=d}}else extend(a.tabs[e],i);return a.admins=extend(a.admins,o),a.imQueue(e,!1),_(e,a)})["catch"](function(e){return(0,an.imWeirdCatch)("loadPeer",e)})}function _(e,t){var n=t.imQueue(e,!1),r=t.tabs[e],a=n.filter(function(n){return!(0,tn.isRidExist)(t,e,n.rid)});return r.msgs=a.reduce(function(e,t){return e["rid"+t.rid]=t.mess,e},r.msgs),t.imQueueSet(e,a),t.tabs[e].history=(0,Zt.restoreQueue)(a,t,u(t.tabs[e].history)),Promise.resolve(t)}function p(e,t,n){var r=n.imQueue(e,!1).filter(function(e){return e.failed&&e.mess.messageId!==t});return n.imQueueSet(e,r),n.tabs[e].history=(0,Zt.removeMessages)([t],u(n.tabs[e].history)),Promise.resolve(n)}function h(e,t){return(t.block_states[e]||{}).free===!1?Promise.resolve(t):(0,Wt.post)(on,{act:"a_block",peer:e,prevPeer:t.prevPeer,gid:t.gid}).then(function(e){var n=Vt(e,1),r=n[0];return m(r,t)})}function v(e,t){var n=t.peer;return Promise.resolve(t).then(function(t){return t.tabHistoryNotChanged=!1,(0,Zt.isFullyLoadedTab)(t,n)&&!t.tabs[n].msgid?(t.gid&&h(n,t),Promise.resolve(t).then(w)):((0,Zt.isFullyLoadedTab)(t,n)&&(t.tabs[n].msgid=!1),f(n,e,!1,!0,t))}).then(w).then(b.bind(null,n))}function b(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;return(0,Zt.isTabLoaded)(t,e)&&(t.tabs[e].last_touched=Date.now()),(0,Zt.isTabLoaded)(t,e)&&n&&(t.tabs[e].last_visited=Date.now()),t}function y(e,t,n){var r=n.msgid,a=n.peer;return!e&&(0,Zt.isFullyLoadedTab)(n,a)&&n.tabs[a].msgs[r]?(t===n.peer?n.tabHistoryNotChanged=!0:n.tabHistoryNotChanged=!1,n.gid&&h(a,n),Promise.resolve(n).then(w).then(b.bind(null,a))):f(a,!0,r,!0,n).then(w).then(function(){var e=(0,tn.getTab)(n,a);return e.msgid=r,n}).then(b.bind(null,a))}function C(e,t,n){if(rt(n))throw showFastBox({title:getLang("global_error"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},getLang("mail_message_wait_until_uploaded")),new Error("Cant change peer while loading somethind");var r=n.gid?"gim"+n.gid:"im";if(n.prevPeer=n.peer,n.peer=e,n.msgid=t||"",cur.peer=e,gn({sel:e?(0,Zt.convertPeerToUrl)(e):null,msgid:n.msgid,email:"",0:r}),0!=n.prevPeer&&b(n.prevPeer,n,!0),0!==e){var a=[];(0,Zt.isTabLoaded)(n,e)&&b(e,n,!0),a=n.tabbedPeers.map(function(e){return e.peer}).indexOf(e)<0?[{peer:e,type:"perm"}].concat(n.tabbedPeers):n.tabbedPeers.map(function(t){return t.peer==e&&"perm"!==t.type&&(t.type="perm"),t}),wt(a,!1,n)}else wt(n.tabbedPeers,!1,n);return mn(),Ce(n.prevPeer,n)}function E(e){if(cur.wallMentions=[],(0,Zt.isChatPeer)(e.peer)&&(0,Zt.isTabLoaded)(e,e.peer)){var t=e.tabs[e.peer],n=[];Object.keys(t.msgs||{}).reverse().forEach(function(e){var r=(0,tn.parserMessage)(t.msgs[e]),a=r&&r.userId;a&&a!=vk.id&&-1===n.indexOf(a)&&(0,Zt.isUserAliveInChat)(t,a)&&n.push(a)}),t.memberIds.forEach(function(e){-1===n.indexOf(e)&&(0,Zt.isUserAliveInChat)(t,e)&&n.push(e)}),n.forEach(function(t){if((0,rn.oCacheExists)(e,t)){var n=(0,rn.oCacheGet)(e,t),r=n.link.substring(1);cur.wallMentions.push([n.id,n.name,"@"+r,n.photo,void 0,void 0,void 0,r,n.first_name])}})}}function w(e){var t=e.peer;if(0===t)return Promise.resolve(e);var n=e.tabs[t],r=[];n.offset&&r.push("photos"),n.offset&&r.push("search"),(-2e9>t||n.offset)&&r.push("clear"),(0,Zt.isCommunityInterface)(e)&&r.push("block"),(0,Zt.isCommunityPeer)(t)&&(n.blocked_community?r.push("allow_community"):r.push("block_community")),!(0,Zt.isChatPeer)(t)&&!(0,Zt.isUserPeer)(t)||(0,Zt.isCommunityInterface)(e)||(0,Zt.isChatPeer)(t)&&(n.data.kicked||n.data.closed)||(inArray(t,e.mutedPeers)?r.push("unmute"):r.push("mute")),(0,Zt.isUserPeer)(t)&&!e.gid&&!n.blacklisted&&n.is_friend&&r.push("invite"),(0,Zt.isChatPeer)(t)&&!n.data.closed&&!n.data.kicked&&n.data.link&&r.push("invite_link"),!(0,Zt.isChatPeer)(t)||n.data.closed||n.data.kicked||r.push("topic","avatar","invite","leave"),(0,Zt.isChatPeer)(t)&&n.data.closed&&!n.data.kicked&&r.push("return"),(0,Zt.isChatPeer)(t)&&n.pinned&&(geByClass1("im-page--chat-header_hide-pin-actions")||(r.push((0,sn.isPinnedMessageVisibleInTab)(e,t)?"pin_hide":"pin_unhide"),r.push("unpin")));var a=(0,Zt.chatActions)(e);return e.curActions=r.sort(function(e,t){return _n[e]-_n[t]}).reduce(function(e,t){return e[t]=a[t],e},{}),Promise.resolve(e)}function S(e,t,n){var r=n.tabs[n.peer];return(0,Wt.post)(on,{peer:n.peer,whole:e,act:"a_history",offset:r.offset+(r.skipped||0),toend:t,gid:n.gid}).then(function(e){var t=Vt(e,4),a=t[0],i=t[1],s=t[2],o=t[3];return r.allShown=s,n.admins=extend(n.admins,o),r.history=a+g(r.history),r.historyToAppend=a,r.offset+=Object.keys(i).length,r.msgs=extend(r.msgs,i),n})}function T(e){var t=e.tabs[e.peer];return(0,Wt.post)(on,{peer:e.peer,act:"a_history",rev:1,offset:t.skipped,gid:e.gid}).then(function(n){var r=Vt(n,5),a=r[0],i=r[1],s=r[2];r[3],r[4];t.allShown=t.allShown||s,t.history=g(t.history)+a,t.historyToAppend=a;var o=Object.keys(i).length;return t.skipped-=o,t.offset+=o,t.msgs=extend(t.msgs,i),e})}function k(e,t,n,r){var a=e.tabs[t];return r===Qt.FLAG_OUTBOUND?a.out_up_to=n:a.in_up_to=n,e}function I(e,t,n){var r=e.tabs[t];return r.unread=(0,tn.countUnread)(t,e)+(r.unread>0?n:0),e}function P(e,t){return(0,Wt.post)(on,{act:"a_email_start",email:e,hash:t.writeHash}).then(function(e){var n=Vt(e,2),r=n[0],a=n[1];return Q(r,t),a})}function M(e){return(0,Wt.post)(on,{act:"a_get_key",uid:e.id,gid:e.gid}).then(function(t){var n=Vt(t,3),r=n[0],a=n[1],i=n[2];return extend({},e,{imKey:r,imUrl:a,imPart:i})})}function L(e){return(0,Wt.post)(on,{act:"a_get_ts",gid:e.gid}).then(function(t){var n=Vt(t,1),r=n[0];return extend({},e,{imTs:r})})}function A(e,t,n){var r=n.tabs[e];return r.msgs[t.messageId]&&(r.msgs[t.messageId].errored=1,r.history=(0,Zt.setMessageError)(e,t,u(r.history))),Promise.resolve(n)}function D(e,t,n,r){var a=r.tabs[e];return a.msgs[t]&&(a.msgs[t].errored=0,a.lastmsg_meta=n,a.lastmsg=t,a.history=(0,Zt.startResendMessage)(e,t,u(a.history))),Promise.resolve(r)}function O(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:!1;t.deletedDialog||(e.dialog_tabs=Object.keys(e.dialog_tabs).reduce(function(e,i){return!n&&!gt(i)(t)||a&&!a(i,e[i],t)||(e[i]=(0,Jt.arrayUnique)(r(e[i],i))),e},e.dialog_tabs))}function x(e,t){return 0===e.length?Promise.resolve(t):(0,Wt.post)(on,{act:"a_get_admin",admins:e.join(","),gid:t.gid}).then(function(e){var n=Vt(e,1),r=n[0];return t.admins=extend(t.admins,r),t})}function R(e,t){if(!inArray(e,t.tabbedPeers.map(function(e){return e.peer}))&&(0!==t.peer||t.searchText)&&!inArray(e,t.mutedPeers)){var n={peer:e,type:"temp"};wt(t.tabbedPeers.concat([n]),!1,t)}}function B(e,t,n){return(0,Zt.isReversedDialogs)(n)?t.concat([e]):[e].concat(t)}function F(e,t){if((0,Zt.isFullyLoadedTab)(t,e.peerId)){var n=(0,
tn.getTab)(t,e.peerId),r=u(n.history);n.msgs[e.messageId]=extend(!0,{},e),n.history=(0,Zt.editAndReplaceMessage)(t,e,r)}return Promise.resolve(t)}function N(e,t){var n=e.flags&Qt.FLAG_OUTBOUND,r=e.peerId;if((0,Zt.isTabLoaded)(t,r)){var i=t.tabs[r];if(i.deletedDialog=!1,!t.msg_local_ids_sort&&e.local?t.msg_local_ids_sort=a({},e.messageId,0):e.local&&(t.msg_local_ids_sort[e.messageId]=Object.keys(t.msg_local_ids_sort).length),n?i.unread=0:(i.lastmsg==e.messageId&&i.unread?H(t,1,e.peerId):(!i.unread&&H(t,1,e.peerId),i.unread++),R(e.peerId,t)),(0,Zt.isFullyLoadedTab)(t,r)){var s=u(i.history);i.skipped>0&&i.skipped++,i.offset++,i.msgs[e.messageId]=extend(!0,{},e),i.history=(0,Zt.appendToHistory)(t,e,s,!0,!0,!0),(0,nn.isOut)(e)&&(i.blocked_community=0,w(t))}return i.typing&&i.typing[e.userId]&&delete i.typing[e.userId],i.lastmsg=e.messageId,i.lastmsg_meta=e,b(e.peerId,t),O(t,i,!1,B.bind(null,r),pt.bind(null,t)),Promise.resolve(t)}return f(r,0,0,0,t).then(function(t){var a=t.tabs[r];return O(t,a,!1,B.bind(null,r),pt.bind(null,t)),b(e.peerId,t),n||R(e.peerId,t),t})}function H(e,t,n){e.cur_unread_cnt||(e.cur_unread_cnt={}),-1===t&&delete e.cur_unread_cnt[n],e.unread_cnt+=t}function j(e,t){if((0,Zt.isFullyLoadedTab)(t,e.peerId)){var n=t.tabs[e.peerId],r=n.unread;if(t=k(t,e.peerId,e.upToId,0),t=I(t,e.peerId,intval(n.skipped)),r>0&&!n.unread&&H(t,-1,e.peerId),!n.skipped){var a=u(n.history);n.history=(0,Zt.removewNewUnreadBarAndMerge)(t,a,e.peerId)}}else(0,Zt.isTabLoaded)(t,e.peerId)&&(t.tabs[e.peerId].unread>0&&H(t,-1,e.peerId),t.tabs[e.peerId].unread=0,t.tabs[e.peerId].in_up_to=e.upToId);return(0,Zt.isTabLoaded)(t,e.peerId)&&(t.dialog_tabs[en.FOLDER_UNREAD]=t.dialog_tabs[en.FOLDER_UNREAD].filter(function(t){return intval(t)!==e.peerId})),0!==t.unread_cnt||t.active_tab!==en.FOLDER_UNREAD||t.gid?Promise.resolve(t):mt(en.FOLDER_ALL,t)}function U(e,t){var n=t.tabs[e.peerId];if((0,Zt.isTabLoaded)(t,e.peerId)&&(n.out_up_to=e.upToId),(0,Zt.isFullyLoadedTab)(t,e.peerId)){var r=u(n.history);n.history=(0,Zt.markMessagesAsRead)(t,e.peerId,r)}return Promise.resolve(t)}function G(e,t,n,r,a){return a.text={attachedFiles:0},a.imQueue=e,a.imQueueResend=t,a.imQueueSet=n,a.imQueueComplete=r,Promise.resolve(a)}function q(e,t,n){var r=Vt(e,3),a=r[0],i=r[1],s=r[2];n.text.attachedFiles++,n._attach_cache||(n._attach_cache={}),s?n._attach_cache[a+i]=s:s=n._attach_cache[a+i];var o=n.peer;if((0,Zt.isFullyLoadedTab)(n,o)){var l=n.tabs[o];l.attaches||(l.attaches=[]);var u=t.select($t.DRAFT_STORE_OP,o)||{};if(a!==!1){l.attaches.push([a,i,s,l.attaches.length]);var c=extend({txt:""},u,{medias:l.attaches});t.update($t.DRAFT_STORE_OP,[o,c])}else if(a===!1&&"undefined"!=typeof i){var d=extend({txt:""},u,{medias:l.attaches});l.attaches=l.attaches.filter(function(e){return e[3]!==i}),t.update($t.DRAFT_STORE_OP,[o,d])}}return Promise.resolve(n)}function z(e,t,n){if((0,Zt.isFullyLoadedTab)(n,e)){var r=n.tabs[e];r.attaches=[];var a=t.select($t.DRAFT_STORE_OP,e)||{},i=extend({txt:""},a,{medias:[]});t.update($t.DRAFT_STORE_OP,[e,i])}return Promise.resolve(n)}function V(e,t,n){return e=e.map(function(e){return e.slice(0,2).join(",")}).join("*"),(0,Wt.post)(on,{act:"draft_medias",media:e}).then(function(e){var r=Vt(e,1),a=r[0];return n.tabs[t].attaches=a,n})}function W(e,t,n){if((0,Zt.isTabLoaded)(n,e)){var r=n.tabs[e];if(!r.attaches||!r.attaches.length){var a=t.select($t.DRAFT_STORE_OP,e)||{},i=(a.medias||[]).filter(function(e){return!e[2]});if(i.length>0)return V(a.medias,e,n);r.attaches=a.medias||[]}}return Promise.resolve(n)}function K(e,t){return e.set(W.bind(null,t,cur.imDb)).then(function(e){return(0,Zt.isTabLoaded)(e.get(),t)?e.get().tabs[t].attaches:[]})}function Y(e,t,n){return 1===e.length&&(e=e.map(function(e){var r=(0,tn.getMessage)(n,t,e),i=(0,tn.getAuthorFullName)(n,t,e);return i===!1?n.set(Fe.bind(null,a({},t,[r.userId]))).then(function(n){var a=(0,tn.getAuthorFullName)(n,t,e);return[e,r.text,r.date,a,r.attaches]}):[e,r.text,r.date,i,r.attaches]})),e}function Q(e,t){(0,Zt.normalizeTabsGotFromServer)(t,e);var n=t.tabs[t.peer];return t.tabs=Object.keys(e).reduce(function(n,r){var a=t.tabs[r]?t.tabs[r].msgs:{},i=extend({},a||{},e[r].msgs||{});return n[r]=extend(t.tabs[r]||{},e[r]),i&&(n[r].msgs=i),e[r].lastmsg||(n[r].lastmsg=!1),n},t.tabs),n&&(t.tabs[t.peer]=n),Promise.resolve(t)}function X(e,t,n,r){var a=(0,tn.getTab)(r,e);if(a){var i=t!==!1?t==cn?2:mobPlatforms[t]?1:0:a.last_seen[2];a.online=t,a.last_seen=[t,n||a.last_seen[1],i]}return Promise.resolve(r)}function J(e,t,n){var r=(0,tn.getTab)(n,e);return r&&(r.typing||(r.typing={}),r.typing[t]=Date.now()),Promise.resolve(n)}function $(e,t,n){return(0,Xt.pause)(ln+2).then(function(){if((0,Zt.isTabLoaded)(n,e)){var r=n.tabs[e];if(r.typing){var a=Date.now()-(r.typing[t]||0);a>=1e3*ln&&delete r.typing[t]}}return n})}function Z(e,t,n,r){if(r.peer===e){r.tabs[e].imdraft=clean(t);var a=n.select($t.DRAFT_STORE_OP,e)||{};n.update($t.DRAFT_STORE_OP,[e,extend(a,{txt:t})])}return Promise.resolve(r)}function ee(e,t,n){if((0,Zt.isTabLoaded)(n,e)){var r=n.tabs[e];if(!r.imdraft){var a=t.select($t.DRAFT_STORE_OP,e);a&&a.txt&&(r.imdraft=a.txt)}return Promise.resolve(r.imdraft||"")}return Promise.resolve("")}function te(e,t){if(t.selectedMessages||(t.selectedMessages=[]),1===e.length&&inArray(e[0],t.selectedMessages))t.selectedMessages=t.selectedMessages.filter(function(t){return t!==e[0]});else{var n=t.selectedMessages.concat(e);t.selectedMessages=(0,Jt.arrayUnique)(n).sort(function(e,t){return e-t})}return Promise.resolve(t)}function ne(e){return e.selectedMessages=[],Promise.resolve(e)}function re(e){return e.selectedMessages=[],Promise.resolve(e)}function ae(e,t){if((0,Zt.isFullyLoadedTab)(t,e.peerId)){var n=t.tabs[e.peerId],r=t.imQueue(e.peerId).filter(function(t){return t.failed&&t.rid!==e.randomId});t.imQueueSet(e.peerId,r),t.imQueueComplete(e.peerId,e.randomId),n.lastmsg_meta=e,n.lastmsg=e.messageId;var a=n.msgs["rid"+e.randomId];a&&(n.msgs[e.messageId]=e,delete n.msgs["rid"+e.randomId]),n.history=(0,Zt.replaceMessageAttrs)(t,u(n.history),e)}return Promise.resolve(t)}function ie(e,t){return Promise.resolve()}function oe(e,t){return(0,Wt.post)(on,{act:"a_get_media",id:e.messageId,gid:t.gid}).then(function(n){var r=Vt(n,3),a=r[0],i=r[1],s=r[2],o=t.tabs[e.peerId];return o.mediacontent||(o.mediacontent={}),o.mediacontent[e.messageId]=[a,i,s],le(e,t)})}function le(e,t){var n=t.tabs[e.peerId];return n.history=(0,Zt.replaceAttaches)(u(n.history),e,t),Promise.resolve(t)}function ue(e,t,n){var r=(0,Zt.dayFromVal)(t),a=n.tabs[e];return a.searchDay=r,a.searchOffset=0,a.searchAllLoaded=!1,Promise.resolve(n)}function ce(e,t,n){if(t){var r=n.tabs[t];r.searchText=e,r.searchOffset=0,r.searchAllLoaded=!1}else n.searchText=e,n.searchOffset=0,n.searchAllLoaded=!1;return Promise.resolve(n)}function de(e,t,n,r){return(0,Wt.post)(on,{act:"a_hints",str:e,gid:r.gid,query:n,peerIds:t.join(",")}).then(function(e){var t=Vt(e,3),n=t[0],a=t[1],i=t[2];return m(i,r),a.forEach(function(e){return(0,rn.oCacheAdd)(r,e)}),Q(n,r),Object.keys(n).sort(function(e,t){return n[e].order-n[t].order}).map(function(e){return n[e]})})}function ge(e,t,n,r){return de(e,t,n,r).then(function(e){return e.map(function(e){return{peerId:e.peerId,name:e.tab,photo:e.photo,lastmsg:e.lastmsg,online:e.online,is_friend:"friends"===n?!0:!1}})})}function me(e){return{peerId:e[0],name:e[1],tab:e[1],photo:e[2],lastmsg:e[3],href:e[4],online:e[5],is_friend:e[6],rating:e[7],local_index:!0}}function fe(e,t){return function(n,r){return e(r).then(function(e){var a=void 0;a=n===!1?e.list:e.search(n);var i=a.sort(t).map(me);return r.mapped_index||(r.mapped_index={}),i.forEach(function(e){r.mapped_index[e.peerId]=e}),i})}}function _e(e,t){var n=void 0;t.friendsTree=new Promise(function(e){n=e});var r=e.select($t.RECENT_SEARCH_OP);return(0,Xt.retryFn)(Wt.post,1,function(){return 4})(on,{act:"a_dialogs_preload",rs:r.join(","),gid:t.gid}).then(function(e){var r=Vt(e,1),a=r[0],i=Object.keys(a).map(function(e){return a[e]});return new vkIndexer(i,function(e){return e[1]},n),t})["catch"](function(e){return new vkIndexer([],function(e){return e[1]},n),t})}function pe(e){return e.hintsTree=new Promise(function(t){var n=Object.keys(e.hints_preloaded).map(function(t){return e.hints_preloaded[t]});new vkIndexer(n,function(e){return e[1]},t)}),Promise.resolve(e)}function he(e){var t=e.active_tab;return(0,Wt.post)(on,{act:"a_get_dialogs",offset:e.offset,tab:t,gid:e.gid}).then(function(n){var r=Vt(n,4),a=r[0],i=r[1],s=r[2],o=r[3];return s.forEach(function(t){return(0,rn.oCacheAdd)(e,t)}),m(o,e),Q(i,e),e.dialog_tabs[t]=e.dialog_tabs[t].concat(Object.keys(i).map(intval)),e.offset=a.offset,e.dialog_tabs_all[t]=!a.has_more,Promise.resolve(e)})}function ve(e,t){return(0,Wt.post)(on,{act:"a_search",q:e,from:"all",gid:t.gid,hash:t.writeHash,offset:t.searchOffset||0}).then(function(n){var r=Vt(n,5),a=r[0],i=r[1],s=r[2],o=r[3],l=r[4];return i.forEach(function(e){return(0,rn.oCacheAdd)(t,e)}),(0,Zt.normalizeTabsGotFromServer)(t,a),e===t.searchText&&(t.searchOffset=o,t.searchAllLoaded=l),Object.keys(a).filter(function(e){return!t.tabs[e]}).forEach(function(e){t.tabs[e]=a[e]}),[a,s]})}function be(e,t){var n=t.tabs[e];return n.searchAllLoaded}function ye(e,t){if(t.peer===e&&(0,Zt.isFullyLoadedTab)(t,e)){var n=t.tabs[e];return n.inplaceSearch}return!1}function Ce(e,t){if((0,Zt.isFullyLoadedTab)(t,e)){var n=t.tabs[e];delete n.inplaceSearch,delete n.searchOffset,delete n.searchAllLoaded,delete n.searchText,delete n.searchDay}return Promise.resolve(t)}function Ee(e,t){if((0,Zt.isFullyLoadedTab)(t,e)){var n=t.tabs[e];delete n.searchDay,n.searchOffset=0,n.searchAllLoaded=!1}return Promise.resolve(t)}function we(e,t){var n=t.tabs[e];return n.inplaceSearch=!0,Promise.resolve(t)}function Se(e,t){var n=t.tabs[e],r="";if(we(e,t),n.searchDay&&(r="day:"+n.searchDay),!r&&!n.searchText)return Promise.reject();var a="in:"+e+" "+r+" "+(n.searchText||"");return(0,Wt.post)(on,{act:"a_search",q:a,from:"in",gid:t.gid,hash:t.writeHash,offset:n.searchOffset||0}).then(function(e){var t=Vt(e,3),r=t[0],a=t[1],i=t[2];return n.searchOffset=a,n.searchAllLoaded=i,r})}function Te(e){return(0,Wt.post)(on,{act:"a_important",offset:e,part:e>0})}function ke(e,t,n){if((0,Zt.isFullyLoadedTab)(n,t)){var r=n.tabs[t];r.deleted=r.deleted?r.deleted.concat(e):e,r.history=(0,Zt.removeMessages)(e,u(r.history)),r.offset-=e.filter(function(e){return r.msgs[e]}).length,e.forEach(function(e){return delete r.msgs[e]})}return Promise.resolve(n)}function Ie(e,t,n,r,a){return(0,Wt.post)(on,{act:"a_mark",peer:t,hash:n,gid:a,msgs_ids:e.join(","),mark:r})}function Pe(e,t,n,r){if((0,Zt.isFullyLoadedTab)(r,t)){var a=r.tabs[t];a.deleted=a.deleted?a.deleted.concat(e):e,a.history=(0,Zt.removeMessagesWithRestore)(e,t,n,u(a.history)),a.offset-=e.filter(function(e){return a.msgs[e]}).length}return Promise.resolve(r)}function Me(e,t,n){if((0,Zt.isFullyLoadedTab)(n,t)){var r=n.tabs[t];r.deleted&&(r.deleted=r.deleted.filter(function(t){return t!==e})),r.history=(0,Zt.restoreMessage)(e,t,u(r.history)),r.offset++}return Promise.resolve(n)}function Le(e,t,n,r){return(0,Wt.post)(on,{act:"a_restore",id:e,peer:t,hash:n,gid:r})}function Ae(e,t){return t.msgid=e,Promise.resolve(t)}function De(e,t,n,r){if((0,Zt.isTabLoaded)(r,t)){r.pendingForward=[];var a=r.tabs[t];a.fwdMessages=e,n.update($t.FWD_STORE_OP,[t,e])}return Promise.resolve(r)}function Oe(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1;if((0,Zt.isTabLoaded)(n,e)){var a=n.tabs[e];return a.fwdMessages||(a.fwdMessages=(0,Jt.toArray)(t.select($t.FWD_STORE_OP,e)||{}),1!==a.fwdMessages.length||a.fwdMessages[0].length||(a.fwdMessages=[])),r?Promise.resolve(a.fwdMessages):Promise.resolve(a.fwdMessages.map(function(e){return e[0]||e}))}return Promise.resolve([])}function xe(e,t){return t.pendingForward=e,Promise.resolve(t)}function Re(e,t,n){if((0,Zt.isTabLoaded)(n,e)){n.blockedFlagUpdates||(n.blockedFlagUpdates={}),n.blockedFlagUpdates[e]=!0,O(n,n.tabs[e],!0,function(t){return t.filter(function(t){return t!==e})}),n.tabs[e].unread>0&&H(n,-1,e);var r=n.tabs[e];r.deletedDialog=!0;var a=n.tabbedPeers.filter(function(t){return t.peer!==e});return wt(a,!0,n),t.then(function(t){var a=Vt(t,2);a[0],a[1];return delete n.blockedFlagUpdates[e],r.msgs=null,r.history=null,r.unread=0,r.lastmsg=!1,r.lastmsg_meta=null,n})}}function Be(e,t,n){return n.tabs[e].tab=t,Promise.resolve(n)}function Fe(e,t){if(isEmpty(e))return Promise.resolve(t);var n=Object.keys(e).map(function(t){return t+":"+e[t].join(",")}).join(";");return(0,Wt.post)(on,{act:"a_load_member",need:n}).then(function(e){var n=Vt(e,1),r=n[0];return r.forEach(function(e){return(0,rn.oCacheAdd)(t,e)}),t})}function Ne(e,t,n,r){if(0===t.length)return Promise.resolve(r);var a=t.filter(function(e){return!(0,Zt.isTabLoaded)(r,e.peerId)}).map(function(e){return f(e.peerId,0,0,0,r)}),i=e.filter(function(e){return e.kludges.source_act===Zt.CHAT_INVITE_USER||e.kludges.source_act===Zt.CHAT_INVITE_BY_LINK}).filter(function(e){return r.tabs[e.peerId]&&!(0,rn.oCacheExists)(r,e.kludges.source_mid)}).reduce(function(e,t){var n=t.kludges.source_mid;return e[t.peerId]||(e[t.peerId]=[]),n?inArray(n,e[t.peerId])||e[t.peerId].push(n):e[t.peerId].push(t.userId),e},{}),s=t.filter(function(e){return e.flags&Qt.FLAG_OUTBOUND&&!e.local}).map(function(e){return e.kludges.from_admin}).filter(function(e){return e&&!r.admins[e]});return 0===Object.keys(i).length&&0===s.length&&0===a.length?Promise.resolve(r):(n.pause(),Promise.all([Fe(i,r),x(s,r),Promise.all(a)])["catch"](function(){return r}).then(function(){return n.resume()}).then(function(){return r}))}function He(e,t,n,r){var a=r.tabs[n];return t!==vk.id?Promise.resolve(r):((0,Zt.isTabLoaded)(r,n)&&(e===Zt.CHAT_KICK_USER?a.data.closed=!0:e===Zt.CHAT_INVITE_USER&&(a.data.closed=!1),r.peer===n&&(r=w(r))),Promise.resolve(r))}function je(e,t,n){var r=n.mutedPeers.filter(function(t){return t!==e});return t&&r.push(e),n.mutedPeers=r,cur.mutedPeers=n.mutedPeers,w(n)}function Ue(e,t){return t.stack=e,Promise.resolve(t)}function Ge(e,t,n,r){if((0,Zt.isFullyLoadedTab)(r,t)){var a=r.tabs[t];e.filter(function(e){return a.msgs[e]}).forEach(function(e){var i=(0,tn.getMessage)(r,t,e),s=n?i.flags|Qt.FLAG_IMPORTANT:i.flags&~Qt.FLAG_IMPORTANT;i.flags=s,a.msgs[e]=i,a.history=(0,Zt.updateStar)(e,n,u(a.history))})}return Promise.resolve(r)}function qe(e,t,n){n.importants||(n.importants={});var r=n.importants[t]||0;return r!==e&&(n.important_cnt+=e,n.importants[t]=e),Promise.resolve(n)}function ze(e,t){return(0,Wt.post)(on,{act:"a_spam",offset:e,gid:t,part:e>0})}function Ve(e,t){return(0,Wt.post)(on,{act:"a_flush_spam",gid:t,hash:e})}function We(e,t,n){return n.creationType=e,n.creationFilter=t,Promise.resolve(n)}function Ke(e,t){return(0,Wt.post)(on,{act:"a_owner_photo",photo:JSON.parse(e).data[0],peer:t})}function Ye(e,t){return t.next_chat_avatar=e,Promise.resolve(t)}function Qe(e,t,n){return(0,Wt.post)("al_page.php",{act:"owner_photo_save",peer:e,_query:t}).then(function(e){return n})}function Xe(e,t,n,r){return r.creating=!0,r.longpoll.pause(),(0,Wt.post)(on,{act:"a_multi_start",hash:r.writeHash,peers:t.join(","),title:n}).then(function(e){var t=Vt(e,1),n=t[0];return r.next_peer=n.peerId,r.tabs[n.peerId]=n,O(r,n,!1,function(e){return[n.peerId].concat(e)}),r.longpoll.resume(),r}).then(function(t){return e?Qe(t.next_peer,e,t):t}).then(function(e){return e.creating=!1,e})["catch"](function(e){throw r.creating=!1,r.longpoll.resume(),e})}function Je(e){var t=void 0;e.resync_in_process=new Promise(function(e){t=e});var n=Object.keys(e.tabs).length,r=e.active_tab;return(0,Wt.post)(on,{act:"a_resync",sel:e.peer,gid:e.gid,loaded:n,tab:r,add_peers:e.tabbedPeers.map(function(e){return e.peer}).join(",")}).then(function(n){var i=Vt(n,5),s=i[0],o=i[1],l=i[2],c=i[3],d=i[4];o.forEach(function(t){return(0,rn.oCacheAdd)(e,t)}),(0,Zt.normalizeTabsGotFromServer)(e,s),l.user_unread&&handlePageCount("msg",l.user_unread),(0,Jt.lplog)("Resync success","success");var g=e.peer,m=void 0;if((0,Zt.isReservedPeer)(g))m=Promise.resolve(!1);else{var f={tabs:a({},g,e.tabs[g]),oCache:{}};m=Q(a({},g,s[g]),f)}return m.then(function(n){e.tabs=s,e.admins=extend(e.admins,c),n&&(e.tabs[g]=n.tabs[g],e.tabs[g].history=(0,Zt.restoreQueue)(g,e,u(e.tabs[g].history))),e.loadingDialogs=!1,e.offset=Object.keys(s).length,e.mutedPeers=l.mutedPeers,e.lastDialogsOptions={has_more:l.has_more},e.dialog_tab_cts=l.folder_cts,e.dialog_tabs[r]=d.map(intval);var a=e.dialog_tabs[r].map(function(t){return e.tabs[t]});return Object.keys(e.dialog_tabs).filter(function(e){return e!=r}).forEach(function(t){r==en.FOLDER_ALL?e.dialog_tabs[t]=a.filter(gt(t)).map(function(e){return e.peerId}):e.dialog_tabs[t]=[]}),delete e.resync_in_process,setTimeout(t.bind(null,!0),0),at(intval(l.unread),e)})})["catch"](function(t){return(0,Jt.lplog)("Resync error: "+t.message+" "+t.stack,"error"),(0,Xt.pause)(2).then(Je.bind(null,e))})}function $e(e,t,n,r){if((0,Zt.isTabLoaded)(r,e)){var a=r.tabs[e];d(a.inactiveIds,n),c(a.memberIds,n),n===vk.id&&(a.data.kicked=0)}return Promise.resolve(r)}function Ze(e,t,n,r){if((0,Zt.isTabLoaded)(r,e)){var a=r.tabs[e];c(a.inactiveIds,n),n===vk.id&&t!=n&&(a.data.kicked=1)}return Promise.resolve(r)}function et(e,t){return t.lockedSending=e,Promise.resolve(t)}function tt(e,t,n){return e&&!n.delayed_message?(n.delayed_message=e,n.delayed_ts=t):e||(n.delayed_message=e,n.delayed_ts=t),Promise.resolve(n)}function nt(){return window.Upload&&Upload.options?Object.keys(Upload.options).map(function(e){return Upload.options[e]}).filter(function(e){return e.xhr&&4!==e.xhr.readyState&&0!==e.xhr.readyState}).length>0:!1}function rt(e){var t=e.textMediaSelector;return!!t.urlAttachmentLoading||nt()}function at(e,t){return t.unread_cnt=e,t.dialog_tab_cts[en.FOLDER_UNREAD]=e,Promise.resolve(t)}function it(e,t){return t.ctrl_submit=!!e,(0,Wt.post)(on,{act:"a_save_ctrl_submit",to:t.peer,hash:t.tabs[t.peer].hash,value:e?1:0}).then(function(e){return t})}function st(e,t,n){var r=n.tabs[e];return r.bind_url_to_attach||(r.bind_url_to_attach=t.select($t.ATTACH_STORE_OP,e)||{}),Promise.resolve(r.bind_url_to_attach)}function ot(e,t,n,r,a,i){return st(e,cur.imDb,i).then(function(s){return s[r]=[t,n],a.update($t.ATTACH_STORE_OP,[e,s]),Promise.resolve(i)})}function lt(e,t,n){var r=n.tabs[e];return r.bind_url_to_attach={},t.update($t.ATTACH_STORE_OP,[e,{}]),Promise.resolve(n)}function ut(e,t,n){return function(){n.update_old_title=e;var r=Object.keys(n.cur_unread_cnt).length;if(0===r)return document.title=e?e:document.title,setFavIcon("/images/icons/favicons/fav_im"+t+".ico"),clearInterval(n.update_title_to),void(n.update_title_to=!1);if(e)document.title=e,setFavIcon("/images/icons/favicons/fav_im"+t+".ico"),e=!1;else{e=document.title;var a=r>9?10:r;setFavIcon("/images/icons/favicons/fav_im"+a+t+".ico"),document.title=winToUtf(getLang("mail_im_new_messages",r))}}}function ct(e,t,n){n.cur_unread_cnt||(n.cur_unread_cnt={}),t&&!inArray(e,n.mutedPeers)&&(n.cur_unread_cnt[e]=!0);var r=document.title,a=window.devicePixelRatio>=2?"_2x":"";if(t&&!n.update_title_to){var i=ut(r,a,n);n.update_title_to=setInterval(i,1e3),i()}else!t&&n.update_old_title&&(document.title=n.update_old_title,n.cur_unread_cnt={},r=!1,n.update_old_title=!1,setFavIcon("/images/icons/favicons/fav_im"+a+".ico"),clearInterval(n.update_title_to),n.update_title_to=!1);return Promise.resolve(n)}function dt(e,t,n,r,a){return(0,Zt.isFullyLoadedTab)(a,e)&&(a.tabs[e].scrollTop=intval(t),a.tabs[e].scrollBottom=intval(n),a.tabs[e].contHeight=intval(r)),Promise.resolve(a)}function gt(e){return e===en.FOLDER_ALL?function(){return!0}:e===en.FOLDER_UNREAD?function(e){return e.unread>0}:function(t){return t.folders&en.FOLDER_MASKS[e]}}function mt(e,t){t.active_tab=e,(0,Kt.updateLocation)({tab:e===en.FOLDER_ALL?null:e});var n=[];if(e!==en.FOLDER_ALL&&!(0,Zt.isReversedDialogs)(t)){var r=t.dialog_tabs[e];n=t.dialog_tabs[en.FOLDER_ALL].map(function(e){return t.tabs[e]}).filter(gt(e)).map(function(e){return e.peerId}),t.dialog_tabs[e]=r.length>=n.length?r:n}return t.offset=t.dialog_tabs[e].length,Promise.resolve(t)}function ft(e,t,n){return e===Qt.SET_DIRECTORIES&&n.folders&t?!1:e!==Qt.RESET_DIRECTORIES||n.folders&t?!0:!1}function _t(e,t,n){return t!==Qt.RESET_DIRECTORIES||e.folders&en.FOLDER_MASKS[n]?t===Qt.REPLACE_DIRECTORIES?e.folders&en.FOLDER_MASKS[n]?-1:1:t===Qt.SET_DIRECTORIES?1:-1:0}function pt(e,t,n,r){var a=e.dialog_tabs_all;if(a[en.FOLDER_ALL]||a[t])return!0;if(n.filter(function(e){return e===r.peerId}).length>0)return!0;if("r"===r.lastmsg[0])return!0;var i=n.map(function(t){return e.tabs[t]}).filter(function(t){return(0,Zt.isReversedDialogs)(e)?t.lastmsg>r.lastmsg:t.lastmsg<r.lastmsg});return i.length>0?!0:!1}function ht(e,t,n,r,a){if((0,Zt.isTabLoaded)(a,e)){var i=a.tabs[e];return n===Qt.REPLACE_DIRECTORIES&&(t^=i.folders),ft(n,t,i)&&Object.keys(en.FOLDER_MASKS).filter(function(e){return en.FOLDER_MASKS[e]&t}).forEach(function(e){a.dialog_tab_cts[e]+=_t(i,n,e)}),n===Qt.SET_DIRECTORIES?a.tabs[e].folders|=t:n===Qt.RESET_DIRECTORIES?a.tabs[e].folders&=~t:a.tabs[e].folders=t^=i.folders,O(a,a.tabs[e],!0,function(t,n){return t.concat([e]).map(function(e){return a.tabs[e]}).filter(gt(n)).map(function(e){return e.peerId})},pt.bind(null,a)),Promise.resolve(a)}return f(e,0,0,0,a).then(ht.bind(null,e,t,n,a))}function vt(e){return(0,Wt.post)(on,{act:"a_get_mutex_key",gid:e})}function bt(e,t){return m(a({},e,{free:!0}),t),(0,Wt.post)(on,{act:"a_block_release",peer:e,gid:t.gid}).then(function(){return t})}function yt(e,t){var n=ls.get("comm_mute_"+t.gid)?1:0;return e&&(n=1^n),ls.set("comm_mute_"+t.gid,n),t.mute=n,Promise.resolve(t)}function Ct(e,t,n,r){return(0,Wt.post)(on,{act:"a_restore_dialog",hash:t,gid:r.gid,spam:n?1:0,peer:e}).then(function(t){return r.tabs[e].deletedDialog=!1,O(r,r.tabs[e],!1,function(t){return[e].concat(t)}),r.tabs[e].unread=t,r})}function Et(e,t,n){return(0,Wt.post)(on,{act:"a_spam_dialog",peer:e,gid:n.gid,hash:t})}function wt(e,t,n){return n.tabbedPeers=e,(0,Zt.isClassicInterface)(n)&&(gn({peers:n.tabbedPeers.filter(function(e){var t=e.peer,r=e.type;return t!==n.peer&&"perm"===r}).map(function(e){return(0,Zt.getBareTab)(e.peer,n)}).filter(function(e){return!e.deletedDialog}).map(function(e){return e.peerId}).map(Zt.convertPeerToUrl).join("_")}),t&&mn()),Promise.resolve(n)}function St(e){return e.peer?ye(e.peer,e)?be(e.peer,e):(0,Zt.isFullyLoadedTab)(e,e.peer)?e.tabs[e.peer].allShown:!1:!0}function Tt(e,t){var n=t.tabs[e];return(0,Zt.isFullyLoadedTab)(t,e)&&(n.skipped=null,n.msgs=null,n.offset=null,n.allShown=null,n.history=null),Promise.resolve(t)}function kt(e,t){var n=t.tabs[e];return(0,Zt.isFullyLoadedTab)(t,e)&&(n.history=g(n.history)),Promise.resolve(t)}function It(e,t){return t.go_to_end_visible=e,Promise.resolve(t)}function Pt(e,t,n){if(!(0,Zt.isCommunityPeer)(t))return Promise.resolve(n);var r=(0,tn.getTab)(n,t);return r.blocked_community=!e,(0,Wt.post)(on,{act:"a_toggle_community",peer_id:t,hash:r.hash,state:e?1:0}).then(function(){return w(n)})}function Mt(e,t){if(0!==t.peer&&(0,Zt.isFullyLoadedTab)(t,t.peer)){var n=(0,tn.getTab)(t,t.peer);n.history=u(n.history),e(n.history)}return Promise.resolve(t)}function Lt(e){return e.audio_msg.isRecording?Promise.reject():(e.audio_msg.isRecording=!0,Promise.resolve(e))}function At(e){return e.audio_msg.isRecording=!1,Promise.resolve(e)}function Dt(e,t){return t.voice_message_available=e,Promise.resolve(t)}function Ot(e){gn({act:e?"create":null}),mn()}function xt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;gn({q:e}),mn()}function Rt(e){return"undefined"==typeof e.chatResizeInitialized&&(e.chatResizeInitialized=!0,(0,Zt.getClassicChatHeight)()>window.clientHeight()&&(0,Zt.setClassicChatHeight)(0)),Promise.resolve(e)}function Bt(e,t,n){return(0,Wt.post)(on,{act:"a_join_chat",chat_id:e,hash:t,write_hash:n.writeHash}).then(function(e){var t=Vt(e,4),r=t[0],a=t[1],i=t[2],s=t[3];return i.forEach(function(e){return(0,rn.oCacheAdd)(n,e)}),n.tabs[r]=a,O(n,a,!1,B.bind(null,r),pt.bind(null,n)),n.admins=extend(n.admins,s),[r]})}function Ft(e,t){return(0,Wt.post)(on,{act:"a_reset_link",chat_id:e,write_hash:t.writeHash})}function Nt(e){return fn({invite_chat_id:null,invite_hash:null}),e.invitation=void 0,Promise.resolve(e)}function Ht(e,t){var n=(0,Jt.arrayUnique)([e].concat(t.select($t.RECENT_SEARCH_OP))).slice(0,500);t.update($t.RECENT_SEARCH_OP,n)}function jt(e){e.update($t.RECENT_SEARCH_OP,[])}function Ut(e,t){var n=t.select($t.RECENT_SEARCH_OP).filter(function(t){return t!==e});return t.update($t.RECENT_SEARCH_OP,n),n}function Gt(e,t,n){var r=n.tabs[t],a=(0,tn.getMessage)(n,t,e);return r.data.kicked||r.data.closed||a.kludges.source_act||(r.pinned=a),Promise.resolve(n)}function qt(e,t){var n=t.tabs[e];return n.pinned=null,Promise.resolve(t)}function zt(e,t,n,r){var i=(r.tabs[n],(0,tn.getMessage)(e,n,t)),s=i.userId;return(0,rn.oCacheGet)(r,s)?Promise.resolve(r):Fe(a({},n,[s]),r)}Object.defineProperty(t,"__esModule",{value:!0}),t.getMessageLocalId=t.getPinnedMessage=t.unpinMessage=t.pinMessage=t.deleteDialog=t.markDialogAnswered=t.toggleDialogImportant=t.favMessage=t.toggleMutePeer=t.returnToChat=t.leaveChat=t.updateChatPhoto=t.addNewMember=t.updateChatTopic=t.flushHistory=t.sendTyping=t.searchLocalHints=t.searchFriends=t.deliverMessage=t.readLastMessages=t.ACTION_PRIORITIES=t.TYPING_PERIOD=void 0;var Vt=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.strHistory=g,t.updateBlockStates=m,t.loadPeer=f,t.restoreHistoryQueue=_,t.removeFailed=p,t.selectPeer=v,t.selectPeerOnMessage=y,t.changePeer=C,t.updateMentions=E,t.setActions=w,t.loadMoreHistory=S,t.loadLessHistory=T,t.createEmailChat=P,t.loadLongPollKey=M,t.loadLongPollTs=L,t.setMessageErrored=A,t.resendMessage=D,t.loadAdmins=x,t.editMessage=F,t.addMessage=N,t.markInboundMessagesAsRead=j,t.markOutboundMessagesAsRead=U,t.initTextStore=G,t.addMediaStore=q,t.cleanMediaStore=z,t.restoreAttaches=W,t.getAttaches=K,t.processFwd=Y,t.mergeTabs=Q,t.updateOnline=X,t.setTyping=J,t.waitTyping=$,t.saveTextDraft=Z,t.getTextDraft=ee,t.addSelection=te,t.cleanSelected=ne,t.dropSelection=re,t.replaceMessage=ae,t.saveMedia=ie,t.loadMedia=oe,t.replaceMediaAttachesStore=le,t.setCurrentSearchDate=ue,t.setCurrentSearch=ce,t.searchHints=de,t.searchHintsIndex=ge,t.localIndexToDialog=me,t.fetchFriends=_e,t.fetchLocalHints=pe,t.loadDialogs=he,t.searchMessages=ve,t.isSearchAllLoaded=be,t.isSearchingInplace=ye,t.cancelSearch=Ce,t.clearDate=Ee,t.searchInplaceStart=we,t.searchMessagesInplace=Se,t.loadImportant=Te,t.removeMessages=ke,t.removeMessageSend=Ie,t.removeMessagesWithRestore=Pe,t.restoreMessage=Me,t.restoreMessageSend=Le,t.changeMessage=Ae,t.forwardMessages=De,t.getForwardedMessages=Oe,t.prepareForward=xe,t.deletedDialog=Re,t.setChatTitle=Be,t.loadChatMember=Fe,t.checkNewPeople=Ne,t.updateActions=He,t.setMutedPeer=je,t.setExecStack=Ue,t.updateFavMessage=Ge,t.updateImportant=qe,t.loadSpam=ze,t.flushSpam=Ve,t.setCreationType=We,t.getOwnerPhoto=Ke,t.presetAvatar=Ye,t.setChatPhoto=Qe,t.createChat=Xe,t.resync=Je,t.chatUserHasJoined=$e,t.chatUserHasLeft=Ze,t.toggleSendingAbility=et,t.setDelayedMessage=tt,t.isAnythingLoading=rt,t.updateUnreadCount=at,t.changeSubmitSettings=it,t.getBindAttachToUrl=st,t.bindAttachToUrl=ot,t.clearAttachToUrl=lt,t.updateFavAndTitle=ct,t.saveHistoryScroll=dt,t.filterFromTab=gt,t.changeDialogsTab=mt,t.updateFolderState=ht,t.getMutexQueue=vt,t.releaseBlock=bt,t.toggleCommunityMute=yt,t.restoreDialog=Ct,t.spamDialog=Et,t.updateTabbedPeers=wt,t.isEverythingLoaded=St,t.cleanTab=Tt,t.stringifyTab=kt,t.updateGoToEndVisibility=It,t.toggleCommunityMessages=Pt,t.updateHistory=Mt,t.startRecording=Lt,t.cancelRecording=At,t.setVoiceMessageAvail=Dt,t.toggleConversation=Ot,t.updateSearchQuery=xt,t.initializeChatResize=Rt,t.joinChat=Bt,t.resetInviteLink=Ft,t.leaveInvitation=Nt,t.saveRecentSearchPeer=Ht,t.resetRecentSearch=jt,t.removeFromRecentSearch=Ut,t.pinMessageOptimistic=Gt,t.unpinMessageOptimistic=qt,t.checkChatMember=zt;var Wt=n(109),Kt=n(21),Yt=n(74),Qt=r(Yt),Xt=n(17),Jt=n(123),$t=n(26),Zt=n(41),en=n(27),tn=n(86),nn=n(15),rn=n(90),an=n(36),sn=n(119),on="al_im.php",ln=t.TYPING_PERIOD=5,un=2e4,cn=8,dn=(0,Kt.updateLazyLocation)(),gn=dn.scheduleNav,mn=dn.commitNav,fn=dn.scheduleNavWithTimeOut,_n=t.ACTION_PRIORITIES={block:1,fav:1,chat:2,invite:2,invite_link:3,topic:3,avatar:4,photos:5,search:6,pin_hide:7,pin_unhide:7,unpin:8,mute:10,unmute:10,clear:11,leave:12,"return":12,block_community:12,allow_community:12};t.readLastMessages=l(function(e,t){var n=t.tabs[e],r=Object.keys(n.msgs).map(function(n){return(0,tn.getMessage)(t,e,n)}).filter(function(e){return!(0,nn.isOut)(e)}).map(function(e){return e.messageId}).sort(function(e,t){return t-e});return n.skipped>0&&(r=r.filter(function(e){return intval(e)<=n.lastmsg-n.skipped})),r=intval(r.shift()),r<=n.in_up_to?Promise.resolve(t):(t.longpoll.push([Qt.readInboundEvent([6,e,r])]),(0,Wt.post)(on,{peer:e,ids:[r],hash:n.hash,act:"a_mark_read",gid:t.gid}).then(function(){return k(t,e,r,Qt.FLAG_OUTBOUND)}))}),t.deliverMessage=l(function(e,t,n){var r=Date.now()+rand(0,100).toFixed(0),a=n.tabs[e],i=t.attaches.map(function(e){return"fwd"===e[0]?["mail",e[1].join(";")]:e}).map(function(e){return e[0]+":"+e[1]}).join(","),s=t.attaches.filter(function(e){return"share"===e[0]}).pop(),o=void 0;return s&&(o=s[2].url),(0,Xt.retryFn)(Wt.post,1)(on,{act:"a_send",to:e,hash:a.hash,msg:t.message,media:i,guid:r,share_url:o,random_id:t.rid,gid:n.gid,sticker_referrer:t.sticker_referrer},un).then(function(e){var t=Vt(e,1),r=t[0];return n.version!==r.version&&nav.reload({force:!0}),n})}),t.searchFriends=fe(function(e){return e.friendsTree},function(e,t){return t[3]-e[3]}),t.searchLocalHints=fe(function(e){return e.hintsTree},function(e,t){return e[3]-t[3]}),t.sendTyping=l(function(e,t){return t.tabs[e].lastTyping=Date.now(),(0,Wt.post)(on,{act:"a_typing",peer:e,gid:t.gid,hash:t.tabs[e].hash}).then(function(e){return t},function(e){return t})}),t.flushHistory=l(function(e,t){return Re(e,(0,Wt.post)("al_im.php",{act:"a_flush_history",id:e,from:"im",gid:t.gid,hash:t.tabs[e].hash}),t)}),t.updateChatTopic=l(function(e,t,n){var r=n.tabs[e];return(0,Wt.post)(on,{act:"a_get_chat",cur_peers:r.memberIds.join(","),cur_title:r.name,chat:e-2e9,new_title:t,hash:r.hash}).then(function(t){var a=Vt(t,2),i=(a[0],a[1]);return n.tabs[e]=extend(r,i),n})}),t.addNewMember=l(function(e,t,n){var r=n.tabs[e];return(0,Wt.post)(on,{act:"a_get_chat",cur_peers:r.memberIds.join(","),cur_title:r.name,chat:e-2e9,new_peer:t.join(","),hash:r.hash}).then(function(t){var a=Vt(t,2),i=a[0],s=a[1];return i.forEach(function(e){if(e.error)throw new Error(e.message)}),n.tabs[e]=extend(r,s),n})}),t.updateChatPhoto=l(function(e,t){return e.kludges.source_act===Zt.CHAT_PHOTO_REMOVE?(delete t.tabs[e.peerId].photo,Promise.resolve(t)):(0,Wt.post)(on,{act:"a_get_chat_photo",msg_id:e.messageId}).then(function(n){var r=Vt(n,2),a=r[0],i=r[1];t.chat_photo_msg=i;var s=t.tabs[e.peerId];if(t.tabs[e.peerId].photo=a,(0,Zt.isFullyLoadedTab)(t,e.peerId)){var o=e.kludges.source_act;s.history=(0,Zt.addChatPhotoToUpdate)(e,o,t,u(s.history))}return t})}),t.leaveChat=l(function(e,t){return(0,Wt.post)(on,{act:"a_leave_chat",chat:e-2e9,hash:t.tabs[e].hash}).then(He.bind(null,Zt.CHAT_KICK_USER,vk.id,e,t))}),t.returnToChat=l(function(e,t){return(0,Wt.post)(on,{act:"a_return_to_chat",chat:e-2e9,hash:t.tabs[e].hash}).then(He.bind(null,Zt.CHAT_INVITE_USER,vk.id,e,t))}),t.toggleMutePeer=l(function(e,t,n){return(0,Wt.post)(on,{act:"a_mute",peer:e,hash:n.tabs[e].hash,gid:n.gid,value:t}).then(function(){var r=t?"mute":"unmute";
return window.Notifier&&Notifier.lcSend("im",{act:r,peer:e}),n}).then(je.bind(null,e,t))}),t.favMessage=l(function(e,t,n,r){return Ge(e,n,t,r),(0,Wt.post)(on,{act:"a_mark_important",ids:e,val:t?1:0,from:"im",gid:r.gid,peer:n,hash:r.tabs[n].hash}).then(function(e){return r})}),t.toggleDialogImportant=l(function(e,t){var n=en.FOLDER_MASKS[en.FOLDER_IMPORTANT],r=t.tabs[e].folders&n,a=r?Qt.resetDirectoriesEvent:Qt.setDirectoriesEvent;return t.longpoll.push([a([0,e,n,!0])]),(0,Wt.post)(on,{act:"a_dialog_star",val:r?0:1,peer:e,hash:t.tabs[e].hash,gid:t.gid}).then(function(){return t})}),t.markDialogAnswered=l(function(e,t,n){var r=en.FOLDER_MASKS[en.FOLDER_UNRESPOND];return n.longpoll.push([Qt.resetDirectoriesEvent([0,e,r,!0]),Qt.readInboundEvent([6,e,t])]),(0,Wt.post)(on,{act:"a_mark_answered",peer:e,lastmsg:t,hash:n.tabs[e].hash,gid:n.gid}).then(function(){return n})}),t.deleteDialog=l(function(e,t){return O(t,t.tabs[e],!0,function(t){return t.filter(function(t){return t!==e})}),t.tabs[e].deletedDialog=!0,(0,Wt.post)(on,{act:"a_delete_dialog",peer:e,gid:t.gid,hash:t.tabs[e].hash}).then(function(n){return n[0]?(wt(t.tabbedPeers.filter(function(t){return t.peer!==e}),!0,t),t.tabs[e].unread=0,t.tabs[e].lastmsg=!1,t.tabs[e].lastmsg_meta=null):(t.tabs[e].deletedDialog=!1,O(t,t.tabs[e],!1,B.bind(null,e),pt.bind(null,t))),n})}),t.pinMessage=l(function(e,t,n){var r=n.tabs[t];return r.data.kicked||r.data.closed?Promise.resolve(n):(0,Wt.post)(on,{act:"a_pin_message",msgid:e,chat:t,hash:n.tabs[t].hash}).then(function(e){var a=Vt(e,1),i=a[0];return n.tabs[t]=Object.assign({},r,i),n})}),t.unpinMessage=l(function(e,t){var n=t.tabs[e];return n.data.kicked||n.data.closed?Promise.resolve(t):(0,Wt.post)(on,{act:"a_unpin_message",chat:e,hash:t.tabs[e].hash}).then(function(r){var a=Vt(r,1),i=a[0];return t.tabs[e]=Object.assign({},n,i),t})}),t.getPinnedMessage=l(function(e,t){var n=t.tabs[e];return(0,Wt.post)(on,{act:"a_get_pinned_message",chat:e,hash:t.tabs[e].hash}).then(function(e){var r=Vt(e,1),a=r[0];return n.pinned=a||null,t})}),t.getMessageLocalId=l(function(e,t,n){n.tabs[e];return(0,Wt.post)(on,{act:"a_get_message_local_id",chat:e,chat_local_id:t,hash:n.tabs[e].hash})})},function(e,t){e.exports=function(e,t,n,r){if(!(e instanceof t)||void 0!==r&&r in e)throw TypeError(n+": incorrect invocation!");return e}},function(e,t){"use strict";function n(e,t,n){return t&&(t.newImJs="1"),new Promise(function(r,a){ajax.post(e,t,{timeout:n,onDone:function(){r.apply(null,[[].concat(Array.prototype.slice.call(arguments))])},onFail:function(){return a.apply(null,arguments),!0}})})}function r(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=a(e,t,n),i=r.request;r.cancel;return i}function a(e,t){function n(){a.abort()}var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=void 0;a=window.XDomainRequest?new XDomainRequest:ajax._getreq();var i=new Promise(function(n,i){var s,o=Date.now(),l=r.timeout||60,u=ajx2q(t);if(window.XDomainRequest)a.open("get",e+"?"+u),a.ontimeout=function(){i("",{})},a.onerror=function(){i("",{})},a.onload=function(){n(a.responseText)},setTimeout(function(){a.send()},0);else{a.onreadystatechange=function(){4==a.readyState&&(clearInterval(s),a.status>=200&&a.status<300?n(a.responseText,a):i(a.responseText,a))};try{a.open("GET",e+"?"+u,!0)}catch(c){return i(c)}a.send()}s=setInterval(function(){Date.now()-o>1e3*l&&(i("",{}),clearInterval(s))},1e3)});return{request:i,cancel:n}}Object.defineProperty(t,"__esModule",{value:!0}),t.post=n,t.plainget=r,t.plaingetCancelable=a},function(e,t,n){"use strict";function r(e,t,n){var r=intval(domData(n,"msgid"));if(!getSelectionText()&&!(0,c.checkSelectClick)(t)){var a=intval(domData(n,"peer"));return e.get().longpoll.push([(0,d.changePeer)(a,r)]),!1}}function a(e){return(0,u.isSearchAllLoaded)(e.get().peer,e.get())?Promise.resolve(""):(0,u.searchMessagesInplace)(e.get().peer,e.get())}function i(e,t){return{isAll:function(e){return(0,u.isSearchAllLoaded)(e.get().peer,e.get())},loadMore:function(e){return a(e)},unmount:function(){(0,l.destroyModule)(t)}}}function s(e){return e.findIndex(function(e){return"number"==typeof e.peerId&&e.href})>-1}function o(e,t){var n=r.bind(null,t),a=(0,l.createModule)({handlers:function(t,r){r(e,"click","_im_mess",n)}});return i(e,a)}Object.defineProperty(t,"__esModule",{value:!0}),t.doesSearchResultContainConversations=s,t.mount=o;var l=n(100),u=n(107),c=n(41),d=n(74)},function(e,t,n){var r=n(94),a=Math.max,i=Math.min;e.exports=function(e,t){return e=r(e),0>e?a(e+t,0):i(e,t)}},function(e,t){e.exports=function(e){try{return!!e()}catch(t){return!0}}},function(e,t,n){var r=n(19),a=n(9),i=n(129),s=n(71)("src"),o="toString",l=Function[o],u=(""+l).split(o);n(46).inspectSource=function(e){return l.call(e)},(e.exports=function(e,t,n,o){var l="function"==typeof n;l&&(i(n,"name")||a(n,"name",t)),e[t]!==n&&(l&&(i(n,s)||a(n,s,e[t]?""+e[t]:u.join(String(t)))),e===r?e[t]=n:o?e[t]?e[t]=n:a(e,t,n):(delete e[t],a(e,t,n)))})(Function.prototype,o,function(){return"function"==typeof this&&this[s]||l.call(this)})},function(e,t,n){"use strict";var r=n(20)(!0);n(35)(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,n=this._i;return n>=t.length?{value:void 0,done:!0}:(e=r(t,n),this._i+=e.length,{value:e,done:!1})})},function(e,t,n){var r=n(18),a=n(19).document,i=r(a)&&r(a.createElement);e.exports=function(e){return i?a.createElement(e):{}}},function(e,t,n){var r=n(18),a=n(82),i=function(e,t){if(a(e),!r(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,r){try{r=n(10)(Function.call,n(13).f(Object.prototype,"__proto__").set,2),r(e,[]),t=!(e instanceof Array)}catch(a){t=!0}return function(e,n){return i(e,n),t?e.__proto__=n:r(e,n),e}}({},!1):void 0),check:i}},function(e,t,n){"use strict";var r=n(19),a=n(69),i=n(124),s=n(66)("species");e.exports=function(e){var t=r[e];i&&t&&!t[s]&&a.f(t,s,{configurable:!0,get:function(){return this}})}},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function a(e,t){return e?void(window.tooltips&&tooltips.hide(e,t)):!1}function i(e){var t=e.filter(function(e){return"fwd"===e[0]});return e.filter(function(e){return"fwd"!==e[0]}).map(function(e){return{id:e[1],type:e[0],kind:e[2]}}).concat(t.map(function(e){return{type:e[0],messages:e[1],raw:e[1].join(",")}}))}function s(e,t,n,r,a,s){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:!0;r.get().tabs[t];return w(t,r)?Promise.resolve(!1):(0,N.getBindAttachToUrl)(t,cur.imDb,r.get()).then(function(l){var u=Object.keys(l).filter(function(e){return e===n.message}).map(function(e){return l[e]}).map(function(e){return n.attaches.filter(function(t){return t.id===e.id&&t.type===e.type}).length}).reduce(function(e,t){return e||t},!1);u&&(n.message="");var c=(0,G.random)(),d={peerId:t,messageId:"rid"+c,flags:B.FLAG_OUTBOUND,date:intval(Date.now()/1e3)-r.get().timeshift,subject:"",text:(0,H.replaceSpecialSymbols)(clean(n.message)).replace(/\n/gi,"<br>"),local:!0,kludges:{emoji:!0,from_admin:r.get().gid?vk.id:null},type:B.ADD_MESSAGE,attaches:i(n.attaches)};n.rid=c,n.mess=d,e(t,n),r.get().longpoll.push([d]),o&&s().clearText(t,r),a().newMessage(r)})}function o(e,t,n,r,a,i,o){var u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:!1;u||(u=e.get().peer);var c={message:"",attaches:i};o&&extend(c,o),l(e,t,!1).then(function(a){return s(n,u,c,e,t,r,!1)})["catch"](function(t){debugLog(t),d(e,a)})}function l(e,t,n){var r=e.get().tabs[e.get().peer];return r.skipped>0?(t().loadingPeer(e),e.setState({no_moving_down:!0}),e.set(N.changePeer.bind(null,e.get().peer,!1)).then(function(){return e.set(N.loadPeer.bind(null,e.get().peer,!0,-1,!1))}).then(function(){return t().changePeer(e,!1),e.setState({no_moving_down:!1}),n})):Promise.resolve(n)}function u(e,t,n){var r=!!intval(domData(n,"val"));r!==cur.ctrl_submit&&(cur.ctrl_submit=r,e.set(N.changeSubmitSettings.bind(null,r)))}function c(e,t,n){return e.get().delayed_ts?!1:setTimeout(function(){e.set(N.setDelayedMessage.bind(null,!1,!1)).then(function(){g.apply(void 0,n)})},t)}function d(e,t){document.activeElement&&document.activeElement.blur(),showFastBox({title:getLang("global_error")},getLang("mail_send_error"),getLang("mail_ok"),function(){nav.reload({force:!0})});var n=geByClass1("_im_send",t);return e.set(N.toggleSendingAbility.bind(null,!0)).then(function(){(0,H.lockButton)(n)})}function g(e,t,n,r,a,i){var o=arguments,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];return Promise.resolve().then(function(){var i=geByClass1("_im_send",r);if(!(0,j.isSendingAvailable)(e))return!1;if((0,N.isAnythingLoading)(e.get())||!(0,H.isFullyLoadedTab)(e,e.get().peer)){var d=c(e,ae,(0,q.toArray)(o));return e.set(N.setDelayedMessage.bind(null,!0,d)).then(function(){(0,H.lockButton)(i)})}clearTimeout(e.get().delayed_ts);var g=e.set(N.setDelayedMessage.bind(null,!1,!1)).then(function(){(0,H.unlockButton)(i)}),m=e.get(),f=m.peer,_=geByClass1("_im_text",r);return Promise.all([(0,N.getAttaches)(e,f),(0,N.getForwardedMessages)(f,cur.imDb,e.get()),g]).then(l.bind(null,e,t)).then(function(r){var i=x(r,2),o=i[0],l=i[1];o=o.concat(u);var c=Emoji.editableVal(_)||"";if(trim(c)||0!==o.length||0!==l.length){l.length>0&&o.push(["fwd",l]);var d=(0,H.splitMessageToParts)(c,o),g=d.map(function(r){return s(n,f,{message:r.msgText||"",attaches:r.attaches||[]},e,t,a)});return Promise.all(g)}})})["catch"](function(t){debugLog(t),d(e,r)})}function m(e,t,n){return e.set(N.deliverMessage.bind(null,t,n))}function f(e,t,n,r){e.get().longpoll.push([B.failedMessage(t,n.mess,r)])}function _(e,t,n,r,a,i){var s=geByClass1("_im_text",e);Wall.initComposer(s,{lang:{introText:getLang("profile_mention_start_typing"),noResult:getLang("profile_mention_not_found")},toup:!0,getValue:function(){return t.get().peer>2e9?(window.Emoji&&Emoji.editableVal||val)(s):""},onShow:function(){addClass(e,"im_mention_shown");var t=data(s,"composer");if(t&&t.wdd&&t.wdd.shown){var n=0,r=!1,a=function(){t.ignoredTerm=t.curTerm,t.curTerm=!1,val(t.wddInput,""),Composer.toggleSelectList(t)};each(t.wdd.shown,function(){this[0]&&(n++,"@"+t.curTerm==this[2]&&(r=!0))}),!n||r&&1==n?a():cancelStackPush("im_mention",a)}},onHide:function(){removeClass(e,"im_mention_shown"),cancelStackFilter("im_mention")},searchKeys:[1,7],wddOpts:{}});var o=Emoji.init(s,{ttDiff:93,rPointer:!0,onSend:r.bind(null,[]),controlsCont:e,forceTxt:!t.get().editable,checkEditable:n,onStickerSend:function(e,t){a([["sticker",e]],{sticker_referrer:t})},uploadActions:i});return Emoji.emojiLoadMore(o),o}function p(e,t,n,r,a,i,s,o,l){if("album"===a)return!1;if(show(ue),!t.get().rebuilding_draft){if("page"===a)return!1;if(!("share"!==a||s.title&&o))return!1;t.set(N.cleanMediaStore.bind(null,t.get().peer,cur.imDb));var u=l.getMedias().slice().map(function(e){return e.slice(0,2)}),c=[];if("undefined"!=typeof i&&a)if(o&&t.set(N.bindAttachToUrl.bind(null,t.get().peer,a,i,o,cur.imDb)),"share"===a){var d=u.filter(function(e){return"share"===e[0]}).length;0===d&&(c=[[a,i,s]])}else c=[[a,i,s]];else a||"undefined"==typeof i||u.splice(i,1);u=u.concat(c),u.filter(function(e){return e}).forEach(function(e){t.set(N.addMediaStore.bind(null,e,cur.imDb))});var g=e().updateScroll();return e().scrollFix(t,t.get().peer,g),toggleClass(r,"im-chat-input--textarea_has-attaches",u.length>0),t.get().delayed_message&&!(0,N.isAnythingLoading)(t.get())?(n([]),!1):void A(t,r)}}function h(e,t,n){L(e,t).then(function(t){var r=intval(domData(n.target,"tttype"));if((2===r&&t!==!0||1===r&&t===!0)&&window.tooltips&&tooltips.destroy(n.target,{fasthide:!0}),t!==!0)return domData(n.target,"tttype",1),showTooltip(n.target,{text:getLang("mail_added_audiomsg"),black:!0,force:1!==r,appendParentCls:"_im_chat_input_parent",shift:[-8,-10]});domData(n.target,"tttype",2);var a=e.get().ctrl_submit?1:0;return showTooltip(n.target,{text:getTemplate("ctrl_submit_hint",{enter_on:a?"":"on",ctrl_on:a?"on":""}),dir:"down",shift:[-28,-5],needLeft:!0,className:"im-chat-input--tt",hasover:!0,force:2!==r,showdt:700,zIndex:200,hidedt:700,appendParentCls:"_im_chat_input_parent",onCreate:function(){radioBtns.im_submit={els:(0,q.toArray)(geByClass(le)),val:a}}})})}function v(e,t){Emoji.val(e,t),Emoji.focus(e,!0),setTimeout(Emoji.correctCaret.pbind(e),10)}function b(e,t,n){var r=geByClass1(se,t);if(1===e.length){var a=x(e[0],5),i=(a[0],a[1]),s=a[2],o=a[3],l=a[4],u=(0,H.renderShortText)(0,"",i,!0,l);r.innerHTML=getTemplate("im_attach_mess",{messages:u,text:o,date:getSmDate(s,n.get().timeshift),modifier:"im-fwd_msg"})}else r.innerHTML=getTemplate("im_attach_mess",{messages:getLang("mail_title_X_msgs",e.length),text:getLang("mail_im_fwd_msgs_title"),date:"",modifier:""})}function y(e,t,n){e.set(N.forwardMessages.bind(null,[],e.get().peer,cur.imDb)).then(function(){var r=geByClass1(se,t);if(r&&r.children.length){r.innerHTML="";var a=n().updateScroll();n().scrollFix(e,e.get().peer,a)}A(e,t)})}function C(e,t,n,r,a,i,s,o,l,u){return{restoreDraft:function(r){r.get().rebuilding_draft=!0,e.unchooseMedia(),e.chosenMedias=[],r.get().rebuilding_draft=!1;var i=r.get().peer,s=geByClass1("ms_item_gift",n),o=geByClass1("ms_item_money",n);(0,H.isUserPeer)(i)&&i!=vk.id&&!r.get().gid?show(s):hide(s),(0,H.isUserPeer)(i)&&i!=vk.id&&!r.get().gid&&!inArray(i,r.get().moneyTransferExcept)||(0,H.isCommunityPeer)(i)&&r.get().moneyTransferCommAvail&&!r.get().gid||r.get().moneyRequestAvail&&r.get().gid?show(o):hide(o),(0,H.isReservedPeer)(i)||Promise.all([(0,N.getAttaches)(r,i),(0,N.getTextDraft)(i,cur.imDb,r.get()),(0,N.getForwardedMessages)(i,cur.imDb,r.get(),!0)]).then(function(e){return r.set(N.cleanMediaStore.bind(null,i,cur.imDb)).then(function(t){return e})}).then(function(s){var o=x(s,3),l=o[0],u=o[1],c=o[2],d=M(r,i,t);if(!d){l.length>0&&show(ge(ue));for(var g=0;g<l.length;g++)e.chooseMedia.apply(e,l[g]);c.length>0?b(c,n,r):geByClass1(se,n).innerHTML="",v(t,u);var m=a().updateScroll();a().scrollFix(r,i,m),A(r,n,u)}})},sendMessage:function(){r()},choose:function(t,n,r){e.chooseMedia(t,n,r)},isEmpty:function(e){return!trim(Emoji.val(t))},unchoose:function(t){e.unchooseMedia(t)},attachCount:function(){return e.attachCount()},progress:function(t,n,r){show(ue),e.showMediaProgress(t,n,r)},updateState:function(e){M(e,e.get().peer,t)},focusOn:function(e){Emoji.editableFocus(t,!1,!0)},clearText:function(r,i){e.unchooseMedia(),e.chosenMedias=[],Emoji.val(t,""),i.set(N.saveTextDraft.bind(null,r,"",cur.imDb)),i.set(N.cleanMediaStore.bind(null,r,cur.imDb)),i.set(N.forwardMessages.bind(null,[],r,cur.imDb)),i.set(N.clearAttachToUrl.bind(null,r,cur.imDb)),y(i,n,a);var s=a().updateScroll();a().scrollFix(i,i.get().peer,s)},attachMessages:function(e,t){e.get().peer===t&&(0,N.getForwardedMessages)(t,cur.imDb,e.get(),!0).then(function(r){if(r.length>0){b(r,n,e);var i=a().updateScroll();a().scrollFix(e,t,i),A(e,n)}})},cancelRecording:function(){u.cancelRecording()},unmount:function(){(0,z.destroyModule)(l),e.destroy(),s.unmount(),Emoji.destroy(o),u.unmount()}}}function E(e,t){return(0,H.isChatPeer)(e)?t.get().tabs[e].data.kicked:!1}function w(e,t){return E(e,t)||(0,j.getTab)(t,e)&&(0,j.getTab)(t,e).block_error>0||(0,H.isLocksAvailable)(t)&&(0,H.isPeerBlocked)(e,t)}function S(e,t,n,r){var a=e.get().peer,i=Emoji.val(r);(0,H.isReservedPeer)(a)||e.get().tabs[a].imdraft==i||w(a,e)||(t.checkMessageURLs(i,!0,ae),e.set(N.saveTextDraft.bind(null,a,i,cur.imDb)))}function T(e,t,n,r,a,i){Emoji.editableFocus(n,!1,!0);var s=domData(i,"emoji");Emoji.addEmoji(e,s),S(t,r,e,n)}function k(e){var t=e.get().peer;if((0,H.isFullyLoadedTab)(e.get(),t)){var n=e.get().tabs[t];Date.now()-(n.lastTyping||0)>1e3*N.TYPING_PERIOD&&e.set(N.sendTyping.bind(null,t))}}function I(e){var t=e.get().peer;(0,N.getForwardedMessages)(t,cur.imDb,e.get()).then(function(t){showBox("al_im.php",{act:"a_show_forward_box",will_fwd:t.join(";"),gid:e.get().gid},{dark:1})})}function P(e,t,n){switch(n.block_error){case Q:case K:return getLang("mail_peer_deleted");case ee:return getLang("mail_community_deleted");case J:return getLang("mail_group_banned_messages");case W:case Y:case X:case ne:case re:case Z:return(0,H.isCommunityPeer)(t)?getLang("mail_send_privacy_community_error"):getLang("mail_send_privacy_error");case $:return getLang("mail_cant_send_messages_to_community");case te:return getLang("mail_chat_youre_kicked");case 0:if(E(t,e))return getLang("mail_chat_youre_kicked");var r=e.get().block_states[t].name;return getLang("mail_community_answering").replace("{username}",r);default:return getLang("mail_send_privacy_error")}}function M(e,t,n){var r=gpeByClass("_im_chat_input_parent",n),a=geByClass1("_im_chat_input_error",r);if(w(t,e)){n.disabled=!0;var i=P(e,t,(0,j.getTab)(e,t));return addClass(n,"im-chat-input--text_disabled"),addClass(r,"im-chat-input_error"),n.contentEditable="false",val(a,i),!0}return n.disabled&&(n.disabled=!1,removeClass(r,"im-chat-input_error"),n.contentEditable="true",removeClass(n,"im-chat-input--text_disabled"),val(a,"")),!1}function L(e,t,n){return(0,H.isVoiceMessageAvailable)(e).then(function(r){if(!r)return!0;if(trim(n))return!0;var a=geByClass1("_im_text",t),i=Emoji.val(a);return trim(i)?!0:Promise.all([(0,N.getAttaches)(e,e.get().peer),(0,N.getForwardedMessages)(e.get().peer,cur.imDb,e.get())]).then(function(e){var t=x(e,2),n=t[0],r=t[1];return n.length>0||r.length>0})})}function A(e,t,n){var r=geByClass1("_im_send",t.parentNode);a(r,{fasthide:!0}),L(e,t,n).then(function(e){toggleClass(r,"im-send-btn_audio",!e),toggleClass(r,"im-send-btn_send",e),e&&removeClass(r,"im-send-btn_saudio");var t=e?getLang("mail_send2"):getLang("mail_added_audiomsg");attr(r,"aria-label",t)})}function D(e){var t=ge(ue),n=t.offsetHeight;toggleClass(e,"im-chat-input--overflowed",n>400)}function O(e,t,n){cur.share_timehash=t.get().share_timehash;var r=(0,z.createMutations)(C),i=r.callMutations,s=r.bindMutations,l=(0,V.mount)(e,t,i),c=m.bind(null,t);ls.remove("im_send_queue_2"+vk.id),ls.remove("im_send_queue_1"+vk.id);var d=(0,U.initQueue)(c,f.bind(null,t),{store:"ls",key:"im_send_queue_"+vk.id,waitCommit:!0}),v=d.pushMessage,b=d.inspectQueue,E=d.resend,P=d.setErrored,M=d.complete,O=o.bind(null,t,n,v,i,e),x=I.bind(null,t);hide(geByClass1("ms_items_more_helper",e));var R=[["video",getLang("profile_wall_video")],["audio",getLang("profile_wall_audio")],["doc",getLang("profile_wall_doc")],["map",getLang("profile_wall_map")],["gift",getLang("profile_wall_gift")]];(t.get().moneyTransferAvail||t.get().moneyRequestAvail)&&R.push(["money",getLang("profile_wall_money")]),R.unshift(["photo",getLang("mail_added_photo")]);var j,G=new MediaSelector(geByClass1(ie,e),ue,R,{maxShown:0,vectorIcon:!0,onAddMediaChange:function(r,a,i,s){return p(n,t,q,e,r,a,i,s,G)},editable:1,onChangedSize:function(){var r=n().updateScroll();n().scrollFix(t,t.get().peer,r),D(e)},sortable:1,teWidth:150,mail:1,teHeight:100,forceToUp:!0,toId:t.get().gid?-t.get().gid:void 0,blockPersonal:t.get().gid?1:0,docParams:t.get().gid?{imhash:t.get().im_doc_hash,from:"from_gim"}:{}}),q=g.bind(null,t,n,v,e,i,G),W=debounce(S.bind(null,t,G),500),K=o.bind(null,t,n,v,i,e),Y=(0,F.mount)(e,t,K,function(){addClass($,"im-send-btn_audio"),removeClass($,"im-send-btn_static")}),Q=_(e,t,function(r,a){var i=t.get().peer,s=Emoji.val(a);(0,H.isReservedPeer)(i)||w(i,t)||t.get().tabs[i].imdraft==s||!s||k(t),A(t,e,s),W(r,a);var o=e.offsetHeight;if(j&&j!==o){var l=n().updateScroll();n().scrollFix(t,t.get().peer,l)}j=o},q,O,l),X=q.bind(null,[]),J=h.bind(null,t,e),$=geByClass1("_im_send",e);t.get().textMediaSelector=G,t.set(N.initTextStore.bind(null,b,E,P,M));var Z=(ge(ue),geByClass1("_im_text",e));setTimeout(function(){i().restoreDraft(t)},0);var ee=T.bind(null,Q,t,Z,G),te=y.bind(null,t,e,n),ne=u.bind(null,t),re=(0,z.createModule)({handlers:function(n,r){n($,"click",function(){L(t,e).then(function(e){e?q([]):(a($,{fasthide:!0}),Y.start(),setTimeout(function(){return removeClass($,"im-send-btn_saudio")},300))})}),n($,"mouseover",J),n(Z,"focus",function(){t.get().longpoll.push([B.transitionEvent("message")]),cur.focused=t.get().peer}),n(Z,"blur",function(){var e=0===t.get().peer?"search":"default";t.get().longpoll.push([B.transitionEvent(e)]),cur.focused=!1}),r(e,"click","_im_rc_emoji",ee),r(e,"click",oe,te),r(e,"click","_im_will_fwd",x),r(bodyNode,"click",le,ne)}});return s(G,Z,e,X,n,b,l,Q,re,Y)}Object.defineProperty(t,"__esModule",{value:!0});var x=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(l){a=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.mount=O;var R=n(74),B=r(R),F=n(125),N=n(107),H=n(41),j=n(86),U=n(1),G=n(7),q=n(123),z=n(100),V=n(73),W=4,K=5,Y=6,Q=7,X=9,J=11,$=12,Z=13,ee=14,te=16,ne=19,re=20,ae=2e3,ie="_im_media_selector",se="_im_media_fwd",oe="_im_fwd_close",le="_im_submit_btn",ue="_im_media_preview"},function(e,t,n){"use strict";function r(e,t){if((0,h.unpackStore)(e).searchShown)return!1;var n=(0,h.getTab)(e,t),r=n&&n.pinned;return r?n.pinHideId!=(0,h.parserMessage)(r).chatLocalId:!1}function a(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!0,a=(0,h.getTab)(e,t),i=a&&(0,h.parserMessage)(a.pinned);a&&i&&(a.pinHideId=i.chatLocalId,cur.imDb.update(b.PIN_HIDDEN_ID_OP,[a.peerId,a.pinHideId]),l(n,t,e),re(geByClass1("_im_pinned_tt")),r&&window.Notifier&&Notifier.lcSend("pin_hide",{hide:1,peer:t}))}function i(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!0,a=(0,h.getTab)(e,t);a&&(delete a.pinHideId,cur.imDb.update(b.PIN_HIDDEN_ID_OP,[a.peerId,void 0]),l(n,t,e),r&&window.Notifier&&Notifier.lcSend("pin_hide",{hide:0,peer:t}))}function s(e,t,n){var r=l.bind(null,n,t),a=(0,p.showUnpinDialog)(function(){a.hideProgress(),a.hide(),e.set(m.unpinMessageOptimistic.bind(null,t)).then(r).then(function(e){return e.set(m.unpinMessage.bind(null,t))}).then(r)})}function o(e,t,n){var r=e.get(),i=r.peer,s=(0,h.parserMessage)((0,h.getTab)(e,i).pinned);if(n.target.classList.contains(y))s&&a(e,i,t);else if("A"!==n.target.tagName){var o=s&&s.messageId;if(o&&!(0,p.isAlreadyDeleted)(e,i,o)){var l=e.get(),u=(0,h.getMessage)(e,i,o);u?(e.setState({msgid:o}),(0,v.updateLocation)({msgid:o}),t().focusOnMessage()):l.longpoll.push([(0,f.changePeer)(i,o)])}else(0,p.showPinnedBox)(e,t,i,_.mount,n)}}function l(e,t,n){return e().updateChatTopic(t,n),(0,m.setActions)(n.get()),e().updateActions(n),n}function u(e){showTooltip(e.target,{text:getLang("mail_hide_unpin_hover"),black:1,needLeft:1,shift:[8,4],forcetoup:!0,className:"_im_pinned_tt",appendEl:bodyNode})}function c(e){return{unmount:function(){(0,g.destroyModule)(e)}}}function d(e,t,n){var r=(0,g.createMutations)(c),a=(r.callMutations,r.bindMutations),i=o.bind(null,t,n),s=u.bind(null),l=(0,g.createModule)({handlers:function(t,n){n(e,"click",C,i),n(e,"mouseover",y,s)}});return a(l)}Object.defineProperty(t,"__esModule",{value:!0}),t.isPinnedMessageVisibleInTab=r,t.pinnedMessageHide=a,t.pinnedMessageUnHide=i,t.pinnedMessageUnpin=s,t.mount=d;var g=n(100),m=n(107),f=n(74),_=n(62),p=n(41),h=n(86),v=n(21),b=n(26),y="_im_pin_hide",C="_im_pinned_message"},function(e,t,n){var r=n(69).f,a=n(129),i=n(66)("toStringTag");e.exports=function(e,t,n){e&&!a(e=n?e:e.prototype,i)&&r(e,i,{configurable:!0,value:t})}},function(e,t,n){"use strict";var r=n(54);e.exports=n(96)("Map",function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},{get:function(e){var t=r.getEntry(this,e);return t&&t.v},set:function(e,t){return r.def(this,0===e?0:e,t)}},r,!0)},function(e,t,n){var r=n(63),a=n(66)("iterator"),i=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||i[a]===e)}},function(e,t){"use strict";function n(e,t){var n=[],r=0;return function(a){n.push(a),r||(r=setTimeout(function(){r=!1,e(n),n=[]},t))}}function r(e){return e.length>0&&e.pop().func(),e}function a(e,t){var n,r;if(window.__debugMode){switch(t){case"error":n="color: red",r="background: red; color: white";break;case"success":n="color: green",r="background: green; color: white";break;default:n="color: blue;",r="background: #000; color: #fff;"}try{var a=new Date;console.debug("%cLP:["+a.getHours()+":"+a.getMinutes()+":"+a.getSeconds()+":"+a.getMilliseconds()+"]%c "+e,r,n)}catch(i){}}}function i(e){var t=[];if("undefined"==typeof e.length)return Object.keys(e).map(function(t){return e[t]});for(var n=0;n<e.length;n++)t.push(e[n]);return t}function s(e){for(var t={},n=[],r=0;r<e.length;r++)t[e[r]]||(n.push(e[r]),t[n[r]]=1);return n}Object.defineProperty(t,"__esModule",{value:!0}),t.throttleAccumulate=n,t.executionStackPop=r,t.lplog=a,t.toArray=i,t.arrayUnique=s},function(e,t,n){e.exports=!n(112)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t,n){"use strict";function r(e){var t=parseInt(e/60),n=e%60;return t+":"+(10>n?"0":"")+n}function a(e){var t=e.match(/.*\/(\w*).*/);switch(t[1]){case"mpeg":return"mp3";case"ogg":case"webm":case"wav":return t[1]}return""}function i(e){return new Promise(function(t,n){for(var r=new FormData,i=[],s=0;s<e.wave.length;s++)i.push(parseInt(31*e.wave[s]));r.append("waveform",JSON.stringify(i)),r.append("file",e.buffer,"voice_message."+a(e.mimeType));var o=new K;o.onload=o.onerror=function(e){var r=e.currentTarget.response;200==this.status&&r.length>0&&"{"==r[0]?(r=JSON.parse(r),t(r)):n()},o.open("POST",U.upload_url,!0),o.send(r)})}function s(e){if(!Q){Q=!0,(0,V.lockButton)(O);var t={peer:F.get().peer,from_place:cur.docsChooseFrom,imhash:cur.docsChooseImHash,blockPersonal:cur.docsChooseBlockPersonal,mail_add:cur.docsChooseMailAdd};i(e).then(function(e){return e.file?new Promise(function(n,r){ajax.post("/docs.php",extend({act:"a_save_doc",from:"choose",from_place:t.from_place,imhash:t.imhash,blockPersonal:t.blockPersonal,mail_add:t.mail_add},e),{onDone:function(e,r){m(),j([["doc",e+"_"+r,"audiomsg"]],{},t.peer),C(),n()},onFail:function(e){r(e)},progress:null})}):Promise.reject()}).then(function(){(0,V.unlockButton)(O),Q=!1})["catch"](function(){Q=!1,(0,V.unlockButton)(O),showFastBox(getLang("global_error"),getLang("mail_audio_message_upload_error"))})}}function o(e){var t=URL.createObjectURL(Y.buffer);domData(N,"duration",Y.duration),domData(N,"ogg",t),domData(N,"mp3",t),geByClass1("audio-msg-track--duration",N).innerHTML=r(Y.duration),geByClass1("audio-msg-track--wave-wrapper",N).innerHTML=AudioMessagePlayer.getWave(Y.wave,X)}function l(){M.innerHTML=r(Y.duration),Y.duration>=W&&v()}function u(e){e.set(q.cancelRecording).then(p)}function c(){stManager.add(["voice_message_player.js","speech.js"],function(){Y||(Y=Speech.newRecorder(),addEvent(Y,"progress",l)),AudioMessagePlayer.detachPlayer(),AudioMessagePlayer.pauseGlobalMedia(),Y.record().then(function(){g(F),b(),y(),H=Speech.createVisualization("wave",Y.source,L),H.start();var e=L.getBoundingClientRect();X=(e.right-e.left)/3})["catch"](function(e){AudioMessagePlayer.resumeGlobalMedia();var t=e.name;switch(e.name){case"DevicesNotFoundError":case"NotFoundError":t="mail_audio_message_device_error";break;case"PermissionDeniedError":case"PermissionDismissedError":t="mail_audio_message_permission_error";break;case"Unsupported":t="mail_audio_message_unsupported_error"}showFastBox(getLang("global_error"),getLang(t)),console.error(e)})})}function d(){Y&&Y.stop(),H&&(H.destroy(),H=null)}function g(e){U.isRecording=!0,cancelStackPush("audio_message_cancel",u.bind(null,e))}function m(){U.isRecording=!1,cancelStackFilter("audio_message_cancel")}function f(){_(),s(Y)}function _(){AudioMessagePlayer.loaded&&AudioMessagePlayer.resumeGlobalMedia(),removeEvent(Y,"finish",_),removeEvent(Y,"finish",f),o(),removeClass(P,"im-audio-message_recording"),addClass(P,"im-audio-message_recorded")}function p(){m(),AudioMessagePlayer.loaded&&(AudioMessagePlayer.resumeGlobalMedia(),AudioMessagePlayer.detachPlayer()),removeEvent(Y,"finish",_),removeEvent(Y,"finish",f),d(),C()}function h(){Y.isRecording?(addEvent(Y,"finish",f),removeEvent(Y,"finish",_),d()):s(Y)}function v(){addEvent(Y,"finish",_),removeEvent(Y,"finish",f),d()}function b(){hideProgress(geByClass1("im-audio-message-send-wrapper",P)),show(O),M.innerHTML="0:00",addClass(P,"im-audio-message_recording"),removeClass(P,"im-audio-message_recorded")}function y(){show(P),hide(geByClass1("_im_chat_input_parent"))}function C(){removeClass(P,"im-audio-message_recorded"),removeClass(P,"im-audio-message_recording"),hide(P),show(geByClass1("_im_chat_input_parent"))}function E(){R=ge("audiomsg_record"),N=ge("audiomsg_player"),P=geByClass1("im-audio-message-input"),M=geByClass1("audio-msg-track--duration",P),L=geByClass1("audio-msg-track--wave",P),D=geByClass1("im-audio-message--cancel-btn",P),O=geByClass1("_im_audio_send",P),x=geByClass1("audio-msg-track--btn",P),B=geByClass1("im-chat-input--text",geByClass1("im-page--chat-input"));var e=geByClass1("im-chat-input--textarea",geByClass1("im-page--chat-input"));addClass(e,"_voice_field_wrap"),S()}function w(){T(),R=N=P=M=L=A=D=O=x=null}function S(){addEvent(A,"click",c),addEvent(D,"click",p),addEvent(O,"click",h),addEvent(x,"click",v)}function T(){Y&&removeEvent(Y,"progress",l),removeEvent(A,"click",c),removeEvent(D,"click",p),removeEvent(O,"click",h),removeEvent(x,"click",v)}function k(e,t,n){return{cancelRecording:p,start:function(){c()},unmount:function(){p(),w()}}}function I(e,t,n,r){F=t,U=t.get().audio_msg,j=n,(0,z.initFailBack)(),(0,V.getAvailableMicrophones)().then(function(e){var n=e.length>0;n?(E(),r()):setCookie("remixvoice","0",7),t.set(q.setVoiceMessageAvail.bind(null,n))})["catch"](function(e){throw setCookie("remixvoice","0",7),e});var a=(0,G.createMutations)(k),i=(a.callMutations,a.bindMutations);return i(e,t,n)}Object.defineProperty(t,"__esModule",{value:!0}),t.mount=I;var P,M,L,A,D,O,x,R,B,F,N,H,j,U,G=n(100),q=n(107),z=n(16),V=n(41),W=300,K=browser.msie&&intval(browser.version)<10?window.XDomainRequest:window.XMLHttpRequest,Y=!1,Q=!1,X=100},function(e,t,n){var r=n(18);e.exports=function(e,t){if(!r(e))return e;var n,a;if(t&&"function"==typeof(n=e.toString)&&!r(a=n.call(e)))return a;if("function"==typeof(n=e.valueOf)&&!r(a=n.call(e)))return a;if(!t&&"function"==typeof(n=e.toString)&&!r(a=n.call(e)))return a;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var r=n(103),a=n(66)("iterator"),i=n(63);e.exports=n(46).getIteratorMethod=function(e){return void 0!=e?e[a]||e["@@iterator"]||i[r(e)]:void 0}},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}}]);